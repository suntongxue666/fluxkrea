# 调试指南：管理员测试模式 vs 正式API模式

## 当前配置状态

### 1. 用户权限配置
- **管理员邮箱**: `sunwei7482@gmail.com`
- **管理员模式**: 使用模拟生成（测试模式）
- **其他用户**: 使用真实API生成（正式模式）

### 2. 代码逻辑
```javascript
// 在 generateImage() 函数中
if (currentUser && currentUser.email === 'sunwei7482@gmail.com') {
    // 管理员 - 使用模拟生成
    console.log('🧪 管理员用户 - 使用模拟生成模式');
    const simulationResult = await simulateImageGeneration(prompt, imageSize, steps);
} else {
    // 所有其他用户 - 使用真实API
    console.log('🚀 所有其他用户(含未登录) - 强制使用真实API生成');
    const apiResult = await callImageGenerationAPI(prompt, imageSize, steps);
}
```

## 调试步骤

### 步骤1: 检查用户状态
1. 打开网站
2. 点击右上角的 "👤 用户状态" 按钮
3. 查看弹出的用户信息，确认：
   - 用户邮箱是否正确
   - 是否管理员状态
   - 生成模式是否正确

### 步骤2: 检查控制台日志
1. 按F12打开开发者工具
2. 切换到Console标签
3. 点击Generate按钮
4. 查看控制台输出，应该看到：
   - `🔍 用户状态调试信息`
   - `🧪 管理员用户 - 使用模拟生成模式` (管理员)
   - `🚀 所有其他用户(含未登录) - 强制使用真实API生成` (非管理员)

### 步骤3: 测试API连接
1. 如果非管理员用户看到API错误，点击 "快速API测试" 按钮
2. 或者访问 `/test_api.html` 页面进行详细测试

### 步骤4: 检查环境变量（如果API失败）
```bash
node check_env.js
```

## 可能的问题和解决方案

### 问题1: 非管理员用户仍然看到测试模式
**原因**: 用户认证状态可能有问题
**解决**: 
1. 检查用户状态按钮显示的信息
2. 如果是管理员但想测试非管理员模式，可以退出登录

### 问题2: API调用失败
**原因**: 
- Replicate API token未配置
- 网络连接问题
- Vercel部署问题

**解决**:
1. 检查 `.env` 文件中的 `REPLICATE_API_TOKEN`
2. 在Vercel控制台中确认环境变量已设置
3. 使用测试页面验证API连接

### 问题3: 所有用户都看到模拟模式
**原因**: API调用失败后没有显示错误，而是降级到模拟模式
**解决**: 现在已修复，API失败会显示详细错误信息而不是降级

## 新增的调试功能

1. **用户状态按钮**: 显示当前用户的详细状态
2. **详细错误信息**: API失败时显示具体错误和调试信息
3. **快速API测试**: 直接在页面上测试API连接
4. **管理员调试菜单**: 管理员专用的调试工具

## 验证步骤

1. **管理员测试**:
   - 使用 `sunwei7482@gmail.com` 登录
   - 点击Generate，应该看到 "🧪 管理员测试模式 - 模拟生成"
   - 生成的图片应该是彩色渐变背景

2. **非管理员测试**:
   - 使用其他邮箱登录或不登录
   - 点击Generate，应该看到 "🚀 正式API模式 - 真实生成中"
   - 如果API正常，应该生成真实的AI图片
   - 如果API失败，应该看到详细的错误信息

## 联系支持

如果问题仍然存在，请提供：
1. 用户状态按钮显示的信息
2. 控制台日志截图
3. 错误信息截图