<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´åŒæ­¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .credits-display {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            text-align: center;
        }
        .user-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ å®Œæ•´åŒæ­¥ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="status info" id="systemStatus">
            <span>ğŸ”„ æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</span>
        </div>
        
        <div class="test-grid">
            <div class="test-section">
                <h3>ğŸ‘¤ ç”¨æˆ·çŠ¶æ€</h3>
                <div class="user-info" id="userInfo">
                    <div>ç”¨æˆ·: <span id="userEmail">æœªçŸ¥</span></div>
                    <div>UUID: <span id="userUuid">æœªçŸ¥</span></div>
                    <div>çŠ¶æ€: <span id="userStatus">æœªçŸ¥</span></div>
                </div>
                <button class="btn btn-primary" onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•</button>
                <button class="btn btn-success" onclick="checkUserState()">æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</button>
            </div>
            
            <div class="test-section">
                <h3>ğŸ’° ç§¯åˆ†çŠ¶æ€</h3>
                <div class="credits-display">
                    ç§¯åˆ†: <span id="creditsAmount">0</span>
                </div>
                <button class="btn btn-primary" onclick="syncCredits()">åŒæ­¥ç§¯åˆ†</button>
                <button class="btn btn-success" onclick="testCrossPageSync()">æµ‹è¯•è·¨é¡µé¢åŒæ­¥</button>
            </div>
        </div>
        
        <div class="container">
            <h3>ğŸ§ª æµ‹è¯•ç»“æœ</h3>
            <div class="log" id="testLog"></div>
        </div>
        
        <div class="container">
            <h3>ğŸ” å­˜å‚¨çŠ¶æ€</h3>
            <div class="log" id="storageStatus"></div>
        </div>
    </div>

    <!-- åŠ è½½æ‰€æœ‰åŒæ­¥ç³»ç»Ÿ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="credits_sync.js"></script>
    <script src="user_state_sync.js"></script>
    
    <script>
        let testLog = [];
        
        // Supabaseé…ç½®
        const supabaseClient = supabase.createClient(
            'https://gdcjvqaqgvcxzufmessy.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkY2p2cWFxZ3ZjeHp1Zm1lc3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMDY2NTEsImV4cCI6MjA2OTc4MjY1MX0.wIblNpUZLgQcCJCVbKfae5n0jtcIshL9asVIit6iUBI'
        );
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logElement = document.getElementById('testLog');
            logElement.innerHTML = testLog.slice(-20).join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function updateStorageStatus() {
            const storageElement = document.getElementById('storageStatus');
            const creditsData = localStorage.getItem('flux_krea_credits');
            const userData = localStorage.getItem('flux_krea_user');
            const lastSync = localStorage.getItem('flux_krea_last_sync');
            
            storageElement.innerHTML = `
LocalStorage ç§¯åˆ†æ•°æ®: ${creditsData || 'æ— '}
LocalStorage ç”¨æˆ·æ•°æ®: ${userData || 'æ— '}
æœ€ååŒæ­¥æ—¶é—´: ${lastSync ? new Date(parseInt(lastSync)).toLocaleString() : 'æ— '}
å½“å‰ç”¨æˆ·æ ‡è¯†: ${window.creditsSync ? window.creditsSync.getCurrentUserIdentifier() : 'æœªçŸ¥'}
            `.trim();
        }
        
        function updateUserInfo() {
            const user = window.userStateSync ? window.userStateSync.getCurrentUser() : null;
            
            document.getElementById('userEmail').textContent = user?.email || 'æœªçŸ¥';
            document.getElementById('userUuid').textContent = user?.uuid || 'æœªçŸ¥';
            document.getElementById('userStatus').textContent = user?.subscription_status || 'æœªçŸ¥';
        }
        
        function updateCreditsDisplay() {
            if (window.creditsSync) {
                const credits = window.creditsSync.getCredits();
                document.getElementById('creditsAmount').textContent = credits;
            }
            updateStorageStatus();
            updateUserInfo();
        }
        
        // æ¨¡æ‹Ÿç™»å½•æµ‹è¯•ç”¨æˆ·
        function simulateLogin() {
            const testUser = {
                email: 'sunwei7482@gmail.com',
                uuid: 'user_1754255481243_makadnmmc6p',
                credits: 6000,
                subscription_status: 'ACTIVE',
                avatar_url: 'https://via.placeholder.com/32'
            };
            
            log('ğŸ”„ æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•...');
            
            // è®¾ç½®å…¨å±€ç”¨æˆ·çŠ¶æ€
            window.currentUser = testUser;
            
            // ä½¿ç”¨ç”¨æˆ·çŠ¶æ€åŒæ­¥ç³»ç»Ÿ
            if (window.userStateSync) {
                window.userStateSync.setCurrentUser(testUser);
                log('âœ… ç”¨æˆ·çŠ¶æ€å·²è®¾ç½®');
            }
            
            // ä½¿ç”¨ç§¯åˆ†åŒæ­¥ç³»ç»Ÿ
            if (window.creditsSync) {
                window.creditsSync.setCredits(testUser.credits);
                log('âœ… ç§¯åˆ†å·²åŒæ­¥');
            }
            
            updateCreditsDisplay();
            log(`âœ… æ¨¡æ‹Ÿç™»å½•æˆåŠŸ: ${testUser.email}`);
        }
        
        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        function checkUserState() {
            log('ğŸ” æ£€æŸ¥ç”¨æˆ·çŠ¶æ€...');
            
            const user = window.userStateSync ? window.userStateSync.getCurrentUser() : null;
            const credits = window.creditsSync ? window.creditsSync.getCredits() : 0;
            
            if (user) {
                log(`ğŸ‘¤ ç”¨æˆ·: ${user.email}`);
                log(`ğŸ’° ç§¯åˆ†: ${credits}`);
                log(`ğŸ“Š çŠ¶æ€: ${user.subscription_status}`);
            } else {
                log('âŒ æœªæ‰¾åˆ°ç”¨æˆ·çŠ¶æ€');
            }
            
            updateCreditsDisplay();
        }
        
        // åŒæ­¥ç§¯åˆ†
        async function syncCredits() {
            if (!window.currentUser || !window.currentUser.uuid) {
                log('âŒ è¯·å…ˆç™»å½•');
                return;
            }
            
            log('ğŸ”„ ä»æ•°æ®åº“åŒæ­¥ç§¯åˆ†...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('credits, subscription_status')
                    .eq('uuid', window.currentUser.uuid)
                    .single();
                
                if (error) {
                    log(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`);
                    return;
                }
                
                if (data) {
                    const newCredits = data.credits || 0;
                    log(`ğŸ’° æ•°æ®åº“ç§¯åˆ†: ${newCredits}`);
                    
                    // æ›´æ–°ç§¯åˆ†
                    if (window.creditsSync) {
                        window.creditsSync.setCredits(newCredits);
                    }
                    
                    // æ›´æ–°ç”¨æˆ·çŠ¶æ€
                    if (window.currentUser) {
                        window.currentUser.credits = newCredits;
                        window.currentUser.subscription_status = data.subscription_status;
                        
                        if (window.userStateSync) {
                            window.userStateSync.setCurrentUser(window.currentUser);
                        }
                    }
                    
                    log(`âœ… ç§¯åˆ†åŒæ­¥æˆåŠŸ: ${newCredits}`);
                    updateCreditsDisplay();
                }
            } catch (error) {
                log(`âŒ åŒæ­¥å¼‚å¸¸: ${error.message}`);
            }
        }
        
        // æµ‹è¯•è·¨é¡µé¢åŒæ­¥
        function testCrossPageSync() {
            log('ğŸ§ª æµ‹è¯•è·¨é¡µé¢åŒæ­¥...');
            
            // æ¨¡æ‹Ÿé¡µé¢è·³è½¬åçš„çŠ¶æ€æ¢å¤
            const storedUser = localStorage.getItem('flux_krea_user');
            const storedCredits = localStorage.getItem('flux_krea_credits');
            
            if (storedUser) {
                const user = JSON.parse(storedUser);
                log(`âœ… ç”¨æˆ·çŠ¶æ€å·²ä¿å­˜: ${user.email}`);
            } else {
                log('âŒ ç”¨æˆ·çŠ¶æ€æœªä¿å­˜');
            }
            
            if (storedCredits) {
                const credits = JSON.parse(storedCredits);
                log(`âœ… ç§¯åˆ†çŠ¶æ€å·²ä¿å­˜: ${JSON.stringify(credits)}`);
            } else {
                log('âŒ ç§¯åˆ†çŠ¶æ€æœªä¿å­˜');
            }
            
            // è§¦å‘è·¨é¡µé¢åŒæ­¥äº‹ä»¶
            window.dispatchEvent(new CustomEvent('userStateUpdated', {
                detail: { user: window.currentUser, credits: window.currentUser?.credits }
            }));
            
            log('âœ… è·¨é¡µé¢åŒæ­¥äº‹ä»¶å·²è§¦å‘');
            updateCreditsDisplay();
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('systemStatus');
            
            // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            let systemsReady = 0;
            let totalSystems = 2;
            
            if (window.creditsSync) {
                systemsReady++;
                log('âœ… ç§¯åˆ†åŒæ­¥ç³»ç»Ÿå·²åŠ è½½');
            }
            
            if (window.userStateSync) {
                systemsReady++;
                log('âœ… ç”¨æˆ·çŠ¶æ€åŒæ­¥ç³»ç»Ÿå·²åŠ è½½');
                
                // æ·»åŠ ç”¨æˆ·çŠ¶æ€ç›‘å¬å™¨
                window.userStateSync.addListener((user) => {
                    log(`ğŸ”” ç”¨æˆ·çŠ¶æ€å˜åŒ–: ${user ? user.email : 'å·²ç™»å‡º'}`);
                    updateCreditsDisplay();
                });
            }
            
            if (systemsReady === totalSystems) {
                statusElement.className = 'status success';
                statusElement.innerHTML = '<span>âœ… æ‰€æœ‰ç³»ç»Ÿå·²æˆåŠŸåˆå§‹åŒ–</span>';
                log('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            } else {
                statusElement.className = 'status error';
                statusElement.innerHTML = '<span>âŒ ç³»ç»Ÿåˆå§‹åŒ–ä¸å®Œæ•´</span>';
                log(`âŒ åªæœ‰ ${systemsReady}/${totalSystems} ä¸ªç³»ç»ŸåŠ è½½æˆåŠŸ`);
            }
            
            updateCreditsDisplay();
        });
        
        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(updateStorageStatus, 3000);
    </script>
</body>
</html>