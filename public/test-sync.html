<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŠ¶æ€åŒæ­¥æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .status-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .user-info {
            background: #e0f2fe;
            border-left: 4px solid #0891b2;
            padding: 15px;
            margin: 10px 0;
        }
        
        .credits-info {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 10px 0;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #5b5bd6;
        }
        
        .btn.secondary {
            background: #64748b;
        }
        
        .btn.secondary:hover {
            background: #475569;
        }
        
        .log-area {
            background: #1a1a1a;
            color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .nav-links {
            margin: 20px 0;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 8px;
        }
        
        .nav-links a {
            color: #6366f1;
            text-decoration: none;
            margin-right: 15px;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Supabaseåˆå§‹åŒ– -->
    <script src="/js/supabase-init.js"></script>
    <!-- ç»Ÿä¸€çŠ¶æ€åŒæ­¥æ¨¡å— -->
    <script src="/js/modules/unified-state-sync.js"></script>

    <h1>ğŸ”„ è·¨é¡µé¢çŠ¶æ€åŒæ­¥æµ‹è¯•</h1>
    
    <div class="nav-links">
        <strong>å¯¼èˆªé“¾æ¥ï¼š</strong>
        <a href="/">é¦–é¡µ</a>
        <a href="/pricing.html">Pricingé¡µé¢</a>
        <a href="/test-sync.html">å½“å‰æµ‹è¯•é¡µ</a>
    </div>

    <div class="status-card">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
        
        <div class="user-info" id="userInfo">
            <strong>ç”¨æˆ·çŠ¶æ€ï¼š</strong>åŠ è½½ä¸­...
        </div>
        
        <div class="credits-info" id="creditsInfo">
            <strong>ç§¯åˆ†çŠ¶æ€ï¼š</strong>åŠ è½½ä¸­...
        </div>
    </div>

    <div class="status-card">
        <h2>ğŸ§ª æµ‹è¯•æ“ä½œ</h2>
        
        <button class="btn" onclick="simulateLogin()">ğŸ” æ¨¡æ‹Ÿç™»å½•</button>
        <button class="btn secondary" onclick="simulateLogout()">ğŸ”“ æ¨¡æ‹Ÿç™»å‡º</button>
        <button class="btn" onclick="simulateCreditsUpdate()">ğŸ’° æ¨¡æ‹Ÿç§¯åˆ†æ›´æ–°</button>
        <button class="btn" onclick="testDeductCredits()">â– æ‰£é™¤10ç§¯åˆ†</button>
        <button class="btn secondary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
        <button class="btn secondary" onclick="debugLocalStorage()">ğŸ” è°ƒè¯•å­˜å‚¨</button>
        
        <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 12px;">
            <strong>è¯´æ˜ï¼š</strong>è¿™äº›æ˜¯æ¨¡æ‹Ÿæ“ä½œï¼Œç”¨äºæµ‹è¯•è·¨é¡µé¢çŠ¶æ€åŒæ­¥åŠŸèƒ½ã€‚è¯·åœ¨å¤šä¸ªé¡µé¢é—´åˆ‡æ¢æŸ¥çœ‹åŒæ­¥æ•ˆæœã€‚
        </div>
    </div>

    <div class="status-card">
        <h2>ğŸ“‹ å®æ—¶æ—¥å¿—</h2>
        <div class="log-area" id="logArea"></div>
        <button class="btn secondary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div class="status-card">
        <h2>ğŸ¯ è·¨é¡µé¢åŒæ­¥æµ‹è¯•æŒ‡å—</h2>
        <ol style="line-height: 2; color: #374151;">
            <li><strong>æ‰“å¼€å¤šä¸ªé¡µé¢ï¼š</strong>
                <br>â€¢ åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ <a href="/" target="_blank">é¦–é¡µ</a>
                <br>â€¢ åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ <a href="/pricing.html" target="_blank">Pricingé¡µé¢</a>
                <br>â€¢ ä¿æŒå½“å‰æµ‹è¯•é¡µé¢æ‰“å¼€
            </li>
            <li><strong>æµ‹è¯•ç™»å½•åŒæ­¥ï¼š</strong>
                <br>â€¢ åœ¨æ­¤é¡µé¢ç‚¹å‡»"æ¨¡æ‹Ÿç™»å½•"
                <br>â€¢ åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢ï¼Œè§‚å¯Ÿå¯¼èˆªæ æ˜¯å¦æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                <br>â€¢ è§‚å¯Ÿç§¯åˆ†æ˜¯å¦åŒæ­¥æ˜¾ç¤º
            </li>
            <li><strong>æµ‹è¯•ç§¯åˆ†åŒæ­¥ï¼š</strong>
                <br>â€¢ åœ¨æ­¤é¡µé¢ç‚¹å‡»"æ¨¡æ‹Ÿç§¯åˆ†æ›´æ–°"æˆ–"æ‰£é™¤10ç§¯åˆ†"
                <br>â€¢ åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢ï¼Œè§‚å¯Ÿç§¯åˆ†æ•°å€¼æ˜¯å¦å®æ—¶æ›´æ–°
            </li>
            <li><strong>æµ‹è¯•ç™»å‡ºåŒæ­¥ï¼š</strong>
                <br>â€¢ åœ¨æ­¤é¡µé¢ç‚¹å‡»"æ¨¡æ‹Ÿç™»å‡º"
                <br>â€¢ åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢ï¼Œè§‚å¯Ÿå¯¼èˆªæ æ˜¯å¦æ¢å¤åˆ°æœªç™»å½•çŠ¶æ€
            </li>
        </ol>
        
        <div style="margin-top: 15px; padding: 10px; background: #e0f2fe; border-radius: 6px; font-size: 14px;">
            <strong>ğŸ’¡ é¢„æœŸæ•ˆæœï¼š</strong>åœ¨ä»»ä½•é¡µé¢è¿›è¡Œçš„æ“ä½œï¼Œåº”è¯¥ç«‹å³åœ¨å…¶ä»–æ‰€æœ‰æ‰“å¼€çš„é¡µé¢ä¸­åæ˜ å‡ºæ¥ï¼Œæ— éœ€åˆ·æ–°ã€‚
        </div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay() {
            if (!window.UnifiedStateSync) {
                log('âŒ UnifiedStateSyncæœªåŠ è½½');
                return;
            }

            const user = window.UnifiedStateSync.getCurrentUser();
            const credits = window.UnifiedStateSync.getCredits();

            const userInfo = document.getElementById('userInfo');
            const creditsInfo = document.getElementById('creditsInfo');

            if (user) {
                userInfo.innerHTML = `
                    <strong>ç”¨æˆ·çŠ¶æ€ï¼š</strong>âœ… å·²ç™»å½•<br>
                    <strong>é‚®ç®±ï¼š</strong>${user.email}<br>
                    <strong>å§“åï¼š</strong>${user.name || 'æœªè®¾ç½®'}<br>
                    <strong>UUIDï¼š</strong>${user.uuid}
                `;
            } else {
                userInfo.innerHTML = '<strong>ç”¨æˆ·çŠ¶æ€ï¼š</strong>âŒ æœªç™»å½•';
            }

            creditsInfo.innerHTML = `
                <strong>ç§¯åˆ†çŠ¶æ€ï¼š</strong>${credits} ç§¯åˆ†<br>
                <strong>æ›´æ–°æ—¶é—´ï¼š</strong>${new Date().toLocaleString()}
            `;

            log(`âœ… çŠ¶æ€å·²æ›´æ–° - ç”¨æˆ·: ${user?.email || 'æœªç™»å½•'}, ç§¯åˆ†: ${credits}`);
        }

        // æ¨¡æ‹Ÿç™»å½•
        async function simulateLogin() {
            try {
                log('ğŸ” å¼€å§‹æ¨¡æ‹Ÿç™»å½•...');
                
                if (!window.UnifiedStateSync) {
                    throw new Error('UnifiedStateSyncæœªåŠ è½½');
                }

                // åˆ›å»ºæ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
                const simulatedUser = {
                    uuid: 'test-user-' + Date.now(),
                    email: 'test@example.com',
                    name: 'æµ‹è¯•ç”¨æˆ·',
                    avatar_url: 'https://via.placeholder.com/32',
                    credits: 100,
                    access_token: 'simulated_token_' + Date.now(),
                    refresh_token: 'simulated_refresh_token',
                    is_signed_in: true
                };

                // ç›´æ¥è°ƒç”¨çŠ¶æ€ç®¡ç†å™¨çš„å†…éƒ¨æ–¹æ³•
                await window.UnifiedStateSync.setUser(simulatedUser, true);
                window.UnifiedStateSync.setCredits(simulatedUser.credits, true);
                
                log('âœ… æ¨¡æ‹Ÿç™»å½•æˆåŠŸ');
                log(`ğŸ‘¤ ç”¨æˆ·: ${simulatedUser.email}, ç§¯åˆ†: ${simulatedUser.credits}`);
                updateStatusDisplay();
                
            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        // æ¨¡æ‹Ÿç™»å‡º
        async function simulateLogout() {
            try {
                log('ğŸ”“ å¼€å§‹æ¨¡æ‹Ÿç™»å‡º...');
                
                if (!window.UnifiedStateSync) {
                    throw new Error('UnifiedStateSyncæœªåŠ è½½');
                }

                // æ¸…é™¤ç”¨æˆ·çŠ¶æ€
                await window.UnifiedStateSync.setUser(null, true);
                
                log('âœ… æ¨¡æ‹Ÿç™»å‡ºæˆåŠŸ');
                updateStatusDisplay();
                
            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿç™»å‡ºå¤±è´¥: ${error.message}`);
            }
        }

        // æ¨¡æ‹Ÿç§¯åˆ†æ›´æ–°
        async function simulateCreditsUpdate() {
            try {
                log('ğŸ’° å¼€å§‹æ¨¡æ‹Ÿç§¯åˆ†æ›´æ–°...');
                
                if (!window.UnifiedStateSync) {
                    throw new Error('UnifiedStateSyncæœªåŠ è½½');
                }

                const currentUser = window.UnifiedStateSync.getCurrentUser();
                if (!currentUser) {
                    log('âŒ è¯·å…ˆæ¨¡æ‹Ÿç™»å½•');
                    return;
                }

                // éšæœºå¢åŠ ç§¯åˆ†
                const newCredits = window.UnifiedStateSync.getCredits() + Math.floor(Math.random() * 50) + 10;
                window.UnifiedStateSync.setCredits(newCredits, true);
                
                log(`âœ… ç§¯åˆ†æ›´æ–°æˆåŠŸ: ${newCredits}`);
                updateStatusDisplay();
                
            } catch (error) {
                log(`âŒ ç§¯åˆ†æ›´æ–°å¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•æ‰£é™¤ç§¯åˆ†
        async function testDeductCredits() {
            try {
                log('â– å¼€å§‹æµ‹è¯•æ‰£é™¤10ç§¯åˆ†...');
                
                if (!window.UnifiedStateSync) {
                    throw new Error('UnifiedStateSyncæœªåŠ è½½');
                }

                const success = await window.UnifiedStateSync.deductCredits(10);
                if (success) {
                    log('âœ… ç§¯åˆ†æ‰£é™¤æˆåŠŸ');
                } else {
                    log('âŒ ç§¯åˆ†æ‰£é™¤å¤±è´¥ - ç§¯åˆ†ä¸è¶³');
                }
                updateStatusDisplay();
                
            } catch (error) {
                log(`âŒ ç§¯åˆ†æ‰£é™¤å¤±è´¥: ${error.message}`);
            }
        }

        // åˆ·æ–°çŠ¶æ€
        function refreshStatus() {
            log('ğŸ”„ åˆ·æ–°çŠ¶æ€æ˜¾ç¤º...');
            updateStatusDisplay();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            log('ğŸš€ æµ‹è¯•é¡µé¢åˆå§‹åŒ–...');
            
            // ç­‰å¾…UnifiedStateSyncåŠ è½½
            let maxWait = 50;
            while (!window.UnifiedStateSync && maxWait > 0) {
                await new Promise(resolve => setTimeout(resolve, 100));
                maxWait--;
            }
            
            if (window.UnifiedStateSync) {
                log('âœ… UnifiedStateSyncå·²åŠ è½½');
                
                // æ·»åŠ çŠ¶æ€ç›‘å¬å™¨
                window.UnifiedStateSync.addListener((event, data) => {
                    log(`ğŸ”” æ”¶åˆ°çŠ¶æ€å˜æ›´äº‹ä»¶: ${event}`);
                    if (event === 'userChanged') {
                        log(`ğŸ‘¤ ç”¨æˆ·çŠ¶æ€å˜æ›´: ${data.newUser?.email || 'å·²ç™»å‡º'}`);
                    } else if (event === 'creditsChanged') {
                        log(`ğŸ’° ç§¯åˆ†å˜æ›´: ${data.oldCredits} â†’ ${data.newCredits}`);
                    }
                    updateStatusDisplay();
                });
                
                // åˆå§‹çŠ¶æ€æ˜¾ç¤º
                updateStatusDisplay();
                
                log('âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
            } else {
                log('âŒ UnifiedStateSyncåŠ è½½è¶…æ—¶');
            }
        });

        // ç›‘å¬è·¨é¡µé¢çŠ¶æ€å˜æ›´
        window.addEventListener('unifiedStateChanged', function(event) {
            log('ğŸ“¡ æ”¶åˆ°è·¨é¡µé¢çŠ¶æ€å˜æ›´é€šçŸ¥');
            updateStatusDisplay();
        });

        // è°ƒè¯•localStorageå‡½æ•°
        function debugLocalStorage() {
            log('ğŸ” è°ƒè¯•localStorageå­˜å‚¨çŠ¶æ€:');
            log('----------------------------------');
            
            // æ£€æŸ¥æ‰€æœ‰ç›¸å…³çš„localStorageé”®
            const keys = ['flux_krea_user', 'flux_krea_credits', 'flux_krea_state_change'];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        log(`ğŸ“¦ ${key}: ${JSON.stringify(parsed, null, 2)}`);
                    } catch (e) {
                        log(`ğŸ“¦ ${key}: ${value} (åŸå§‹å­—ç¬¦ä¸²)`);
                    }
                } else {
                    log(`ğŸ“¦ ${key}: (ä¸å­˜åœ¨)`);
                }
            });
            
            log('----------------------------------');
            
            // æ£€æŸ¥UnifiedStateSyncçŠ¶æ€
            if (window.UnifiedStateSync) {
                const currentUser = window.UnifiedStateSync.getCurrentUser();
                const credits = window.UnifiedStateSync.getCredits();
                log(`ğŸ”„ UnifiedStateSyncçŠ¶æ€:`);
                log(`   ç”¨æˆ·: ${currentUser?.email || 'æœªç™»å½•'}`);
                log(`   ç§¯åˆ†: ${credits}`);
            } else {
                log('âŒ UnifiedStateSyncæœªåŠ è½½');
            }
            
            // æ‰‹åŠ¨è§¦å‘çŠ¶æ€åŒæ­¥
            log('ğŸ”„ æ‰‹åŠ¨è§¦å‘çŠ¶æ€åŒæ­¥...');
            if (window.UnifiedStateSync) {
                window.UnifiedStateSync.broadcastStateChange();
                log('âœ… çŠ¶æ€åŒæ­¥ä¿¡å·å·²å‘é€');
            }
        }

        // ç›‘å¬localStorageå˜åŒ–
        window.addEventListener('storage', function(event) {
            if (event.key === 'flux_krea_user' || event.key === 'flux_krea_state_change') {
                log('ğŸ“¦ æ£€æµ‹åˆ°localStorageå˜åŒ–');
                setTimeout(updateStatusDisplay, 100);
            }
        });
    </script>
</body>
</html>