<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>Flux Krea AI - Free AI Image Generator, Fast HD Art Creation</title>
    <meta name="description"
        content="Create stunning AI images from text prompts powered by Flux.1 Krea dev Model, No-Signup,High-Quality, Realistic 4K art creation and maker in secongs.">
    <meta name="keywords"
        content="Flux Krea,AI image generator,Free AI art generator, Text to image, Free image generator, Professional AI images, FLUX.1 Krea,Free Image Generation, AI Art Creation">
    <meta name="author" content="FLUX Krea AI">
    <meta name="robots" content="index, follow">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Flux Krea AI - Free AI Image Generator, Fast HD Art Creation">
    <meta property="og:description"
        content="Create stunning, professional-quality images from text prompts using advanced FLUX AI technology. Generate images in seconds with superior quality and control.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://flux-krea-ai.com">
    <meta property="og:image" content="https://flux-krea-ai.com/og-image.jpg">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Flux Krea AI - Free AI Image Generator, Fast HD Art Creation">
    <meta name="twitter:description"
        content="Generate high-quality AI images instantly with FLUX Krea AI. Professional results in seconds.">
    <meta name="twitter:image" content="https://flux-krea-ai.com/twitter-image.jpg">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://flux-krea-ai.com">

    <!-- Favicon -->
    <link rel="icon" type="image/png"
        href="https://ciwjjfcuhubjydajazkk.supabase.co/storage/v1/object/public/webstie-icon//FluxKrea%20log-120.png">
    <link rel="apple-touch-icon"
        href="https://ciwjjfcuhubjydajazkk.supabase.co/storage/v1/object/public/webstie-icon//FluxKrea%20log-120.png">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HRV45ZRFKT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-HRV45ZRFKT');
    </script>

    <!-- 核心函数定义 - 必须在页面最早加载 -->
    <script>
        // 立即定义generateImage函数，确保全局可访问
        // 重构后的generateImage函数，使用ImageGenerator类
        window.generateImage = async function () {
            console.log('✅ generateImage函数被正确调用！');

            // 使用ImageGenerator类处理生成逻辑
            if (window.imageGenerator) {
                await window.imageGenerator.generate();
            } else {
                console.error('❌ ImageGenerator未初始化');
                alert('系统初始化中，请稍后重试');
            }
        };

        // 测试生图API函数
        window.testGenerateAPI = async function () {
            console.log('🔧 测试生图API...');
            const prompt = document.getElementById('prompt')?.value?.trim() || '测试提示词';

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        width: 1024,
                        height: 1024,
                        steps: 4
                    })
                });

                const result = await response.json();
                console.log('🎯 API响应:', result);
                alert('生图API测试成功！查看控制台了解详情。');
            } catch (error) {
                console.error('❌ 生图API测试失败:', error);
                if (error.message.includes('Unexpected token')) {
                    alert(`⚠️ 生图API无法工作:\n\n` +
                        `原因: 当前使用Python静态服务器\n\n` +
                        `需要切换到Vercel开发服务器:\n` +
                        `1. 停止当前服务器 (Ctrl+C)\n` +
                        `2. 运行: vercel dev\n` +
                        `3. 访问: http://localhost:3000`);
                } else {
                    alert('生图API测试失败: ' + error.message);
                }
            }
        };

        // 检查用户状态函数（调试用）
        window.checkUserState = function () {
            const currentUser = window.currentUser || window.UserStateManager?.currentUser;
            const localStorageUser = localStorage.getItem('flux_krea_user');

            console.log('=== 用户状态检查 ===');
            console.log('window.currentUser:', currentUser);
            console.log('UserStateManager.currentUser:', window.UserStateManager?.currentUser);
            console.log('localStorage用户数据:', localStorageUser);

            if (localStorageUser) {
                try {
                    const parsedUser = JSON.parse(localStorageUser);
                    console.log('解析后的localStorage用户:', parsedUser);
                } catch (e) {
                    console.error('localStorage用户数据解析失败:', e);
                }
            }

            alert(`用户状态检查完成，请查看控制台。\n\n当前用户: ${currentUser ? currentUser.email : '未登录'}\n积分: ${currentUser ? currentUser.credits : '未知'}`);
        };

        // 简单的测试函数
        window.testClick = function () {
            alert('按钮点击测试成功！');
            console.log('✅ 按钮点击事件正常工作');
        };

        // 显示积分弹窗（统一函数）- 移到页面顶部确保早期加载
        window.showCreditsModal = function (currentCredits = null, requiredCredits = 10) {
            const modal = document.getElementById('creditsModal');
            const title = document.getElementById('creditsModalTitle');
            const content = document.getElementById('creditsModalContent');

            if (!modal || !title || !content) {
                console.error('❌ Modal elements not found');
                return;
            }

            // 获取按钮元素
            const primaryBtn = modal.querySelector('.credits-modal-btn.primary');
            const primaryBtnSpan = primaryBtn?.querySelector('span');
            
            if (currentCredits === null) {
                // Not logged in user - emphasize first login bonus of 20 credits
                title.textContent = '🎁 Get Free Credits';
                content.innerHTML = `
                    <div style="text-align: center; line-height: 1.6;">
                        <p style="margin: 0 0 10px 0; font-size: 16px; color: #333;">
                            <strong>Get 20 free credits on your first login!</strong>
                        </p>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            Sign in with your Gmail account and start creating AI images
                        </p>
                    </div>
                `;
                
                // 设置为登录按钮
                if (primaryBtn && primaryBtnSpan) {
                    primaryBtn.onclick = () => signInFromModal();
                    primaryBtnSpan.textContent = 'Sign in';
                }
                console.log('📱 Showing not logged in modal - emphasizing first login 20 credits bonus');
            } else if (currentCredits === 0) {
                // Logged in user with 0 credits
                title.textContent = '💳 Insufficient Credits';
                content.innerHTML = `
                    <div style="text-align: center; line-height: 1.6;">
                        <p style="margin: 0 0 10px 0; font-size: 16px; color: #333;">
                            You have run out of credits
                        </p>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            Generating one image requires 10 credits. Please purchase more credits to continue creating
                        </p>
                    </div>
                `;
                
                // 设置为购买按钮，跳转到Pricing页面
                if (primaryBtn && primaryBtnSpan) {
                    // 修改图标为皇冠
                    const iconElement = primaryBtn.querySelector('.google-icon') || primaryBtn.querySelector('i');
                    if (iconElement) {
                        iconElement.className = 'fas fa-crown';
                    }
                    primaryBtn.onclick = () => {
                        closeCreditsModal();
                        window.location.href = 'pricing.html';
                    };
                    primaryBtnSpan.textContent = 'Purchase Premium';
                }
                console.log('📱 Showing 0 credits modal');
            } else {
                // Logged in but insufficient credits (not 0)
                title.textContent = '💳 Insufficient Credits';
                content.innerHTML = `
                    <div style="text-align: center; line-height: 1.6;">
                        <p style="margin: 0 0 10px 0; font-size: 16px; color: #333;">
                            Current credits: <strong>${currentCredits}</strong>
                        </p>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            Generating images requires <strong>${requiredCredits}</strong> credits. Please purchase more credits
                        </p>
                    </div>
                `;
                
                // 设置为购买按钮，跳转到Pricing页面
                if (primaryBtn && primaryBtnSpan) {
                    // 修改图标为皇冠
                    const iconElement = primaryBtn.querySelector('.google-icon') || primaryBtn.querySelector('i');
                    if (iconElement) {
                        iconElement.className = 'fas fa-crown';
                    }
                    primaryBtn.onclick = () => {
                        closeCreditsModal();
                        window.location.href = 'pricing.html';
                    };
                    primaryBtnSpan.textContent = 'Purchase Premium';
                }
                console.log(`📱 Showing insufficient credits modal: ${currentCredits}/${requiredCredits}`);
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        // 关闭积分弹窗
        window.closeCreditsModal = function () {
            const modal = document.getElementById('creditsModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                console.log('📱 弹窗已关闭');
            }
        };

        // 从弹窗登录
        window.signInFromModal = async function () {
            try {
                console.log('🔐 从弹窗开始Google登录...');

                // 直接点击页面上的登录按钮
                const signinBtn = document.querySelector('.signin-btn');
                if (signinBtn) {
                    signinBtn.click();
                    window.closeCreditsModal(); // 关闭弹窗
                } else {
                    throw new Error('找不到登录按钮');
                }
            } catch (error) {
                console.error('❌ Google登录失败:', error);
                alert('登录失败: ' + error.message);
            }
        };

        // 调试Generate按钮
        window.debugGenerate = function () {
            console.log('🔧 调试Generate按钮...');
            console.log('- currentUser:', window.currentUser);
            console.log('- generateImage函数:', typeof window.generateImage);
            console.log('- showCreditsModal函数:', typeof window.showCreditsModal);

            // 强制显示弹窗测试
            if (typeof window.showCreditsModal === 'function') {
                console.log('✅ 强制显示弹窗测试');
                window.showCreditsModal();
            } else {
                console.error('❌ showCreditsModal函数未定义');
            }
        };

        // 调试函数已删除，使用真正的generateImage函数

        console.log('✅ generateImage函数已定义在页面顶部');
        console.log('🔧 版本时间戳:', new Date().toISOString());

        // 立即初始化用户状态管理器
        (function () {
            console.log('🚀 立即初始化用户状态管理器...');

            // 如果页面已加载完成，立即初始化
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initUserState);
            } else {
                initUserState();
            }

            function initUserState() {
                if (window.UserStateManager) {
                    window.UserStateManager.initialize();
                    console.log('✅ 用户状态管理器已初始化');
                }
            }
        })();

        // 统一的用户状态管理器
        window.UserStateManager = {
            currentUser: null,

            // 初始化用户状态
            async initialize() {
                console.log('🔧 初始化用户状态管理器...');

                // 从localStorage恢复用户状态
                const savedUser = localStorage.getItem('flux_krea_user');
                if (savedUser) {
                    try {
                        this.currentUser = JSON.parse(savedUser);
                        window.currentUser = this.currentUser;
                        console.log('✅ 从localStorage恢复用户状态:', this.currentUser.email);
                    } catch (error) {
                        console.error('❌ 解析用户数据失败:', error);
                        localStorage.removeItem('flux_krea_user');
                    }
                }

                // 更新UI
                this.updateUI();

                // 如果有用户，同步积分
                if (this.currentUser) {
                    await this.syncCredits();
                }
            },

            // 设置用户状态
            setUser(user) {
                this.currentUser = user;
                window.currentUser = user;

                if (user) {
                    localStorage.setItem('flux_krea_user', JSON.stringify(user));
                    console.log('✅ 用户状态已保存:', user.email);
                } else {
                    localStorage.removeItem('flux_krea_user');
                    console.log('✅ 用户状态已清除');
                }

                this.updateUI();
                this.broadcastStateChange();
            },

            // 更新UI显示（分离登录按钮和积分显示）
            updateUI() {
                // 更新登录按钮
                this.updateSignInButton();

                // 使用全局的updateCreditsDisplay，它已经有防抖机制
                if (window.updateCreditsDisplay) {
                    window.updateCreditsDisplay();
                }
            },

            // 更新登录按钮显示（分离出来，避免与积分显示冲突）
            updateSignInButton() {
                const signinBtn = document.querySelector('.signin-btn');
                if (!signinBtn) return;

                if (this.currentUser) {
                    // 已登录状态 - 只显示头像
                    const newHTML = `
                        <img src="${this.currentUser.avatar_url || 'https://via.placeholder.com/24'}" 
                             alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%;">
                    `;
                    // 只有内容不同时才更新
                    if (signinBtn.innerHTML.trim() !== newHTML.trim()) {
                        signinBtn.innerHTML = newHTML;
                        // 保持原有的onclick属性，不覆盖
                        // signinBtn.onclick = () => this.signOut(); // 已禁用，使用统一的handleSignInClick
                    }
                } else {
                    // 未登录状态
                    const newHTML = `
                        <div class="google-icon"></div>
                        <span>Sign in</span>
                    `;
                    // 只有内容不同时才更新
                    if (signinBtn.innerHTML.trim() !== newHTML.trim()) {
                        signinBtn.innerHTML = newHTML;
                        // 保持原有的onclick="handleSignInClick()"属性，不覆盖
                        // signinBtn.onclick = () => this.signIn(); // 已禁用，使用统一的handleSignInClick
                    }
                }

                // 确保积分显示可见
                const creditsDisplay = document.getElementById('creditsDisplay');
                if (creditsDisplay) {
                    creditsDisplay.style.display = 'flex';
                }
            },

            // Google登录 - 已禁用，使用UnifiedStateSync
            async signIn() {
                console.log('⚠️ UserStateManager.signIn已禁用，请使用handleSignInClick()');
                // 重定向到统一的登录处理
                if (typeof handleSignInClick === 'function') {
                    await handleSignInClick();
                }
            },

            // 登出 - 已禁用，使用UnifiedStateSync
            async signOut() {
                console.log('⚠️ UserStateManager.signOut已禁用，请使用handleSignInClick()');
                // 重定向到统一的登录处理
                if (typeof handleSignInClick === 'function') {
                    await handleSignInClick();
                }
            },

            // 同步积分
            async syncCredits() {
                if (!this.currentUser) return;

                try {
                    const response = await fetch('/api/get-user-credits', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.currentUser.access_token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.credits !== undefined) {
                            this.currentUser.credits = data.credits;
                            this.setUser(this.currentUser);
                            console.log('✅ 积分同步成功:', data.credits);
                        }
                    }
                } catch (error) {
                    console.error('❌ 积分同步失败:', error);
                }
            },

            // 扣除积分
            async deductCredits(amount) {
                if (!this.currentUser) return false;

                if (this.currentUser.credits < amount) {
                    return false;
                }

                // 先本地扣除
                this.currentUser.credits -= amount;
                this.setUser(this.currentUser);

                // 然后同步到服务器
                await this.syncCredits();

                return true;
            },

            // 广播状态变化（用于跨页面同步）
            broadcastStateChange() {
                // 触发storage事件，通知其他页面
                localStorage.setItem('flux_krea_state_change', Date.now().toString());

                // 也触发自定义事件
                window.dispatchEvent(new CustomEvent('userStateChanged', {
                    detail: { user: this.currentUser }
                }));
            }
        };

        // 监听跨页面状态同步
        window.addEventListener('storage', function (e) {
            console.log('🔄 检测到localStorage变化:', e.key);

            if (e.key === 'flux_krea_user') {
                // 用户状态发生变化
                console.log('👤 用户状态变化，重新初始化...');

                if (window.UserStateManager) {
                    // 延迟一点时间确保数据已写入
                    setTimeout(() => {
                        window.UserStateManager.initialize();
                    }, 100);
                }
            } else if (e.key === 'flux_krea_state_change') {
                // 其他页面触发的状态变化
                console.log('🔄 其他页面状态变化，同步中...');

                if (window.UserStateManager) {
                    setTimeout(() => {
                        window.UserStateManager.initialize();
                    }, 100);
                }
            }
        });

        // 监听页面可见性变化，当页面重新可见时同步状态
        document.addEventListener('visibilitychange', function () {
            if (!document.hidden && window.UserStateManager) {
                console.log('👁️ 页面重新可见，检查状态同步...');
                setTimeout(() => {
                    window.UserStateManager.initialize();
                }, 200);
            }
        });

        // 测试API配置函数
        window.testAPIConfig = async function () {
            console.log('🧪 测试API配置...');
            try {
                const response = await fetch('/api/test-config');
                const config = await response.json();
                console.log('📋 API配置信息:', config);
                alert(`API配置检查结果:\n\n` +
                    `Replicate Token: ${config.hasReplicateToken ? '✅ 已配置' : '❌ 未配置'}\n` +
                    `Token长度: ${config.tokenLength}\n` +
                    `环境: ${config.environment}\n` +
                    `时间: ${config.timestamp}`);
            } catch (error) {
                console.error('❌ API配置检查失败:', error);

                // 检查是否是因为使用了Python服务器
                if (error.message.includes('Unexpected token')) {
                    alert(`⚠️ 检测到问题:\n\n` +
                        `当前使用的是Python静态服务器，无法运行API。\n\n` +
                        `解决方案:\n` +
                        `1. 停止当前服务器 (Ctrl+C)\n` +
                        `2. 运行: vercel dev\n` +
                        `3. 访问: http://localhost:3000\n\n` +
                        `这样API功能才能正常工作！`);
                } else {
                    alert('API配置检查失败: ' + error.message);
                }
            }
        };
        console.log('✅ testClick测试函数已定义');
    </script>

    <!-- Supabase SDK and init (must load before auth-bootstrap) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-init.js" defer></script>
    <!-- 统一状态同步模块 -->
    <script src="js/modules/unified-state-sync.js"></script>

    <!-- External Resources -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "FLUX Krea AI",
        "description": "Professional AI Image Generator powered by FLUX technology",
        "url": "https://flux-krea-ai.com",
        "applicationCategory": "DesignApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "FLUX Krea AI"
        }
    }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }

        /* Header Navigation */
        .header {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            color: #6366f1;
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: transparent;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            overflow: hidden;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-links {
            display: flex;
            gap: 32px;
            list-style: none;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #64748b;
            font-weight: 500;
            font-size: 16px;
            transition: color 0.2s;
        }

        .nav-links a.active {
            color: #6366f1;
            font-weight: 600;
        }

        .nav-links a:hover {
            color: #6366f1;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .credits-display {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .credits-display i {
            color: #ff8c00;
        }

        .signin-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            color: #3c4043;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .signin-btn:hover {
            background: #f8f9fa;
            border-color: #dadce0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .google-icon {
            width: 18px;
            height: 18px;
            background: url('https://www.gstatic.com/marketing-cms/assets/images/76/76/c79495454250aaacab1867bdcda4/about-10things-g.png') no-repeat center;
            background-size: contain;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 60px 32px 60px;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-badge {
            display: inline-block;
            background: #e0e7ff;
            color: #6366f1;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .hero-badges {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .badge.orange {
            background: #f97316;
        }

        .badge.green {
            background: #10b981;
        }

        .badge.blue {
            background: #3b82f6;
        }

        .badge.purple {
            background: #8b5cf6;
        }

        .hero h1 {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        .hero p {
            font-size: 16px;
            color: #64748b;
            margin: 0px 0px 0px;
            line-height: 1.6;
        }

        /* Main Generator */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            margin: 0px 0px 60px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-subtitle {
            color: #64748b;
            margin-bottom: 32px;
            font-size: 16px;
        }

        /* Generation Mode */
        .mode-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            width: 100%;
            justify-content: center;
        }

        .mode-btn {
            width: 100%;
            height: 57px;
            min-height: 57px;
            max-height: 57px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            position: relative;
            box-sizing: border-box;
            white-space: nowrap;
        }

        .mode-btn.active {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }

        .mode-btn:hover:not(.active) {
            border-color: #6366f1;
            background: #f8faff;
        }

        .coming-soon {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f97316;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            text-transform: uppercase;
        }

        /* Prompt Input */
        .prompt-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #374151;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.2s;
            font-family: inherit;
            display: flex;
            align-items: center;
            vertical-align: middle;
        }

        .prompt-textarea::placeholder {
            color: rgba(100, 116, 139, 0.5);
            opacity: 1;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .copy-btn {
            margin-top: 12px;
            margin-right: 8px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #64748b;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #e2e8f0;
        }

        .clear-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #64748b;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .setting-item label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .setting-item select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .setting-item select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .slider-container {
            grid-column: span 2;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
        }

        .slider-value {
            float: right;
            font-weight: 600;
            color: #6366f1;
        }

        /* Result Display Styles */
        .result-success {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .result-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .result-title {
            color: #10b981;
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .result-meta {
            color: #6b7280;
            font-size: 14px;
        }

        .image-container {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }

        .generated-image {
            max-width: 100%;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .generated-image:hover {
            transform: scale(1.02);
        }

        .generated-image.fullscreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            z-index: 1000;
            max-width: 90vw;
            max-height: 90vh;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .image-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-container:hover .image-overlay {
            opacity: 1;
        }

        .overlay-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 16px;
        }

        .result-info {
            margin-bottom: 20px;
        }

        .prompt-info {
            margin-bottom: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
        }

        .prompt-text {
            color: #374151;
            font-style: italic;
        }

        .credits-info {
            text-align: center;
            margin-bottom: 12px;
        }

        .credits-text {
            color: #6b7280;
            font-size: 14px;
            background: #f0f9ff;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e0f2fe;
        }

        .error-warning {
            color: #f59e0b;
            background: #fef3c7;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #fde68a;
            text-align: center;
            margin-top: 12px;
        }

        .result-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn.primary {
            background: #6366f1;
            color: white;
        }

        .action-btn.primary:hover {
            background: #5856eb;
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: #f8fafc;
            color: #374151;
            border: 1px solid #e2e8f0;
        }

        .action-btn.secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .result-stats {
            display: flex;
            justify-content: space-around;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .stat-value {
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        /* History Modal Styles */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .history-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            max-height: 80vh;
            width: 90%;
            overflow: hidden;
        }

        .history-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .history-modal-header h3 {
            margin: 0;
            color: #374151;
        }

        .history-modal-header button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .history-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .history-info {
            flex: 1;
        }

        .history-prompt {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .history-meta {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .history-actions {
            display: flex;
            gap: 8px;
        }

        .history-actions button {
            padding: 6px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .history-actions button:hover {
            background: #f1f5f9;
        }

        /* Secondary Actions */
        .secondary-btn {
            padding: 8px 16px;
            background: #f8fafc;
            color: #374151;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .secondary-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Generate Button */
        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .generate-btn .btn-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .generate-btn .credits-cost {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 500;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* H5 Pricing Entry Button */
        .h5-pricing-btn {
            display: none;
            width: 100%;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            margin-top: 20px;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
        }

        .h5-pricing-btn:hover {
            background: linear-gradient(135deg, #f97316, #ea580c);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.4);
        }

        /* Result Section */
        .result-placeholder {
            text-align: center;
            padding: 80px 24px;
            color: #94a3b8;
        }

        .result-placeholder i {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .result-image {
            width: 100%;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .loading {
            text-align: center;
            padding: 80px 24px;
            color: #6366f1;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Error and Success States */
        .result-error {
            text-align: center;
            padding: 40px 24px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            color: #dc2626;
        }

        .result-error i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #f87171;
        }

        .result-error h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #dc2626;
        }

        .result-success {
            text-align: center;
            padding: 0px;
        }

        .generated-image {
            width: 100%;
            max-width: 512px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            margin-bottom: 20px;
        }

        .result-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .action-btn {
            padding: 8px 16px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: #5b5bd6;
            transform: translateY(-1px);
        }

        .generation-info {
            color: #64748b;
            font-size: 14px;
            margin: 8px 0;
        }

        .generating-status {
            text-align: center;
            padding: 60px 24px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .generating-status h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .generating-status p {
            color: #64748b;
            font-size: 14px;
        }

        /* Steps Section */
        .steps-section {
            background: white;
            padding: 60px 0;
        }

        .section-header {
            text-align: center;
            margin-bottom: 36px;
        }

        .section-header h2 {
            font-size: 40px;
            font-weight: 800;
            margin-bottom: 24px;
            color: #1a202c;
        }

        .section-header p {
            font-size: 20px;
            color: #64748b;
            max-width: 1120px;
            margin: 0 auto;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 48px;
        }

        .step-card {
            text-align: center;
            padding: 32px;
        }

        .step-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 32px;
        }

        .step-card h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1a202c;
        }

        .step-card p {
            color: #64748b;
            line-height: 1.6;
        }

        /* Features Section */
        .features-section {
            background: #f8fafc;
            padding: 60px 0;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 48px;
            margin-top: 80px;
        }

        .feature-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .feature-image {
            margin-bottom: 24px;
        }

        .feature-image img {
            width: 100%;
            border-radius: 12px;
        }

        .feature-card h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1a202c;
        }

        .feature-card p {
            color: #64748b;
            line-height: 1.6;
            margin-bottom: 24px;
            flex-grow: 1;
        }

        .demo-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 36px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 180px;
            justify-content: center;
            margin: 0 auto;
            align-self: flex-end;
        }

        .demo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        /* CTA Buttons */
        .cta-btn {
            display: inline-block;
            padding: 16px 32px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .cta-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .cta-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        /* Testimonials Section */
        .testimonials-section {
            background: white;
            padding: 60px 0;
        }

        .testimonials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
            margin-top: 80px;
        }

        .testimonial-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .stars {
            color: #fbbf24;
            margin-bottom: 24px;
            font-size: 18px;
        }

        .testimonial-card p {
            color: #374151;
            line-height: 1.6;
            margin-bottom: 24px;
            font-style: italic;
        }

        .testimonial-author {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .author-avatar {
            width: 48px;
            height: 48px;
            background: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .author-name {
            font-weight: 600;
            color: #1a202c;
        }

        .author-title {
            color: #64748b;
            font-size: 14px;
        }

        .stats {
            text-align: center;
            margin-top: 80px;
        }

        .stats-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 40px;
            font-weight: 800;
            color: #6366f1;
        }

        .stat-label {
            color: #64748b;
            font-size: 16px;
        }

        /* FAQ Section */
        .faq-section {
            background: #f8fafc;
            padding: 60px 0;
        }

        .faq-container {
            max-width: 800px;
            margin: 80px auto 0;
        }

        .faq-item {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .faq-question {
            padding: 24px 32px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .faq-question:hover {
            background: #f8fafc;
        }

        .faq-question h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        .faq-question i {
            color: #64748b;
            transition: transform 0.2s;
        }

        .faq-answer {
            padding: 0 32px 24px;
            display: none;
        }

        .faq-answer p {
            color: #64748b;
            line-height: 1.6;
            margin: 0;
        }

        .faq-item.active .faq-answer {
            display: block;
        }

        .faq-item.active .faq-question i {
            transform: rotate(180deg);
        }

        /* Footer */
        .footer {
            background: #1a202c;
            color: white;
            padding: 80px 0 32px;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 48px;
            margin-bottom: 48px;
        }

        .footer-logo {
            color: white;
            margin-bottom: 24px;
        }

        .footer-description {
            color: #94a3b8;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .social-links {
            display: flex;
            gap: 16px;
        }

        .social-links a {
            color: #94a3b8;
            font-size: 20px;
            transition: color 0.2s;
        }

        .social-links a:hover {
            color: #6366f1;
        }

        .footer-section h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .footer-links {
            list-style: none;
            padding: 0;
        }

        .footer-links li {
            margin-bottom: 12px;
        }

        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: white;
        }

        .footer-bottom {
            border-top: 1px solid #374151;
            padding-top: 32px;
            text-align: center;
            color: #94a3b8;
        }

        /* Responsive Design */
        @media (max-width: 768px) {

            /* H5端logo字号调整 */
            .logo {
                font-size: 16px;
            }

            /* H5端logo图标尺寸和间距调整 */
            .logo-icon {
                width: 32px;
                height: 32px;
                margin-right: 6px;
            }

            /* 移动端导航栏样式 */
            .nav {
                position: relative;
            }

            .nav-links {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                flex-direction: column;
                gap: 16px;
                padding: 24px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                transform: translateY(-100%);
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                border-radius: 0 0 12px 12px;
            }

            .nav-links.active {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
            }

            .nav-links li {
                width: 100%;
                text-align: center;
            }

            .nav-links a {
                display: block;
                padding: 12px 16px;
                border-radius: 8px;
                transition: background-color 0.2s;
            }

            .nav-links a:hover {
                background-color: rgba(99, 102, 241, 0.1);
            }

            /* 汉堡菜单按钮 */
            .hamburger-menu {
                display: flex;
                /* 移动端显示 */
                flex-direction: column;
                gap: 3px;
                cursor: pointer;
                padding: 8px;
                border-radius: 6px;
                transition: background-color 0.2s;
            }

            .hamburger-menu:hover {
                background-color: rgba(0, 0, 0, 0.05);
            }

            .hamburger-menu span {
                width: 20px;
                height: 2px;
                background-color: #64748b;
                transition: all 0.3s ease;
            }

            .hamburger-menu.active span:nth-child(1) {
                transform: rotate(45deg) translate(5px, 5px);
            }

            .hamburger-menu.active span:nth-child(2) {
                opacity: 0;
            }

            .hamburger-menu.active span:nth-child(3) {
                transform: rotate(-45deg) translate(7px, -6px);
            }

            /* 移动端登录按钮样式 */
            .signin-btn {
                display: flex !important;
                padding: 4px 6px;
                font-size: 12px;
            }

            /* 移动端显示积分显示 */
            .credits-display {
                display: flex !important;
            }

            .hero h1 {
                font-size: 32px;
            }

            .hero p {
                font-size: 18px;
            }

            .main-grid {
                grid-template-columns: 1fr;
                gap: 32px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .mode-buttons {
                flex-direction: column;
                align-items: center;
                width: 100%;
            }

            .mode-btn {
                width: 100% !important;
                max-width: 366px !important;
                height: 57px !important;
                font-size: 16px !important;
                padding: 6px 8px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                gap: 6px !important;
            }

            .section-header h2 {
                font-size: 32px;
            }

            .stats-grid {
                gap: 40px;
            }

            .h5-pricing-btn {
                display: flex;
            }
        }

        /* Loading Modal */
        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            max-width: 320px;
            width: 90%;
        }

        .loading-modal .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Insufficient Credits Modal */
        .credits-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .credits-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .credits-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .credits-modal.active .credits-modal-content {
            transform: scale(1);
        }

        .credits-modal-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 36px;
        }

        .credits-modal h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a202c;
        }

        .credits-modal p {
            color: #64748b;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .credits-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .credits-modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .credits-modal-btn.primary {
            background: #ffffff;
            border: 1px solid #dadce0;
            color: #3c4043;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .credits-modal-btn.primary:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .credits-modal-btn.secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .credits-modal-btn.secondary:hover {
            background: #e2e8f0;
        }

        .google-icon-modal {
            width: 18px;
            height: 18px;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE3LjY0IDkuMjA0NTVDMTcuNjQgOC41NjYzNiAxNy41ODM2IDcuOTUyNzMgMTcuNDggNy4zNjM2NEg5VjEwLjg0NTVIMTMuODQzNkMxMy42MzUgMTEuOTcgMTMuMDAwOSAxMi45MjMgMTIuMTEgMTMuNTYxNFYxNS44MTk1SDEzLjk1NjRDMTUuNjU3MyAxNC4yNTI3IDE2LjY0IDEyLjk0NTUgMTcuNjQgOS4yMDQ1NVoiIGZpbGw9IiM0Mjg1RjQiLz4KPHBhdGggZD0iTTkgMThDMTEuNDMgMTggMTMuNDY3MyAxNy4xOTQxIDE0Ljk1NjQgMTUuODE5NUwxMy4xMSAxMy41NjE0QzEyLjQyIDEzLjk5OTEgMTEuNTQgMTQuMjYxNCAxMC4wMzY0IDE0LjI2MTRDNy42NSAxNC4yNjE0IDUuNjcyNzMgMTMuNjA0MSA0LjM2NCA5LjI1SDE2LjI0NTVWNy4zNjM2NEgzLjI3VjE0LjI2MTRDMy4yNyAxNS4wODQxIDQuMDg2MzYgMTcuNjEzNiA5IDE4WiIgZmlsbD0iIzM0QTg1MyIvPgo8cGF0aCBkPSJNMy4zNjM2NCA5LjI3SDBWMTYuMjczNkMwIDExLjUyNzMgMy4zNjM2NCA4LjE2MzY0IDguMSA4LjE2MzY0VjEwLjM0MTRDNi4xNzQ1NSAxMC4zNDE0IDMuNzMwOTEgMTAuNjEzNiAzLjM2MzY0IDEwLjk5MDlWOS4yN1oiIGZpbGw9IiNGQkJDMDQiLz4KPHBhdGggZD0iTTkgNy4xNkM2LjM4MTgyIDcuMTYgNC4yIDkuMzQxODIgMy4zNjM2NCA3LjUwNDU1TDEuNTQwOTEgNS42M0M2LjAwOTA5IDEuMTU0NTUgMTEuNDMgMS4xNTQ1NSAxNi45IDYuNjM2MzZMMTUuMDc3MyA4LjQ1OTA5Qzg1IDcuMzk1NDUgOS40NzI3MyA7LjE2IDkgNy4xNloiIGZpbGw9IiNFQTQzMzUiLz4KPC9zdmc+Cg==') no-repeat center;
            background-size: contain;
        }

        /* 退出登录确认弹窗 */
        .signout-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .signout-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .signout-modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .signout-modal.active .signout-modal-content {
            transform: scale(1);
        }

        .signout-modal h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #1a202c;
        }

        .signout-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .signout-modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .signout-modal-btn.cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .signout-modal-btn.cancel:hover {
            background: #e2e8f0;
        }

        .signout-modal-btn.confirm {
            background: #dc2626;
            color: white;
        }

        .signout-modal-btn.confirm:hover {
            background: #b91c1c;
        }

        /* 用户头像样式 */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .login-modal.active {
            display: flex;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #f1f5f9;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .modal-header h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a202c;
        }

        .modal-header p {
            color: #64748b;
            font-size: 16px;
        }

        .login-benefits {
            margin: 32px 0;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            color: #374151;
        }

        .benefit-item i {
            width: 24px;
            color: #6366f1;
            font-size: 18px;
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 6px 12px;
            background: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            color: #3c4043;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .google-signin-btn:hover {
            background: #f8f9fa;
            border-color: #dadce0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .google-signin-btn .google-icon {
            width: 18px;
            height: 18px;
            background: url('https://www.gstatic.com/marketing-cms/assets/images/76/76/c79495454250aaacab1867bdcda4/about-10things-g.png') no-repeat center;
            background-size: contain;
        }

        .secondary-btn {
            padding: 14px 24px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #64748b;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .generation-progress {
            margin-top: 24px;
            width: 100%;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            width: 0%;
            transition: width 20s ease-out;
        }

        .progress-text {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            margin: 0;
        }

        /* 确保按钮和积分显示可见 */
        .signin-btn,
        #creditsDisplay {
            opacity: 1;
            transition: opacity 0.3s ease;
        }
    
        /* 用户下拉菜单样式 */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 1000;
            min-width: 280px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 8px;
        }

        .user-dropdown-content {
            padding: 16px;
        }

        .user-info-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar-large {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .user-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details {
            flex: 1;
        }

        .username {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .user-level {
            font-size: 14px;
            color: #666;
            margin-bottom: 2px;
        }

        .user-valid-time {
            font-size: 12px;
            color: #999;
        }

        .dropdown-divider {
            height: 1px;
            background: #e1e5e9;
            margin: 16px -16px;
        }

        .dropdown-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 12px;
            background: none;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .dropdown-btn i {
            width: 16px;
            text-align: center;
        }

        /* 登录按钮优化 - 只显示头像 */
        .signin-btn.logged-in {
            padding: 4px;
            border: none;
            background: none;
            position: relative;
        }

        .signin-btn.logged-in:hover {
            background: #f5f5f5;
            border-radius: 50%;
        }

        .signin-btn .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
        }

        .signin-btn .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 积分显示优化 */
        .credits-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .credits-display i {
            font-size: 16px;
            color: #ffd700;
        }

        /* 响应式优化 */
        @media (max-width: 768px) {
            /* H5页面隐藏用户下拉菜单 */
            .user-dropdown {
                display: none !important;
            }
            
            .user-info-section {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
        }

        </style>

    <script>

        // 预加载缓存系统 - 避免UI闪烁
        (function () {
            // 立即从localStorage读取用户状态
            const cachedUser = localStorage.getItem('flux_krea_user');
            const cachedCredits = localStorage.getItem('flux_krea_credits');

            if (cachedUser) {
                try {
                    const user = JSON.parse(cachedUser);
                    window.preloadedUser = user;

                    // 立即设置全局用户状态
                    window.currentUser = user;

                    console.log('🚀 预加载用户状态:', user.email);
                } catch (e) {
                    console.warn('预加载用户状态失败:', e);
                }
            }

            if (cachedCredits) {
                try {
                    const credits = JSON.parse(cachedCredits);
                    window.preloadedCredits = credits;

                    console.log('🚀 预加载积分状态:', credits);
                } catch (e) {
                    console.warn('预加载积分状态失败:', e);
                }
            }
        })();

        // 立即更新UI显示 - 避免闪烁
        function immediateUIUpdate() {
            if (window.preloadedUser) {
                const user = window.preloadedUser;

                // 立即更新登录按钮
                const signinBtn = document.querySelector('.signin-btn');
                if (signinBtn) {
                    signinBtn.innerHTML = `
                        <img src="${user.avatar_url || 'https://via.placeholder.com/18'}" 
                             style="width: 18px; height: 18px; border-radius: 50%;" alt="Avatar">
                    `;
                    signinBtn.style.display = 'flex';
                }

                // 立即显示积分
                const creditsDisplay = document.getElementById('creditsDisplay');
                if (creditsDisplay) {
                    creditsDisplay.style.display = 'flex';
                }
            }

            if (window.preloadedCredits && window.preloadedUser) {
                const userIdentifier = window.preloadedUser.uuid || window.preloadedUser.email;
                const userCredits = window.preloadedCredits[userIdentifier];

                if (userCredits !== undefined) {
                    const creditsAmount = document.getElementById('creditsAmount');
                    if (creditsAmount) {
                        creditsAmount.textContent = userCredits;
                    }
                }
            }
        }

        // DOM加载完成后立即执行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', immediateUIUpdate);
        } else {
            immediateUIUpdate();
        }
    </script>

    <!-- 防缓存控制 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
    <div class="signout-modal" id="signoutModal">
        <div class="signout-modal-content">
            <h3>Are you sure sign out?</h3>
            <div class="signout-modal-actions">
                <button class="signout-modal-btn cancel" onclick="closeSignoutModal()">Cancel</button>
                <button class="signout-modal-btn confirm" onclick="confirmSignout()">OK</button>
            </div>
        </div>
    </div>

    <!-- Authentication Required Modal for Unauthenticated Users -->
    <div class="credits-modal" id="creditsModal">
        <div class="credits-modal-content">
            <div class="credits-modal-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h3 id="creditsModalTitle">Credits balance is 20</h3>
            <p id="creditsModalContent">Sign in with Google to Gain Free 20 Credits.</p>
            <div class="credits-modal-actions">
                <button class="credits-modal-btn primary" onclick="signInFromModal()">
                    <div class="google-icon"></div>
                    <span>Sign in</span>
                </button>
                <button class="credits-modal-btn secondary" onclick="closeCreditsModal()">
                    <span>Close</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="loading-modal" id="loadingModal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <p id="loadingMessage">正在处理...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <img src="https://ciwjjfcuhubjydajazkk.supabase.co/storage/v1/object/public/webstie-icon//FluxKrea%20log-120.png"
                        alt="FluxKrea.me AI Logo">
                </div>
                Flux Krea AI
            </a>
            <ul class="nav-links">
                <li><a href="#features">Features</a></li>
                <li><a href="showcase.html" class="active">Showcase</a></li>
                <li><a href="pricing.html">Pricing</a></li>
                <li><a href="#faq">FAQ</a></li>
            </ul>



            <div class="nav-actions">
                <div class="credits-display" id="creditsDisplay">
                    <i class="fas fa-coins"></i>
                    <span id="creditsAmount">--</span>
                </div>
                <!-- 管理员调试按钮 - 仅对特定账户显示 -->
                <button id="debugRefreshBtn" onclick="showDebugMenu()"
                    style="padding: 4px 8px; font-size: 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; margin-right: 8px; cursor: pointer; display: none;"
                    title="管理员调试菜单">
                    🔧 调试
                </button>

                <div class="signin-btn" onclick="handleSignInClick()">
                    <div class="google-icon"></div>
                    <span>Sign in</span>
                </div>
            </div>
        </nav>
        <!-- 用户信息下拉菜单 -->
        <div id="userDropdown" class="user-dropdown" style="display: none;">
            <div class="user-dropdown-content">
                <div class="user-info-section">
                    <div class="user-avatar-large">
                        <img id="dropdownUserAvatar" src="" alt="User Avatar">
                    </div>
                    <div class="user-details">
                        <div class="username" id="dropdownUsername">用户名</div>
                        <div class="user-level" id="dropdownUserLevel">Level: Free</div>
                        <div class="user-valid-time" id="dropdownValidTime">Valid time: --</div>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-actions">
                    <button class="dropdown-btn" onclick="handleSignOut()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sign out
                    </button>
                </div>
            </div>
        </div>

    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-badges">
            <span class="badge orange">✅ Free Create</span>
            <span class="badge green">🎉 No-Signup</span>
            <span class="badge blue">🏞️ High-Quality</span>
            <span class="badge purple">🥇 Fast&Realistic</span>
        </div>
        <h1>Create Stunning Images with FLUX.1 Krea Dev Model</h1>
        <p>Turn text into stunning, HQ images with Flux.1 Krea Dev — Powered by 12B-Parameter AI model.</p>
    </section>

    <!-- Main Generator -->
    <section id="generator" class="container">
        <div class="main-grid">
            <!-- Left Panel -->
            <div class="card">
                <h2>
                    <i class="fas fa-magic"></i>
                    Generation Mode
                </h2>

                <div class="mode-buttons">
                    <button class="mode-btn active" data-mode="text">
                        <i class="fas fa-pen"></i>
                        Text to Image
                    </button>
                </div>

                <div class="prompt-section">
                    <h3>Positive Prompt</h3>
                    <textarea class="prompt-textarea" id="prompt"
                        placeholder="360 image tiny planet, tiny round planet, urban, the pand in this pic walking tiny planet Norway northern lights, perfectly centered, centered in frame."></textarea>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px;">
                        <button class="copy-btn" onclick="pastePrompt()">
                            <i class="fas fa-paste"></i> Paste
                        </button>
                        <button class="clear-btn" onclick="clearPrompt()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                        <button class="clear-btn" onclick="randomPrompt()" title="随机提示词">
                            🎲 Random
                        </button>
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>
                                <i class="fas fa-expand-arrows-alt"></i>
                                Image Size
                            </label>
                            <select id="imageSize">
                                <option value="1024x1024">Square HD (1024×1024)</option>
                                <option value="1024x768">Landscape (1024×768)</option>
                                <option value="768x1024">Portrait (768×1024)</option>
                                <option value="512x512">Square (512×512)</option>
                            </select>
                        </div>

                        <div class="slider-container">
                            <label>
                                <i class="fas fa-layer-group"></i>
                                Inference Steps
                                <span class="slider-value" id="stepsValue">4</span>
                            </label>
                            <input type="range" min="1" max="4" value="4" class="slider" id="stepsSlider">
                        </div>
                    </div>

                    <button class="generate-btn" id="generateBtn" onclick="generateImage()">
                        <span class="btn-content">
                            <i class="fas fa-bolt"></i>
                            Generate
                        </span>
                        <span class="credits-cost">-10 Credits</span>
                    </button>





                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="checkUserState()"
                            style="padding: 10px; background: #6f42c1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            👤 检查用户状态
                        </button>
                        <button onclick="debugGenerate()"
                            style="padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🐛 调试Generate
                        </button>
                        <button onclick="showGenerationHistory()" title="查看生成历史"
                            style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            📚 生成历史
                        </button>
                    </div>

                    <!-- H5 Pricing Entry Button -->
                    <a href="pricing.html" class="h5-pricing-btn">
                        <i class="fas fa-credit-card"></i>
                        Get More Credits
                    </a>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="card">
                <h2>Generated Images</h2>
                <p class="card-subtitle">Your AI-generated artwork will appear here</p>

                <div id="resultArea">
                    <div class="result-placeholder">
                        <i class="fas fa-image"></i>
                        <h3>No images generated yet</h3>
                        <p>Enter a prompt and click generate to create your first image</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="features-section">
        <div class="container">
            <div class="section-header">
                <h2>Why use FLUX.1 Krea?</h2>
                <p style="margin: 0px 24px; max-width: 1120px; margin-left: auto; margin-right: auto;">FLUX.1 Krea is a
                    state of the art open source text to image model created with an emphasis on aesthetics and
                    photorealism. Unlike other models trained on massive datasets, FLUX.1 Krea was trained on hand
                    curated, high-quality training data to deliver the best results.</p>
                <div style="margin-top: 32px;">
                    <a href="#generator" class="cta-btn primary" onclick="scrollToGenerator()">
                        Try Flux.1 Krea in the main tool
                    </a>
                    <p style="margin-top: 16px; color: #64748b; font-size: 16px;">
                        Free AI image generator. No sign up, no credit card.
                    </p>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pic4.zhimg.com/v2-e1374c41f099af1c9714b09a13f4c29f_1440w.jpg"
                            alt="AI Images that Don't Look So AI">
                    </div>
                    <h3>Reality - Don't Look So AI</h3>
                    <p>Our new model offers accurate skin textures, dynamic camera angles, and expressive color.
                        Discover striking visuals in an exceptionally artistic latent space.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('photorealistic portrait of a person with detailed skin texture, dynamic camera angle, professional photography')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pic1.zhimg.com/v2-4dfe15bc9d72a0eaa6048ae2efbb755e_1440w.jpg"
                            alt="Lightning Fast Generation">
                    </div>
                    <h3>Lightning fast</h3>
                    <p>Get high definition images back in seconds. Fast iteration lets you explore, experiment, and
                        evolve your vision without interrupting your flow.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('a futuristic cityscape at golden hour, high definition, cinematic lighting')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://picx.zhimg.com/v2-972099fcef030036a5583bd4ba8aac69_1440w.jpg"
                            alt="Free Access">
                    </div>
                    <h3>Free AI Image Generator</h3>
                    <p>Enjoy free FLUX.1 Krea generations on Krea or download the weights and run it on your own
                        hardware. No sign up or credit card required. Generate AI images online for free.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('beautiful landscape with mountains and lake, golden hour lighting, artistic style')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pic4.zhimg.com/v2-c1bbf18cfc3c15c39dff6041451bc9eb_1440w.jpg"
                            alt="Hand Curated Training">
                    </div>
                    <h3>Hand Curated Training Data</h3>
                    <p>Unlike other models trained on massive datasets, FLUX.1 Krea was trained on hand curated,
                        high-quality training data to deliver the best aesthetic results.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('artistic portrait with exceptional detail and aesthetic composition, professional quality')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pic4.zhimg.com/v2-06b9a280b8a4c331a35fca57342956eb_1440w.jpg"
                            alt="Open Source">
                    </div>
                    <h3>Open Source Excellence</h3>
                    <p>FLUX.1 Krea is open source, allowing you to download the weights and run it on your own hardware
                        for complete control and privacy.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('tech illustration showing open source concept, clean design, modern style')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pica.zhimg.com/v2-ffa8c449ab7c46656eb31ac01c4d693c_1440w.jpg"
                            alt="Photorealism">
                    </div>
                    <h3>Emphasis on Photorealism</h3>
                    <p>Created with a special focus on aesthetics and photorealistic results, delivering images that are
                        virtually indistinguishable from real photography.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('photorealistic nature scene with incredible detail, professional photography style')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Testimonials Section -->
    <section class="testimonials-section">
        <div class="container">
            <div class="section-header">
                <h2>Trusted by creators worldwide</h2>
                <p>Join thousands of artists, designers, and creators who use FLUX.1 Krea daily</p>
            </div>

            <div class="testimonials-grid">
                <div class="testimonial-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p>"FLUX.1 Krea has revolutionized my creative workflow. The quality is incredible and the speed is
                        unmatched. I can now create professional-grade images in seconds!"</p>
                    <div class="testimonial-author">
                        <div class="author-avatar">S</div>
                        <div>
                            <div class="author-name">Sarah Chen</div>
                            <div class="author-title">Digital Artist</div>
                        </div>
                    </div>
                </div>

                <div class="testimonial-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p>"As a marketing professional, I need high-quality visuals fast. FLUX.1 Krea delivers exactly what
                        I need - stunning images that perfectly match my vision."</p>
                    <div class="testimonial-author">
                        <div class="author-avatar">M</div>
                        <div>
                            <div class="author-name">Mike Rodriguez</div>
                            <div class="author-title">Marketing Director</div>
                        </div>
                    </div>
                </div>

                <div class="testimonial-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p>"The level of detail and realism is mind-blowing. I've tried many AI image generators, but FLUX.1
                        Krea is in a league of its own."</p>
                    <div class="testimonial-author">
                        <div class="author-avatar">E</div>
                        <div>
                            <div class="author-name">Emily Watson</div>
                            <div class="author-title">Freelance Designer</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">50K+</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">1M+</div>
                        <div class="stat-label">Images Generated</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">4.9/5</div>
                        <div class="stat-label">User Rating</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">99.9%</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section id="faq" class="faq-section">
        <div class="container">
            <div class="section-header">
                <h2>Frequently Asked Questions</h2>
                <p>Everything you need to know about FLUX.1 Krea</p>
            </div>

            <div class="faq-container">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>What is FLUX.1 Krea?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>FLUX.1 Krea is a state-of-the-art AI image generation model that creates high-quality,
                            photorealistic images from text descriptions. It's designed to understand complex prompts
                            and generate professional-grade visuals in seconds.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>How fast is image generation?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>FLUX.1 Krea generates high-quality images in just 4-10 seconds, making it one of the fastest
                            AI image generators available while maintaining exceptional quality.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>Can I use generated images commercially?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Yes! All images generated with FLUX.1 Krea can be used for commercial purposes without
                            restrictions. You own the rights to your generated content.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>What image sizes are supported?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>FLUX.1 Krea supports various aspect ratios including square (1024×1024), landscape
                            (1024×768), and portrait (768×1024) formats, all in high resolution.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>How do I write effective prompts?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Be descriptive and specific. Include details about style, lighting, composition, and mood.
                            For example: "A serene mountain lake at sunset, oil painting style, warm golden lighting,
                            peaceful atmosphere."</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>Is there a free trial available?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Yes! We offer free credits for new users to try FLUX.1 Krea. You can generate several images
                            to experience the quality and speed before upgrading.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div>
                    <div class="logo footer-logo">
                        <div class="logo-icon">
                            <img src="https://ciwjjfcuhubjydajazkk.supabase.co/storage/v1/object/public/webstie-icon//FluxKrea%20log-120.png"
                                alt="FluxKrea.me AI Logo">
                        </div>
                        FluxKrea.me AI
                    </div>
                    <p class="footer-description">
                        Create Stunning Images with FLUX.1 Krea Dev Model
                    </p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>

                <div class="footer-section">
                    <h4>Product</h4>
                    <ul class="footer-links">
                        <li><a href="#features">Features</a></li>
                        <li><a href="showcase.html">Showcase</a></li>
                        <li><a href="pricing.html">Pricing</a></li>
                        <li><a href="#faq">FAQ</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Contact</h4>
                    <ul class="footer-links">
                        <li><a href="mailto:tiktreeapp@gmail.com">tiktreeapp@gmail.com</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Support</h4>
                    <ul class="footer-links">
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="terms.html">Terms of Service</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 Flux Krea AI. All rights reserved. Powered by advanced AI technology.</p>
            </div>
        </div>
    </footer>

    <script>
        // Token 现在在服务器端环境变量中，前端不再需要

        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Steps slider
        const stepsSlider = document.getElementById('stepsSlider');
        const stepsValue = document.getElementById('stepsValue');

        stepsSlider.addEventListener('input', () => {
            stepsValue.textContent = stepsSlider.value;
        });

        // Paste prompt function
        async function pastePrompt() {
            try {
                const clipboardText = await navigator.clipboard.readText();
                const promptTextarea = document.getElementById('prompt');
                promptTextarea.value = clipboardText;
                promptTextarea.focus();

                const btn = document.querySelector('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Pasted!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            } catch (error) {
                console.error('无法访问剪切板:', error);
                alert('无法访问剪切板，请确保浏览器支持该功能');
            }
        }

        // Clear prompt function
        function clearPrompt() {
            document.getElementById('prompt').value = '';
            document.getElementById('prompt').focus();
        }

        // Generate image function
        // Demo generation function
        function demoGenerate(prompt) {
            document.getElementById('prompt').value = prompt;
            generateImage();

            // Scroll to generator
            document.getElementById('generator').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Scroll to generator function
        function scrollToGenerator() {
            document.getElementById('generator').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // FAQ toggle function
        function toggleFAQ(element) {
            const faqItem = element.parentElement;
            const isActive = faqItem.classList.contains('active');

            // Close all FAQ items
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
            });

            // Open clicked item if it wasn't active
            if (!isActive) {
                faqItem.classList.add('active');
            }
        }

        // 移动端菜单控制函数
        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            const hamburger = document.querySelector('.hamburger-menu');

            navLinks.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        // 点击导航链接后自动关闭移动端菜单
        document.addEventListener('DOMContentLoaded', function () {
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.addEventListener('click', function () {
                    const navLinks = document.querySelector('.nav-links');
                    const hamburger = document.querySelector('.hamburger-menu');

                    navLinks.classList.remove('active');
                    hamburger.classList.remove('active');
                });
            });
        });

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });

        // 创建图片生成管理器
        window.ImageGenerator = class {
            constructor() {
                this.isGenerating = false;
                this.generationCost = 10;
            }

            // 检查是否可以生成
            canGenerate() {
                if (this.isGenerating) {
                    console.log('⚠️ 正在生成中，请等待...');
                    return false;
                }

                if (!window.UnifiedStateSync) {
                    console.error('❌ UnifiedStateSync未加载');
                    return false;
                }

                return true;
            }

            // 验证输入
            validateInput() {
                const prompt = document.getElementById('prompt')?.value?.trim();
                if (!prompt) {
                    alert('请输入图像描述');
                    return null;
                }
                return prompt;
            }

            // 检查用户状态和积分
            checkUserAndCredits() {
                const currentUser = window.UnifiedStateSync.getCurrentUser();
                const currentCredits = window.UnifiedStateSync.getCredits();

                console.log(`🔍 用户状态检查: 用户=${currentUser?.email || '未登录'}, 积分=${currentCredits}, 需要=${this.generationCost}`);

                if (!currentUser) {
                    console.log('❌ 用户未登录，显示登录弹窗');
                    showCreditsModal();
                    return { canProceed: false, reason: 'not_logged_in' };
                }

                if (currentCredits < this.generationCost) {
                    console.log('❌ Insufficient credits');

                    if (currentCredits === 0) {
                        // 积分为0时显示统一样式的弹窗
                        console.log('📱 积分为0，显示弹窗');
                        showCreditsModal(currentCredits, this.generationCost);
                    } else {
                        // Insufficient credits but not 0, show confirm dialog
                        console.log('📱 Insufficient credits but not 0, showing confirm dialog');
                        const message = `Insufficient Credits!\n\nCurrent credits: ${currentCredits}\nRequired credits: ${this.generationCost}\nMissing credits: ${this.generationCost - currentCredits}\n\nClick OK to go to Pricing page to purchase credits.`;

                        if (confirm(message)) {
                            // Save current prompt so user can continue after purchasing credits
                            const prompt = document.getElementById('prompt')?.value?.trim();
                            if (prompt) {
                                localStorage.setItem('pending_generation_prompt', prompt);
                            }

                            window.location.href = 'pricing.html';
                        }
                    }
                    return { canProceed: false, reason: 'insufficient_credits', currentCredits, requiredCredits: this.generationCost };
                }

                return { canProceed: true, user: currentUser, credits: currentCredits };
            }

            // 设置生成状态
            setGeneratingState(generating) {
                this.isGenerating = generating;
                const generateBtn = document.getElementById('generateBtn');
                const resultArea = document.getElementById('resultArea');

                if (generateBtn) {
                    generateBtn.disabled = generating;
                    generateBtn.innerHTML = generating
                        ? '<span>Generating...</span>'
                        : '<span><i class="fas fa-bolt"></i> Generate</span>';
                }

                if (resultArea && generating) {
                    resultArea.innerHTML = '<div>正在生成图像...</div>';
                }
            }

            // 调用生成API
            async callGenerateAPI(prompt) {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        width: 1024,
                        height: 1024,
                        steps: 4
                    })
                });

                if (!response.ok) {
                    throw new Error(`API调用失败: ${response.status}`);
                }

                return await response.json();
            }

            // 显示生成结果
            displayResult(result, creditsUsed = this.generationCost, remainingCredits = null, hasError = false) {
                const resultArea = document.getElementById('resultArea');
                if (!resultArea) return;

                const creditsInfo = remainingCredits !== null
                    ? `消耗积分: ${creditsUsed} | 剩余积分: ${remainingCredits}`
                    : `消耗积分: ${creditsUsed}`;

                const errorWarning = hasError
                    ? '<div class="error-warning">⚠️ 积分扣除异常，请联系客服</div>'
                    : '';

                // 获取当前提示词用于显示
                const currentPrompt = document.getElementById('prompt')?.value?.trim() || '';
                const truncatedPrompt = currentPrompt.length > 100
                    ? currentPrompt.substring(0, 100) + '...'
                    : currentPrompt;

                // 生成唯一ID用于图片操作
                const imageId = 'generated-image-' + Date.now();
                const timestamp = new Date().toLocaleString('zh-CN');

                resultArea.innerHTML = `
                    <div class="result-success">
                        <div class="result-header">
                            <h3 class="result-title">🎉 生成成功！</h3>
                            <div class="result-meta">
                                <span class="timestamp">生成时间: ${timestamp}</span>
                            </div>
                        </div>
                        
                        <div class="image-container">
                            <img id="${imageId}" src="${result.image}" alt="Generated Image" class="generated-image" 
                                 onclick="this.classList.toggle('fullscreen')" 
                                 title="点击查看大图">
                            <div class="image-overlay">
                                <button class="overlay-btn" onclick="toggleFullscreen('${imageId}')" title="全屏查看">
                                    🔍
                                </button>
                            </div>
                        </div>

                        <div class="result-info">
                            <div class="prompt-info">
                                <strong>提示词:</strong> 
                                <span class="prompt-text" title="${currentPrompt}">${truncatedPrompt}</span>
                            </div>
                            <div class="credits-info">
                                <span class="credits-text">${creditsInfo}</span>
                            </div>
                            ${errorWarning}
                        </div>

                        <div class="result-actions">
                            <button class="action-btn primary" onclick="downloadImage('${result.image}', '${currentPrompt}')" title="下载图片">
                                📥 下载图片
                            </button>
                            <button class="action-btn secondary" onclick="copyImageUrl('${result.image}')" title="复制图片链接">
                                🔗 复制链接
                            </button>
                            <button class="action-btn secondary" onclick="shareImage('${result.image}', '${currentPrompt}')" title="分享图片">
                                📤 分享
                            </button>
                            <button class="action-btn secondary" onclick="regenerateWithSamePrompt()" title="使用相同提示词重新生成">
                                🔄 重新生成
                            </button>
                        </div>

                        <div class="result-stats">
                            <div class="stat-item">
                                <span class="stat-label">尺寸:</span>
                                <span class="stat-value">1024×1024</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">模型:</span>
                                <span class="stat-value">FLUX.1 Krea</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">步数:</span>
                                <span class="stat-value">4</span>
                            </div>
                        </div>
                    </div>
                `;

                // 添加生成历史
                this.addToHistory(result.image, currentPrompt, timestamp, creditsUsed);

                // 滚动到结果区域
                setTimeout(() => {
                    resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }

            // 添加到生成历史
            addToHistory(imageUrl, prompt, timestamp, creditsUsed) {
                try {
                    let history = JSON.parse(localStorage.getItem('generation_history') || '[]');

                    // 添加新记录
                    history.unshift({
                        id: Date.now(),
                        imageUrl,
                        prompt,
                        timestamp,
                        creditsUsed
                    });

                    // 只保留最近20条记录
                    history = history.slice(0, 20);

                    localStorage.setItem('generation_history', JSON.stringify(history));
                    console.log('✅ 已添加到生成历史');
                } catch (error) {
                    console.error('❌ 添加生成历史失败:', error);
                }
            }

            // 显示生成历史
            showHistory() {
                try {
                    const history = JSON.parse(localStorage.getItem('generation_history') || '[]');
                    if (history.length === 0) {
                        alert('暂无生成历史');
                        return;
                    }

                    const historyHtml = history.map(item => `
                        <div class="history-item">
                            <img src="${item.imageUrl}" alt="历史图片" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                            <div class="history-info">
                                <div class="history-prompt">${item.prompt.substring(0, 50)}${item.prompt.length > 50 ? '...' : ''}</div>
                                <div class="history-meta">${item.timestamp} | 消耗积分: ${item.creditsUsed}</div>
                                <div class="history-actions">
                                    <button onclick="downloadImage('${item.imageUrl}', '${item.prompt}')">下载</button>
                                    <button onclick="usePrompt('${item.prompt}')">使用提示词</button>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // 创建历史弹窗
                    const modal = document.createElement('div');
                    modal.className = 'history-modal';
                    modal.innerHTML = `
                        <div class="history-modal-content">
                            <div class="history-modal-header">
                                <h3>生成历史</h3>
                                <button onclick="this.closest('.history-modal').remove()">×</button>
                            </div>
                            <div class="history-modal-body">
                                ${historyHtml}
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                } catch (error) {
                    console.error('❌ 显示生成历史失败:', error);
                    alert('显示历史失败');
                }
            }

            // 显示错误
            showError(error) {
                const resultArea = document.getElementById('resultArea');
                if (resultArea) {
                    resultArea.innerHTML = `<div style="color: red;">生成失败: ${error.message}</div>`;
                }
            }

            // 主要的生成方法
            async generate() {
                console.log('=== 🎯 开始图像生成 ===');

                // 1. 检查是否可以生成
                if (!this.canGenerate()) return;

                // 2. 验证输入
                const prompt = this.validateInput();
                if (!prompt) return;

                // 3. 检查用户状态和积分
                const { canProceed } = this.checkUserAndCredits();
                if (!canProceed) return;

                try {
                    // 4. 设置生成状态
                    this.setGeneratingState(true);

                    // 5. 调用API
                    console.log('🚀 开始调用API...');
                    const result = await this.callGenerateAPI(prompt);

                    if (result.success && result.image) {
                        // 6. 扣除积分
                        console.log('🔄 开始扣除积分...');
                        const success = await window.UnifiedStateSync.deductCredits(this.generationCost);

                        if (success) {
                            const remainingCredits = window.UnifiedStateSync.getCredits();
                            console.log('✅ 积分扣除成功，剩余积分:', remainingCredits);

                            // 7. 显示结果（包含积分信息）
                            this.displayResult(result, this.generationCost, remainingCredits);
                        } else {
                            // 积分扣除失败，但图片已生成，这是一个严重问题
                            console.error('❌ 严重错误：图片生成成功但积分扣除失败');

                            // 显示警告信息
                            this.showError(new Error('图片生成成功，但积分扣除失败。请联系客服处理。'));

                            // 仍然显示生成的图片，但标记为异常
                            this.displayResult(result, 0, window.UnifiedStateSync.getCredits(), true);
                        }
                    } else {
                        throw new Error(result.error || '生成失败');
                    }

                } catch (error) {
                    console.error('❌ 图像生成失败:', error);
                    this.showError(error);
                } finally {
                    // 8. 恢复状态
                    this.setGeneratingState(false);
                }
            }
        };

        // 创建全局ImageGenerator实例
        window.imageGenerator = new window.ImageGenerator();

        // 全局辅助函数
        window.toggleFullscreen = function (imageId) {
            const img = document.getElementById(imageId);
            if (img) {
                img.classList.toggle('fullscreen');
            }
        };

        window.copyImageUrl = function (imageUrl) {
            navigator.clipboard.writeText(imageUrl).then(() => {
                alert('图片链接已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制链接');
            });
        };

        window.shareImage = function (imageUrl, prompt) {
            if (navigator.share) {
                navigator.share({
                    title: 'AI生成的图片',
                    text: `提示词: ${prompt}`,
                    url: imageUrl
                }).catch(err => console.log('分享失败:', err));
            } else {
                // 降级方案：复制链接
                window.copyImageUrl(imageUrl);
            }
        };

        window.regenerateWithSamePrompt = function () {
            if (window.imageGenerator) {
                window.imageGenerator.generate();
            }
        };

        window.downloadImage = function (imageUrl, prompt = '') {
            try {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `flux-krea-${Date.now()}.png`;

                // 添加提示词到文件名
                if (prompt) {
                    const cleanPrompt = prompt.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_').substring(0, 30);
                    link.download = `flux-krea-${cleanPrompt}-${Date.now()}.png`;
                }

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('✅ 图片下载已开始');
            } catch (error) {
                console.error('❌ 下载失败:', error);
                alert('下载失败，请右键图片另存为');
            }
        };

        window.usePrompt = function (prompt) {
            const promptInput = document.getElementById('prompt');
            if (promptInput) {
                promptInput.value = prompt;
                promptInput.focus();

                // 关闭历史弹窗
                const modal = document.querySelector('.history-modal');
                if (modal) {
                    modal.remove();
                }
            }
        };

        window.showGenerationHistory = function () {
            if (window.imageGenerator) {
                window.imageGenerator.showHistory();
            }
        };

        window.clearPrompt = function () {
            const promptInput = document.getElementById('prompt');
            if (promptInput) {
                if (promptInput.value.trim() && !confirm('确定要清空当前提示词吗？')) {
                    return;
                }
                promptInput.value = '';
                promptInput.focus();
            }
        };

        window.randomPrompt = function () {
            const randomPrompts = [
                'a beautiful landscape with mountains and lake, golden hour lighting, artistic style',
                'photorealistic portrait of a person with detailed skin texture, dynamic camera angle',
                'a futuristic cityscape at golden hour, high definition, cinematic lighting',
                'artistic portrait with exceptional detail and aesthetic composition, professional quality',
                'tech illustration showing modern design, clean style, minimalist',
                'photorealistic nature scene with incredible detail, professional photography style',
                'abstract art with vibrant colors and flowing shapes, modern artistic style',
                'cozy interior design with warm lighting, Scandinavian style, minimalist',
                'fantasy landscape with magical elements, ethereal lighting, concept art style',
                'vintage car in urban setting, moody lighting, cinematic photography'
            ];

            const promptInput = document.getElementById('prompt');
            if (promptInput) {
                const randomIndex = Math.floor(Math.random() * randomPrompts.length);
                promptInput.value = randomPrompts[randomIndex];
                promptInput.focus();

                // 添加打字机效果
                const originalValue = promptInput.value;
                promptInput.value = '';
                let i = 0;
                const typeWriter = setInterval(() => {
                    promptInput.value += originalValue.charAt(i);
                    i++;
                    if (i >= originalValue.length) {
                        clearInterval(typeWriter);
                    }
                }, 50);
            }
        };

        // 页面加载时检查是否有待生成的提示词
        document.addEventListener('DOMContentLoaded', function () {
            const pendingPrompt = localStorage.getItem('pending_generation_prompt');
            if (pendingPrompt) {
                const promptInput = document.getElementById('prompt');
                if (promptInput) {
                    promptInput.value = pendingPrompt;
                    console.log('✅ 已恢复待生成的提示词:', pendingPrompt);

                    // 清除存储的提示词
                    localStorage.removeItem('pending_generation_prompt');

                    // 显示提示
                    setTimeout(() => {
                        if (confirm('Detected a previous generation task interrupted due to insufficient credits.\n\nWould you like to continue generating now?')) {
                            window.imageGenerator.generate();
                        }
                    }, 1000);
                }
            }
        });

        // 创建统一的积分管理器
        window.CreditsManager = class {
            constructor() {
                this.credits = 0;
                this.listeners = [];
            }

            setCredits(amount) {
                const oldCredits = this.credits;
                this.credits = Math.max(0, amount);

                // 更新UI显示
                this.updateDisplay();

                // 通知监听器
                this.notifyListeners(oldCredits, this.credits);

                console.log(`✅ 积分已更新: ${oldCredits} → ${this.credits}`);
            }

            updateDisplay() {
                const creditsElement = document.getElementById('creditsAmount');
                if (creditsElement) {
                    creditsElement.textContent = this.credits;

                    // 添加更新动画效果
                    creditsElement.style.transition = 'all 0.3s ease';
                    creditsElement.style.color = '#10b981';
                    setTimeout(() => {
                        creditsElement.style.color = '';
                    }, 500);
                }
            }

            addListener(callback) {
                this.listeners.push(callback);
            }

            notifyListeners(oldCredits, newCredits) {
                this.listeners.forEach(callback => {
                    try {
                        callback(oldCredits, newCredits);
                    } catch (error) {
                        console.error('❌ 积分监听器执行失败:', error);
                    }
                });
            }

            async deductCredits(amount, reason = '消费') {
                if (this.credits >= amount) {
                    this.setCredits(this.credits - amount);
                    console.log(`💰 积分扣除: ${amount} (${reason})`);

                    // 同步到用户数据
                    if (window.currentUser) {
                        window.currentUser.credits = this.credits;
                        localStorage.setItem('flux_krea_user', JSON.stringify(window.currentUser));
                    }

                    return true;
                } else {
                    console.warn(`❌ Insufficient credits: need ${amount}, current ${this.credits}`);
                    return false;
                }
            }
        };

        // 初始化积分管理器
        window.creditsSync = new window.CreditsManager();

        // 全局UI更新防抖器
        let uiUpdateTimeout = null;
        let lastUIState = null;

        // 积分显示修复函数 - 增强版（带防抖）
        window.updateCreditsDisplay = function () {
            // 防抖机制，避免频繁更新
            if (uiUpdateTimeout) {
                clearTimeout(uiUpdateTimeout);
            }

            uiUpdateTimeout = setTimeout(() => {
                _doUpdateCreditsDisplay();
            }, 100); // 100ms防抖
        };

        function _doUpdateCreditsDisplay() {
            const creditsElement = document.getElementById('creditsAmount');
            if (!creditsElement) {
                console.error('❌ 找不到积分显示元素');
                return;
            }

            // 尝试多个数据源获取积分
            let credits = 0;
            let source = 'unknown';

            // 数据源1: window.currentUser
            if (window.currentUser && typeof window.currentUser.credits === 'number') {
                credits = window.currentUser.credits;
                source = 'window.currentUser';
            }
            // 数据源2: window.creditsSync
            else if (window.creditsSync && typeof window.creditsSync.credits === 'number') {
                credits = window.creditsSync.credits;
                source = 'window.creditsSync';
            }
            // 数据源3: localStorage
            else {
                try {
                    const userData = localStorage.getItem('flux_krea_user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        if (typeof user.credits === 'number') {
                            credits = user.credits;
                            source = 'localStorage';
                        }
                    }
                } catch (e) {
                    console.error('❌ 解析localStorage用户数据失败:', e);
                }
            }

            // 检查是否需要更新UI（避免不必要的DOM操作）
            const currentUIState = {
                credits: credits,
                hasUser: !!window.currentUser,
                userEmail: window.currentUser?.email || null
            };

            // 如果状态没有变化，跳过更新
            if (lastUIState &&
                lastUIState.credits === currentUIState.credits &&
                lastUIState.hasUser === currentUIState.hasUser &&
                lastUIState.userEmail === currentUIState.userEmail) {
                return; // 状态未变化，跳过更新
            }

            // 更新积分显示
            const displayCredits = window.currentUser ? credits : 20; // 未登录显示20
            if (creditsElement.textContent !== displayCredits.toString()) {
                creditsElement.textContent = displayCredits.toString();
            }

            // 同步到积分管理器
            if (window.creditsSync && window.creditsSync.credits !== credits) {
                window.creditsSync.setCredits(credits);
            }

            // 保存当前状态
            lastUIState = currentUIState;

            console.log(`✅ 积分显示已更新: ${displayCredits} (来源: ${source})`);
        }

        // 强化积分同步机制
        document.addEventListener('DOMContentLoaded', function () {
            console.log('📄 页面加载完成，开始积分同步...');

            // 强制初始化基本功能
            setTimeout(() => {
                window.forceInitialize();
            }, 100);

            // 延迟更新积分显示，避免页面加载时的闪烁
            setTimeout(() => {
                updateCreditsDisplay();
            }, 200);

            // 设置跨页面状态同步
            setupCrossPageSync();

            // 多次尝试从API获取积分，确保同步成功
            const syncAttempts = [500, 1000, 2000, 3000, 5000]; // 0.5s, 1s, 2s, 3s, 5s

            syncAttempts.forEach((delay, index) => {
                setTimeout(function () {
                    console.log(`🔄 第${index + 1}次积分同步尝试 (${delay}ms后)...`);

                    // 检查是否有用户数据
                    const hasUser = window.currentUser || localStorage.getItem('flux_krea_user');

                    if (hasUser) {
                        console.log('✅ 发现用户数据，开始从API获取积分...');
                        fetchCreditsFromAPI();
                    } else {
                        console.log('⚠️ 暂未发现用户数据，跳过此次同步');
                        updateCreditsDisplay(); // 仍然尝试更新显示
                    }
                }, delay);
            });

            // 每30秒定期同步积分
            setInterval(function () {
                if (window.currentUser || localStorage.getItem('flux_krea_user')) {
                    console.log('⏰ 定期积分同步...');
                    fetchCreditsFromAPI();
                }
            }, 30000);

            // 调试：确认函数已定义
            console.log('🔧 调试信息:');
            console.log('generateImage函数是否存在:', typeof window.generateImage);
            console.log('updateCreditsDisplay函数是否存在:', typeof window.updateCreditsDisplay);
            console.log('downloadImage函数是否存在:', typeof window.downloadImage);
            console.log('fetchCreditsFromAPI函数是否存在:', typeof window.fetchCreditsFromAPI);

            // Generate按钮已通过onclick属性绑定，无需重复绑定
            console.log('✅ Generate按钮通过onclick属性绑定');
        });

        // 下载图片函数
        window.downloadImage = function (imageUrl) {
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = 'generated-image.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // 从API获取积分的函数
        window.fetchCreditsFromAPI = async function () {
            try {
                console.log('🔄 从API获取积分...');

                // 获取用户标识
                let userIdentifier = null;
                if (window.currentUser && window.currentUser.uuid) {
                    userIdentifier = window.currentUser.uuid;
                } else if (window.currentUser && window.currentUser.email) {
                    userIdentifier = window.currentUser.email;
                } else {
                    const userData = localStorage.getItem('flux_krea_user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        userIdentifier = user.uuid || user.email;
                    }
                }

                if (!userIdentifier) {
                    console.error('❌ 无法获取用户标识');
                    return;
                }

                console.log('🔍 使用用户标识:', userIdentifier);

                const response = await fetch('/api/get-user-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userIdentifier: userIdentifier
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('📡 API响应:', data);

                    if (data.success) {
                        console.log('✅ API返回积分:', data.credits);

                        // 更新所有数据源
                        if (window.currentUser) {
                            window.currentUser.credits = data.credits;
                        }

                        // 使用新的积分管理器
                        if (window.creditsSync) {
                            window.creditsSync.setCredits(data.credits);
                        }

                        // 更新localStorage
                        const userData = localStorage.getItem('flux_krea_user');
                        if (userData) {
                            const user = JSON.parse(userData);
                            user.credits = data.credits;
                            localStorage.setItem('flux_krea_user', JSON.stringify(user));
                        }

                        // 确保显示更新
                        updateCreditsDisplay();
                        return data.credits;
                    } else {
                        console.error('❌ API返回错误:', data);
                    }
                } else {
                    console.error('❌ API请求失败:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('❌ 获取积分失败:', error);
            }
        }

        // 调试函数 - 可以在控制台手动调用
        window.testGenerate = function () {
            console.log('🧪 测试Generate函数...');
            if (typeof window.generateImage === 'function') {
                console.log('✅ generateImage函数存在，开始调用...');
                window.generateImage();
            } else {
                console.error('❌ generateImage函数不存在');
            }
        }

        // 手动刷新积分的调试函数
        window.refreshCredits = function () {
            console.log('🔄 手动刷新积分...');
            fetchCreditsFromAPI();
        }

        // 积分管理器测试函数
        window.testCreditsManager = function () {
            console.log('🧪 测试积分管理器...');
            console.log('- creditsSync对象:', window.creditsSync);
            console.log('- 当前积分:', window.creditsSync?.credits);
            console.log('- creditsAmount元素:', document.getElementById('creditsAmount'));
            console.log('- currentUser:', window.currentUser);

            // 测试设置积分
            if (window.creditsSync) {
                console.log('🔧 测试设置积分为100...');
                window.creditsSync.setCredits(100);
            }
        }

        // 修复用户状态同步的函数
        window.fixUserState = function () {
            console.log('🔧 修复用户状态同步...');

            // 尝试从localStorage恢复用户状态
            try {
                const userData = localStorage.getItem('flux_krea_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    window.currentUser = user;
                    console.log('✅ 从localStorage恢复用户状态:', user.email);

                    // 同步积分
                    if (window.creditsSync && user.credits !== undefined) {
                        window.creditsSync.setCredits(user.credits);
                    }

                    return true;
                }
            } catch (error) {
                console.error('❌ 恢复用户状态失败:', error);
            }

            // 如果没有用户数据，创建匿名用户
            console.log('⚠️ 未找到用户数据，创建匿名用户状态');
            window.currentUser = {
                uuid: 'anonymous-' + Date.now(),
                email: 'anonymous@example.com',
                credits: 20,
                is_anonymous: true
            };

            if (window.creditsSync) {
                window.creditsSync.setCredits(20);
            }

            return false;
        }

        // 强制初始化函数 - 确保基本功能可用
        window.forceInitialize = function () {
            console.log('🚀 强制初始化页面功能...');

            // 1. 修复用户状态
            window.fixUserState();

            // 2. 确保积分管理器存在
            if (!window.creditsSync) {
                window.creditsSync = new window.CreditsManager();
                console.log('✅ 创建积分管理器');
            }

            // 3. Generate按钮已通过onclick属性绑定，无需重复绑定
            console.log('✅ Generate按钮已通过onclick绑定');

            // 4. 更新积分显示
            if (window.updateCreditsDisplay) {
                window.updateCreditsDisplay();
            }

            console.log('✅ 强制初始化完成');
        }

        // 旧的generateImage代码已移除，现在使用ImageGenerator类

        // 旧代码已清理

        // 积分检查逻辑已移至ImageGenerator类

        // 输入验证逻辑已移至ImageGenerator类

        // DOM操作逻辑已移至ImageGenerator类

        // 旧的generateImage代码已完全清理

        // 积分系统和用户管理 - Supabase集成
        const SUPABASE_URL = 'https://gdcjvqaqgvcxzufmessy.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkY2p2cWFxZ3ZjeHp1Zm1lc3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMDY2NTEsImV4cCI6MjA2OTc4MjY1MX0.wIblNpUZLgQcCJCVbKfae5n0jtcIshL9asVIit6iUBI'

        // 初始化Supabase客户端
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });

        // 全局变量
        let currentUser = null;
        let systemSettings = {};

        // 加载系统配置
        async function loadSystemSettings() {
            try {
                const { data, error } = await supabaseClient
                    .from('system_settings')
                    .select('key, value, data_type')
                    .eq('is_public', true);

                if (error) throw error;

                // 转换为对象格式
                data.forEach(setting => {
                    let value = setting.value;
                    if (setting.data_type === 'integer') {
                        value = parseInt(value);
                    } else if (setting.data_type === 'boolean') {
                        value = value === 'true';
                    }
                    systemSettings[setting.key] = value;
                });

                console.log('系统配置加载成功:', systemSettings);
            } catch (error) {
                console.error('加载系统配置失败:', error);
                // 使用默认值
                systemSettings = {
                    default_credits: 20,
                    generation_cost: 10,
                    daily_free_credits: 5,
                    max_daily_generations: 10,
                    maintenance_mode: false,
                    welcome_message: 'Welcome to Flux Krea AI!'
                };
            }
        }

        /* DISABLED: Legacy UserManager (replaced by supabase-init + auth-bootstrap)
        class UserManager {
            constructor() {
                this.currentUser = window.preloadedUser || null;
                this.isInitialized = false;
            }
            
            // 初始化用户管理器
            async initialize() {
                if (this.isInitialized) return;
                
                try {
                    console.log('🔍 初始化用户管理器...');
                    
                    // 如果有预加载的用户，先使用预加载数据
                    if (window.preloadedUser) {
                        this.currentUser = window.preloadedUser;
                        currentUser = this.currentUser;
                        
                        // 异步验证和更新用户状态
                        this.validateAndUpdateUser();
                    } else {
                        // 检查Supabase会话
                        const isLoggedIn = await checkSupabaseSession();
                        
                        if (isLoggedIn && currentUser) {
                            await this.handleAuthenticatedUser(currentUser);
                        } else {
                            await this.handleAnonymousUser();
                        }
                    }
                    
                    this.isInitialized = true;
                    console.log('✅ 用户管理器初始化完成');
                } catch (error) {
                    console.error('❌ 用户管理器初始化失败:', error);
                    await this.handleAnonymousUser();
                }
            }
            
            // 异步验证和更新用户状态
            async validateAndUpdateUser() {
                try {
                    if (!this.currentUser || !this.currentUser.uuid) return;
                    
                    console.log('🔄 验证用户状态...');
                    
                    // 检查Supabase会话是否有效
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    
                    if (session && session.user) {
                        // 从数据库获取最新用户信息
                        const { data: latestUser, error } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('uuid', this.currentUser.uuid)
                            .single();
                        
                        if (!error && latestUser) {
                            // 更新用户信息
                            this.currentUser = { ...this.currentUser, ...latestUser };
                            currentUser = this.currentUser;
                            
                            // 更新localStorage
                            localStorage.setItem('flux_krea_user', JSON.stringify(this.currentUser));
                            
                            // 更新积分显示
                            if (window.creditsSync) {
                                window.creditsSync.setCredits(latestUser.credits || 0);
                            }
                            
                            console.log('✅ 用户状态已更新:', latestUser.credits);
                        }
                    } else {
                        // 会话无效，清除用户状态
                        console.log('⚠️ 会话无效，清除用户状态');
                        this.currentUser = null;
                        currentUser = null;
                        localStorage.removeItem('flux_krea_user');
                        await this.handleAnonymousUser();
                    }
                } catch (error) {
                    console.error('❌ 验证用户状态失败:', error);
                }
            }
            
            // 其他方法保持不变...
            async handleAuthenticatedUser(authUser) {
                // 原有逻辑保持不变
                console.log('处理已认证用户:', authUser);
                this.currentUser = authUser;
                currentUser = this.currentUser;
                this.updateUIForAuthenticatedUser();
            }
            
            async handleAnonymousUser() {
                // 原有逻辑保持不变
                console.log('处理匿名用户');
                this.currentUser = null;
                currentUser = null;
                this.updateUIForAnonymousUser();
            }
            
            updateUIForAuthenticatedUser() {
                const signinBtn = document.querySelector('.signin-btn');
                const creditsDisplay = document.getElementById('creditsDisplay');
                
                if (signinBtn && this.currentUser) {
                    signinBtn.innerHTML = `
                        <img src="${this.currentUser.avatar_url || 'https://via.placeholder.com/18'}" 
                             style="width: 18px; height: 18px; border-radius: 50%;" alt="Avatar">
                    `;
                    signinBtn.style.display = 'flex';
                }
                
                if (creditsDisplay) {
                    creditsDisplay.style.display = 'flex';
                }
            }
            
            updateUIForAnonymousUser() {
                const signinBtn = document.querySelector('.signin-btn');
                const creditsDisplay = document.getElementById('creditsDisplay');
                
                if (signinBtn) {
                    signinBtn.innerHTML = `
                        <div class="google-icon"></div>
                        <span>Sign in</span>
                    `;
                    signinBtn.style.display = 'flex';
                }
                
                if (creditsDisplay) {
                    creditsDisplay.style.display = 'flex';
                }
            }
        }
            
            /* LEGACY USER MANAGER DISABLED
            async initialize() {
                if (this.isInitialized) return;
                
                try {
                    // 检查现有会话
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        await this.handleAuthenticatedUser(session.user);
                    } else {
                        await this.handleAnonymousUser();
                    }
                    
                    this.isInitialized = true;
                    console.log('用户管理器初始化完成');
                } catch (error) {
                    console.error('用户管理器初始化失败:', error);
                    // 降级到本地存储模式
                    await this.handleAnonymousUser();
                }
            }
            
            // 处理已认证用户
            async handleAuthenticatedUser(authUser) {
                try {
                    console.log('处理已认证用户:', authUser);
                    
                    // 以Google ID为主要标识查找用户
                    let { data: user, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('google_id', authUser.id)
                        .single();
                    
                    if (error && error.code === 'PGRST116') {
                        // 用户不存在，检查是否有匿名用户需要升级
                        const anonymousUuid = getUserUUID();
                        
                        // 查找匹配的匿名用户（通过指纹或UUID）
                        const fingerprint = generateUserFingerprint();
                        let { data: anonymousUser, error: anonError } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('fingerprint', fingerprint)
                            .eq('is_signed_in', false)
                            .single();
                        
                        if (anonError && anonError.code === 'PGRST116') {
                            // 通过UUID查找
                            const { data: uuidUser, error: uuidError } = await supabaseClient
                                .from('users')
                                .select('*')
                                .eq('uuid', anonymousUuid)
                                .eq('is_signed_in', false)
                                .single();
                            
                            if (!uuidError) {
                                anonymousUser = uuidUser;
                            }
                        }
                        
                        if (anonymousUser) {
                            // 升级现有匿名用户为认证用户
                            console.log('升级匿名用户为认证用户:', anonymousUser.uuid);
                            const { data: upgradedUser, error: upgradeError } = await supabaseClient
                                .from('users')
                                .update({
                                    is_signed_in: true,
                                    google_id: authUser.id,
                                    email: authUser.email,
                                    name: authUser.user_metadata?.full_name || authUser.email,
                                    avatar_url: authUser.user_metadata?.avatar_url,
                                    last_seen_at: new Date().toISOString()
                                })
                                .eq('id', anonymousUser.id)
                                .select()
                                .single();
                                
                            if (upgradeError) throw upgradeError;
                            user = upgradedUser;
                            
                            console.log('匿名用户升级成功，保留原有积分:', user.credits);
                        } else {
                            // 创建新的认证用户
                            console.log('创建新的认证用户');
                            user = await this.createUserRecord(authUser);
                        }
                    } else if (error) {
                        throw error;
                    } else {
                        // 用户存在，更新最后访问时间
                        console.log('已存在认证用户，更新访问时间');
                        await supabaseClient
                            .from('users')
                            .update({ 
                                last_seen_at: new Date().toISOString(),
                                name: authUser.user_metadata?.full_name || user.name,
                                avatar_url: authUser.user_metadata?.avatar_url || user.avatar_url
                            })
                            .eq('id', user.id);
                    }
                    
                    this.currentUser = { ...user, ...authUser.user_metadata };
                    currentUser = this.currentUser;
                    
                    // 同步用户状态到其他页面
                    if (window.userStateSync) {
                        window.userStateSync.setCurrentUser(this.currentUser);
                    }
                    
                    this.updateUIForAuthenticatedUser();
                    
                    // 立即同步积分显示
                    if (window.creditsSync && this.currentUser.credits !== undefined) {
                        window.creditsSync.setCredits(this.currentUser.credits);
                        console.log('✅ 登录后积分已同步:', this.currentUser.credits);
                    }
                    
                    // 从API获取最新积分
                    setTimeout(() => {
                        if (window.fetchCreditsFromAPI) {
                            window.fetchCreditsFromAPI();
                        }
                    }, 500);
                    
                    console.log('用户认证完成:', this.currentUser);
                    
                } catch (error) {
                    console.error('处理认证用户失败:', error);
                    await this.handleAnonymousUser();
                }
            }
            
            // 处理匿名用户
            async handleAnonymousUser() {
                const uuid = getUserUUID();
                const fingerprint = generateUserFingerprint();
                const ip = await getUserIP();
                const userIdentifier = await generateUserIdentifier();
                
                try {
                    // 设置匿名用户上下文
                    await supabaseClient.rpc('set_user_context', { user_uuid: uuid });
                    
                    // 🔒 关键防刷逻辑：优先通过指纹查找现有用户
                    console.log('🔍 开始用户查找 - 防刷检查:', {
                        fingerprint: fingerprint.substring(0, 20) + '...',
                        uuid: uuid,
                        ip: ip
                    });
                    
                    let user = null;
                    
                    // 第一步：通过指纹查找（最重要的防刷手段）
                    let { data: fingerprintUsers, error: fingerprintError } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('fingerprint', fingerprint)
                        .eq('is_signed_in', false);
                    
                    if (!fingerprintError && fingerprintUsers && fingerprintUsers.length > 0) {
                        user = fingerprintUsers[0];
                        console.log('🔒 通过指纹找到现有用户 - 防止积分重置:', {
                            uuid: user.uuid,
                            fingerprint: user.fingerprint.substring(0, 20) + '...',
                            credits: user.credits,
                            totalEarned: user.total_credits_earned,
                            createdAt: user.created_at,
                            lastSeen: user.last_seen_at
                        });
                        
                        console.log('💰 指纹匹配 - 保持积分状态:', user.credits, '(不重新分配20积分)');
                        
                    } else {
                        // 第二步：如果指纹没找到，尝试UUID查找
                        let { data: uuidUsers, error: uuidError } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('uuid', uuid)
                            .eq('is_signed_in', false);
                        
                        if (!uuidError && uuidUsers && uuidUsers.length > 0) {
                            user = uuidUsers[0];
                            console.log('🆔 通过UUID找到现有用户:', {
                                uuid: user.uuid,
                                credits: user.credits,
                                fingerprint: user.fingerprint?.substring(0, 20) + '...' || 'none'
                            });
                        }
                    }
                    
                    if (user) {
                        // 找到现有用户，更新信息但保持积分不变
                        console.log('✅ 现有用户 - 更新信息但保持积分:', user.credits);
                        
                        await supabaseClient
                            .from('users')
                            .update({
                                uuid: uuid,
                                user_identifier: userIdentifier,
                                fingerprint: fingerprint,
                                ip_address: ip,
                                last_seen_at: new Date().toISOString()
                                // 🔒 关键：不更新credits字段，保持原有积分状态
                            })
                            .eq('id', user.id);
                        
                        // 更新本地UUID
                        localStorage.setItem('user_uuid', user.uuid);
                        
                    } else {
                        // 没有找到匹配用户，检查是否是真正的新用户
                        console.log('未找到现有用户，检查是否为新用户...');
                    
                        // 创建新的匿名用户记录
                        console.log('创建新匿名用户:', { uuid, fingerprint, ip });
                        const { data: newUser, error: createError } = await supabaseClient
                            .from('users')
                            .insert({
                                uuid: uuid,
                                user_identifier: userIdentifier,
                                fingerprint: fingerprint,
                                ip_address: ip,
                                user_agent: navigator.userAgent,
                                language: navigator.language,
                                platform: navigator.platform,
                                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                                screen_resolution: `${screen.width}x${screen.height}`,
                                credits: systemSettings.default_credits || 20,
                                total_credits_earned: systemSettings.default_credits || 20,
                                is_signed_in: false
                            })
                            .select()
                            .single();
                        
                        if (createError) {
                            console.error('创建用户失败:', createError);
                            throw createError;
                        }
                        user = newUser;
                        
                        // 记录初始积分
                        await this.addCreditTransaction(user.id, uuid, 'EARN', systemSettings.default_credits || 20, 
                            '新用户奖励', 'anonymous_bonus');
                    }
                    
                    if (user) {
                        // 更新最后访问时间
                        await supabaseClient
                            .from('users')
                            .update({ last_seen_at: new Date().toISOString() })
                            .eq('id', user.id);
                    }
                    
                    this.currentUser = user;
                    currentUser = this.currentUser;
                    
                    // 同步用户状态到其他页面
                    if (window.userStateSync) {
                        window.userStateSync.setCurrentUser(this.currentUser);
                    }
                    
                    this.updateUIForAnonymousUser();
                    
                } catch (error) {
                    console.error('处理匿名用户失败，使用本地模式:', error);
                    this.handleLocalMode();
                }
            }
            
            // 本地存储模式（数据库不可用时的降级方案）
            handleLocalMode() {
                const uuid = getUserUUID();
                const credits = parseInt(localStorage.getItem('user_credits')) || systemSettings.default_credits || 20;
                
                this.currentUser = {
                    uuid: uuid,
                    credits: credits,
                    is_local_mode: true
                };
                currentUser = this.currentUser;
                
                // 同步用户状态到其他页面
                if (window.userStateSync) {
                    window.userStateSync.setCurrentUser(this.currentUser);
                }
                
                console.log('使用本地存储模式');
                this.updateUIForAnonymousUser();
            }
            
            
            // 创建用户记录（以Google ID为主要标识）
            async createUserRecord(authUser, existingUuid = null) {
                const userUuid = existingUuid || getUserUUID();
                const fingerprint = generateUserFingerprint();
                const ip = await getUserIP();
                const userIdentifier = await generateUserIdentifier();
                
                const userData = {
                    uuid: userUuid,
                    google_id: authUser.id,
                    email: authUser.email,
                    name: authUser.user_metadata?.full_name || authUser.email,
                    avatar_url: authUser.user_metadata?.avatar_url,
                    user_identifier: userIdentifier,
                    fingerprint: fingerprint,
                    ip_address: ip,
                    user_agent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    credits: systemSettings.default_credits || 20,
                    total_credits_earned: systemSettings.default_credits || 20,
                    is_signed_in: true
                };
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert(userData)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // 强制确保积分设置为20（防止数据库默认值问题）
                const { error: creditsError } = await supabaseClient
                    .from('users')
                    .update({ 
                        credits: 20, 
                        total_credits_earned: 20 
                    })
                    .eq('id', data.id);
                
                if (creditsError) {
                    console.error('❌ 强制设置积分失败:', creditsError);
                } else {
                    console.log('✅ 强制设置积分成功: 20');
                }
                
                // 记录初始积分
                await this.addCreditTransaction(
                    data.id, 
                    userUuid, 
                    'EARN', 
                    systemSettings.default_credits || 20, 
                    '新用户注册奖励', 
                    'signup_bonus'
                );
                
                // 立即同步到前端状态
                if (window.UnifiedStateSync) {
                    window.UnifiedStateSync.setCredits(20);
                    console.log('✅ 前端积分状态已同步: 20');
                }
                
                // 确保返回的数据包含正确的积分
                data.credits = 20;
                data.total_credits_earned = 20;
                
                return data;
            }
            
            // 更新认证用户界面
            updateUIForAuthenticatedUser() {
                const signinBtn = document.querySelector('.signin-btn');
                if (signinBtn && this.currentUser) {
                    signinBtn.innerHTML = `
                        <img src="${this.currentUser.avatar_url || 'https://via.placeholder.com/32'}" 
                             alt="User Avatar" class="user-avatar">
                    `;
                    // signinBtn.onclick = () => this.showUserMenu(); // 已禁用，使用统一的handleSignInClick
                    signinBtn.style.padding = '4px';
                    signinBtn.style.border = 'none';
                    signinBtn.style.boxShadow = 'none';
                    signinBtn.style.background = 'transparent';
                }
                
                // 检查是否为管理员账户，显示调试按钮
                this.checkAndShowDebugButton();
            }
            
            // 更新匿名用户界面
            updateUIForAnonymousUser() {
                const signinBtn = document.querySelector('.signin-btn');
                if (signinBtn) {
                    signinBtn.innerHTML = `
                        <div class="google-icon"></div>
                        <span>Sign in</span>
                    `;
                    // signinBtn.onclick = () => this.signInWithGoogle(); // 已禁用，使用统一的handleSignInClick
                }
                
                // 隐藏调试按钮（匿名用户）
                const debugBtn = document.getElementById('debugRefreshBtn');
                if (debugBtn) {
                    debugBtn.style.display = 'none';
                }
            }
            
            // 检查管理员权限并显示调试按钮
            checkAndShowDebugButton() {
                const debugBtn = document.getElementById('debugRefreshBtn');
                if (debugBtn && this.currentUser) {
                    // 仅对特定邮箱显示调试按钮
                    const adminEmails = ['sunwei7482@gmail.com'];
                    const userEmail = this.currentUser.email;
                    
                    if (adminEmails.includes(userEmail)) {
                        debugBtn.style.display = 'inline-block';
                        console.log('🔧 管理员调试模式已启用:', userEmail);
                    } else {
                        debugBtn.style.display = 'none';
                    }
                } else if (debugBtn) {
                    debugBtn.style.display = 'none';
                }
            }
            
            // 显示用户菜单
            showUserMenu() {
                showSignoutModal();
            }
            
            // Google登录
            async signInWithGoogle() {
                try {
                    console.log('开始Google登录...');
                    
                    const { data, error } = await supabaseClient.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: `${window.location.origin}`,
                            queryParams: {
                                access_type: 'offline',
                                prompt: 'consent',
                            },
                        }
                    });
                    
                    if (error) {
                        console.error('Google登录错误:', error);
                        throw error;
                    }
                    
                    console.log('Google登录成功:', data);
                } catch (error) {
                    console.error('Google登录失败:', error);
                    
                    if (error.message && error.message.includes('provider is not enabled')) {
                        alert('请检查Supabase中的Google OAuth配置：\n1. Authentication > Providers > Google\n2. 确保"Enable sign in with Google"已开启\n3. 检查Client ID和Client Secret是否正确填入');
                    } else {
                        alert('登录失败，请稍后重试：' + (error.message || error));
                    }
                }
            }
            
            // 退出登录
            async signOut() {
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    
                    // 重新初始化为匿名用户
                    await this.handleAnonymousUser();
                } catch (error) {
                    console.error('退出登录失败:', error);
                }
            }
            
            // 添加积分交易记录
            async addCreditTransaction(userId, userUuid, type, amount, description, source, relatedResourceId = null) {
                try {
                    const balanceAfter = this.currentUser.credits + (type === 'EARN' ? amount : -amount);
                    
                    const { error } = await supabaseClient
                        .from('credit_transactions')
                        .insert({
                            user_id: userId,
                            user_uuid: userUuid,
                            transaction_type: type,
                            amount: type === 'EARN' ? amount : -amount,
                            balance_after: balanceAfter,
                            description: description,
                            source: source,
                            related_resource_id: relatedResourceId
                        });
                    
                    if (error) throw error;
                } catch (error) {
                    console.error('添加积分交易记录失败:', error);
                }
            }
        }
        */
        // LEGACY BLOCK ENDS

        // 检查是否为管理员用户
        function isAdminUser() {
            const adminEmails = ['sunwei7482@gmail.com'];
            return currentUser && currentUser.email && adminEmails.includes(currentUser.email);
        }

        // 生成用户指纹（增强版，包含更多设备特征）
        function generateUserFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('User fingerprint', 2, 2);

            const fingerprint = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages ? navigator.languages.join(',') : '',
                platform: navigator.platform,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                screen: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                pixelDepth: screen.pixelDepth,
                deviceMemory: navigator.deviceMemory || 'unknown',
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack || 'unknown',
                canvas: canvas.toDataURL(),
                webgl: getWebGLFingerprint()
            };

            return btoa(JSON.stringify(fingerprint)).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
        }

        // 获取WebGL指纹
        function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'no-webgl';

                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                const vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown';
                const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';

                return `${vendor}_${renderer}`.substring(0, 50);
            } catch (e) {
                return 'webgl-error';
            }
        }

        // 获取或创建用户 UUID
        function getUserUUID() {
            let uuid = localStorage.getItem('user_uuid');
            if (!uuid) {
                uuid = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('user_uuid', uuid);
            }
            return uuid;
        }

        // 获取用户 IP
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('无法获取IP地址');
                return 'unknown';
            }
        }

        // 生成唯一用户标识
        async function generateUserIdentifier() {
            const uuid = getUserUUID();
            const fingerprint = generateUserFingerprint();
            const ip = await getUserIP();

            return `${uuid}_${fingerprint}_${ip}`.replace(/[^a-zA-Z0-9_]/g, '');
        }

        /* DISABLED: Legacy CreditsManager (replaced by UnifiedStateSync)
         * This class was using the disabled UserManager and has been replaced
         * by the UnifiedStateSync module which handles both user and credits management.
         */


        // 初始化系统 - 现在使用UnifiedStateSync
        console.log('✅ 系统将使用UnifiedStateSync进行状态管理');

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // 检查是否是首次访问，如果是则跳转到showcase
                const hasVisitedBefore = localStorage.getItem('flux_krea_visited');
                const urlParams = new URLSearchParams(window.location.search);
                const skipShowcase = urlParams.get('skip_showcase') === 'true';

                // 如果不是首次访问或者URL中有跳过showcase的参数，则正常初始化
                if (hasVisitedBefore || skipShowcase || window.location.hash) {
                    await normalPageInitialization();
                } else {
                    // 首次访问，标记已访问并跳转到showcase
                    localStorage.setItem('flux_krea_visited', 'true');

                    // 延迟跳转，让页面稍微加载一下
                    setTimeout(() => {
                        window.location.href = 'showcase.html';
                    }, 500);
                    return;
                }

            } catch (error) {
                console.error('页面初始化失败:', error);
                // 发生错误时也进行正常初始化
                await normalPageInitialization();
            }
        });

        // 正常页面初始化逻辑
        async function normalPageInitialization() {
            try {
                // 显示加载状态
                const creditsElement = document.getElementById('creditsAmount');
                if (creditsElement) {
                    creditsElement.textContent = '--';
                }

                // 1. 加载系统配置
                await loadSystemSettings();

                // 2. 使用统一状态管理器（UnifiedStateSync已自动初始化）
                console.log('✅ 使用UnifiedStateSync作为统一状态管理器');

                // 等待UnifiedStateSync初始化完成
                if (window.UnifiedStateSync && !window.UnifiedStateSync.isInitialized) {
                    await window.UnifiedStateSync.initialize();
                }

                // 3. 设置兼容性引用
                window.currentUser = window.UnifiedStateSync?.getCurrentUser() || null;
                console.log('✅ 当前用户状态:', window.currentUser?.email || '未登录');

                // 4. 初始化其他功能
                // (已移除showcase初始化，因为现在使用独立页面)

                // 5. UnifiedStateSync已经处理认证状态变化，这里只处理特殊逻辑
                // 增强的登录成功处理
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('🔐 认证状态变化:', event, session?.user?.email);

                    if (event === 'SIGNED_IN' && session) {
                        // 确保积分同步
                        setTimeout(async () => {
                            const credits = await window.UnifiedStateSync.syncCreditsFromAPI();
                            if (credits !== null) {
                                console.log('✅ 登录后积分同步成功:', credits);
                            } else {
                                console.log('⚠️ 登录后积分同步失败，使用默认值');
                                // 如果同步失败，确保至少有基础积分
                                if (window.UnifiedStateSync.getCredits() === 0) {
                                    window.UnifiedStateSync.setCredits(20);
                                }
                            }
                        }, 1000);
                        
                        // 检查是否需要跳转到pricing页面
                        const redirectTarget = localStorage.getItem('redirect_after_signin');
                        if (redirectTarget === 'pricing') {
                            localStorage.removeItem('redirect_after_signin');

                            // 显示加载提示，然后跳转
                            showLoadingModal('正在跳转到定价页面...');
                            setTimeout(() => {
                                window.location.href = 'pricing.html';
                            }, 1000);
                        }
                    }
                });

                console.log('系统初始化完成');
            } catch (error) {
                console.error('❌ 系统初始化失败:', error);

                // 降级到本地模式 - 使用UnifiedStateSync的降级处理
                console.log('🔄 启用降级模式...');

                // 确保基本的用户状态可用
                if (!window.currentUser) {
                    window.currentUser = null;
                }

                // 确保积分显示函数可用
                if (typeof window.updateCreditsDisplay === 'function') {
                    window.updateCreditsDisplay();
                }
            }
        }

        // 图像生成功能 - 完全使用模拟模式
        // Login Modal Functions
        function showLoginModal() {
            const modal = document.getElementById('loginRequiredModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginRequiredModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }



        // 辅助函数
        function downloadImage(imageUrl, filename) {
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function shareImage(imageUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Flux Krea AI生成的图像',
                    url: imageUrl
                });
            } else {
                navigator.clipboard.writeText(imageUrl).then(() => {
                    alert('图像链接已复制到剪贴板');
                }).catch(() => {
                    alert('无法复制链接：' + imageUrl);
                });
            }
        }

        function scrollToGenerator() {
            document.getElementById('generator').scrollIntoView({ behavior: 'smooth' });
        }

        // Demo generation function
        function demoGenerate(demoPrompt) {
            document.getElementById('prompt').value = demoPrompt;
            document.getElementById('prompt').scrollIntoView({ behavior: 'smooth' });
        }

        // 滑块更新事件监听器
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化滑块事件
            const stepsSlider = document.getElementById('stepsSlider');
            if (stepsSlider) {
                stepsSlider.addEventListener('input', function () {
                    document.getElementById('stepsValue').textContent = this.value;
                });
            }
        });

        // 显示认证弹窗（未登录用户点击生成时）- 保持兼容性
        function showAuthenticationModal() {
            window.showCreditsModal();
        }

        // 处理登录按钮点击（统一使用 UnifiedStateSync）
        async function handleSignInClick() {
            try {
                if (!window.UnifiedStateSync) {
                    throw new Error('统一状态同步器未加载');
                }

                // 检查当前用户状态，决定是登录还是登出
                const currentUser = window.UnifiedStateSync.getCurrentUser();

                if (currentUser) {
                    // 已登录，执行登出
                    console.log('🔓 开始登出...');
                    await window.UnifiedStateSync.signOut();
                    console.log('✅ 登出成功');
                } else {
                    // 未登录，执行登录
                    console.log('🔐 开始Google登录...');
                    await window.UnifiedStateSync.signIn();
                    console.log('✅ 登录流程已启动');
                }
            } catch (error) {
                console.error('❌ 登录/登出操作失败:', error);
                alert('操作失败: ' + error.message);
            }
        }

        // 设置跨页面状态同步
        function setupCrossPageSync() {
            // 监听localStorage变化（跨页面同步）
            window.addEventListener('storage', function (e) {
                if (e.key === 'flux_krea_state_change') {
                    console.log('🔄 检测到跨页面状态变化，重新同步...');

                    // 重新加载用户数据
                    const userData = localStorage.getItem('flux_krea_user');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            console.log('📥 从localStorage同步用户数据:', user);

                            // 更新全局用户状态
                            window.currentUser = user;

                            // 更新统一状态管理器
                            if (window.UnifiedStateSync) {
                                window.UnifiedStateSync.updateUserData(user);
                            }

                            // 更新积分管理器
                            if (window.creditsSync) {
                                window.creditsSync.setCredits(user.credits || 0);
                            }

                            // 更新积分显示
                            if (window.updateCreditsDisplay) {
                                window.updateCreditsDisplay();
                            }

                            console.log('✅ 跨页面状态同步完成，新积分:', user.credits);
                        } catch (error) {
                            console.error('❌ 跨页面状态同步失败:', error);
                        }
                    }
                }
            });

            // 监听自定义事件（同页面内同步）
            window.addEventListener('userStateUpdated', function (e) {
                console.log('🔄 检测到用户状态更新事件:', e.detail);

                if (e.detail.user) {
                    // 更新全局用户状态
                    window.currentUser = e.detail.user;

                    // 更新统一状态管理器
                    if (window.UnifiedStateSync) {
                        window.UnifiedStateSync.updateUserData(e.detail.user);
                    }

                    // 更新积分管理器
                    if (window.creditsSync) {
                        window.creditsSync.setCredits(e.detail.user.credits || 0);
                    }
                }

                // 更新积分显示
                if (window.updateCreditsDisplay) {
                    window.updateCreditsDisplay();
                }

                console.log('✅ 用户状态更新完成');
            });

            console.log('✅ 跨页面状态同步监听器已设置');
        }
    
        // 管理员功能：重置用户积分
        window.resetUserCredits = async function(userEmail, newCredits = 20) {
            if (!window.UnifiedStateSync || !window.UnifiedStateSync.getCurrentUser()) {
                console.error('❌ 用户未登录，无法执行重置操作');
                return false;
            }

            const currentUser = window.UnifiedStateSync.getCurrentUser();
            
            // 简单的管理员检查（实际应用中应该有更严格的权限控制）
            const adminEmails = ['admin@example.com', 'test@example.com'];
            if (!adminEmails.includes(currentUser.email)) {
                console.error('❌ 权限不足，无法执行重置操作');
                return false;
            }

            try {
                console.log(`🔧 开始重置用户积分: ${userEmail} -> ${newCredits}`);
                
                // 如果是重置当前用户的积分
                if (userEmail === currentUser.email) {
                    const success = await window.UnifiedStateSync.addCredits(
                        newCredits - window.UnifiedStateSync.getCredits(), 
                        '管理员重置积分'
                    );
                    
                    if (success) {
                        console.log(`✅ 积分重置成功: ${userEmail} -> ${newCredits}`);
                        alert(`Credits reset successful! Current credits: ${window.UnifiedStateSync.getCredits()}`);
                        return true;
                    } else {
                        console.error('❌ 积分重置失败');
                        alert('积分重置失败，请检查控制台日志');
                        return false;
                    }
                } else {
                    // 重置其他用户的积分需要后端API支持
                    console.log('⚠️ 重置其他用户积分需要后端API支持');
                    alert('重置其他用户积分功能暂未实现');
                    return false;
                }
                
            } catch (error) {
                console.error('❌ 重置积分时发生错误:', error);
                alert('重置积分失败: ' + error.message);
                return false;
            }
        };

        
        // 用户下拉菜单功能
        let isDropdownOpen = false;

        // 切换下拉菜单显示
        window.toggleUserDropdown = function() {
            const dropdown = document.getElementById('userDropdown');
            const signinBtn = document.querySelector('.signin-btn');
            
            if (!dropdown || !signinBtn) return;

            isDropdownOpen = !isDropdownOpen;
            
            if (isDropdownOpen) {
                dropdown.style.display = 'block';
                updateDropdownUserInfo();
                
                // 点击外部关闭下拉菜单
                setTimeout(() => {
                    document.addEventListener('click', closeDropdownOnClickOutside);
                }, 100);
            } else {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        };

        // 点击外部关闭下拉菜单
        function closeDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('userDropdown');
            const signinBtn = document.querySelector('.signin-btn');
            
            if (!dropdown.contains(event.target) && !signinBtn.contains(event.target)) {
                dropdown.style.display = 'none';
                isDropdownOpen = false;
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }

        // 更新下拉菜单用户信息
        function updateDropdownUserInfo() {
            const currentUser = window.UnifiedStateSync?.getCurrentUser();
            if (!currentUser) return;

            // 更新头像
            const avatarImg = document.getElementById('dropdownUserAvatar');
            if (avatarImg) {
                avatarImg.src = currentUser.avatar_url || 'https://via.placeholder.com/48';
            }

            // 更新用户名
            const username = document.getElementById('dropdownUsername');
            if (username) {
                username.textContent = currentUser.name || currentUser.email?.split('@')[0] || 'User';
            }

            // 更新用户等级
            const userLevel = document.getElementById('dropdownUserLevel');
            if (userLevel) {
                // 这里可以根据实际的会员状态来判断
                const level = currentUser.subscription_status === 'active' ? 
                    (currentUser.plan_type === 'pro' ? 'Pro' : 'Max') : 'Free';
                userLevel.textContent = `Level: ${level}`;
            }

            // 更新有效期
            const validTime = document.getElementById('dropdownValidTime');
            if (validTime) {
                if (currentUser.subscription_status === 'active' && currentUser.subscription_end_date) {
                    const endDate = new Date(currentUser.subscription_end_date);
                    validTime.textContent = `Valid time: ${endDate.toLocaleDateString()}`;
                } else {
                    validTime.textContent = 'Valid time: --';
                }
            }
        }

        // 处理登出
        window.handleSignOut = async function() {
            try {
                console.log('🚪 开始登出...');
                
                // 关闭下拉菜单
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                    isDropdownOpen = false;
                }

                // 使用UnifiedStateSync登出
                if (window.UnifiedStateSync) {
                    await window.UnifiedStateSync.signOut();
                }

                console.log('✅ 登出成功');
                
                // 刷新页面以重置状态
                setTimeout(() => {
                    window.location.reload();
                }, 500);
                
            } catch (error) {
                console.error('❌ 登出失败:', error);
                alert('登出失败，请刷新页面重试');
            }
        };

        </script>

    <!-- 积分弹窗 -->
    <div id="creditsModal" class="credits-modal">
        <div class="credits-modal-content">
            <div class="credits-modal-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h3 id="creditsModalTitle">Insufficient Credits</h3>
            <p id="creditsModalContent">You don't have enough credits to generate images.</p>
            <div class="credits-modal-actions">
                <button class="credits-modal-btn primary" onclick="window.location.href='pricing.html'">
                    <i class="fas fa-arrow-up"></i>
                    Upgrade Now
                </button>
                <button class="credits-modal-btn secondary" onclick="closeCreditsModal()">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
        </div>
    </div>
</body>

</html>