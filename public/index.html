<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>Flux Krea AI - Free AI Image Generator, Fast HD Art Creation</title>
    <meta name="description"
        content="Create stunning AI images from text prompts powered by Flux.1 Krea dev Model, No-Signup,High-Quality, Realistic 4K art creation and maker in secongs.">
    <meta name="keywords"
        content="Flux Krea,AI image generator,Free AI art generator, Text to image, Free image generator, Professional AI images, FLUX.1 Krea,Free Image Generation, AI Art Creation">
    <meta name="author" content="FLUX Krea AI">
    <meta name="robots" content="index, follow">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Flux Krea AI - Free AI Image Generator, Fast HD Art Creation">
    <meta property="og:description"
        content="Create stunning, professional-quality images from text prompts using advanced FLUX AI technology. Generate images in seconds with superior quality and control.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://flux-krea-ai.com">
    <meta property="og:image" content="https://flux-krea-ai.com/og-image.jpg">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Flux Krea AI - Free AI Image Generator, Fast HD Art Creation">
    <meta name="twitter:description"
        content="Generate high-quality AI images instantly with FLUX Krea AI. Professional results in seconds.">
    <meta name="twitter:image" content="https://flux-krea-ai.com/twitter-image.jpg">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://flux-krea-ai.com">

    <!-- Favicon -->
    <link rel="icon" type="image/png"
        href="https://ciwjjfcuhubjydajazkk.supabase.co/storage/v1/object/public/webstie-icon//FluxKrea%20log-120.png">
    <link rel="apple-touch-icon"
        href="https://ciwjjfcuhubjydajazkk.supabase.co/storage/v1/object/public/webstie-icon//FluxKrea%20log-120.png">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HRV45ZRFKT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-HRV45ZRFKT');
    </script>

    <!-- æ ¸å¿ƒå‡½æ•°å®šä¹‰ - å¿…é¡»åœ¨é¡µé¢æœ€æ—©åŠ è½½ -->
    <script>
        // ç«‹å³å®šä¹‰generateImageå‡½æ•°ï¼Œç¡®ä¿å…¨å±€å¯è®¿é—®
        // é‡æ„åçš„generateImageå‡½æ•°ï¼Œä½¿ç”¨ImageGeneratorç±»
        window.generateImage = async function () {
            console.log('âœ… generateImageå‡½æ•°è¢«æ­£ç¡®è°ƒç”¨ï¼');

            // ä½¿ç”¨ImageGeneratorç±»å¤„ç†ç”Ÿæˆé€»è¾‘
            if (window.imageGenerator) {
                await window.imageGenerator.generate();
            } else {
                console.error('âŒ ImageGeneratoræœªåˆå§‹åŒ–');
                alert('ç³»ç»Ÿåˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨åé‡è¯•');
            }
        };

        // æµ‹è¯•ç”Ÿå›¾APIå‡½æ•°
        window.testGenerateAPI = async function () {
            console.log('ğŸ”§ æµ‹è¯•ç”Ÿå›¾API...');
            const prompt = document.getElementById('prompt')?.value?.trim() || 'æµ‹è¯•æç¤ºè¯';

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        width: 1024,
                        height: 1024,
                        steps: 4
                    })
                });

                const result = await response.json();
                console.log('ğŸ¯ APIå“åº”:', result);
                alert('ç”Ÿå›¾APIæµ‹è¯•æˆåŠŸï¼æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…ã€‚');
            } catch (error) {
                console.error('âŒ ç”Ÿå›¾APIæµ‹è¯•å¤±è´¥:', error);
                if (error.message.includes('Unexpected token')) {
                    alert(`âš ï¸ ç”Ÿå›¾APIæ— æ³•å·¥ä½œ:\n\n` +
                        `åŸå› : å½“å‰ä½¿ç”¨Pythoné™æ€æœåŠ¡å™¨\n\n` +
                        `éœ€è¦åˆ‡æ¢åˆ°Vercelå¼€å‘æœåŠ¡å™¨:\n` +
                        `1. åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)\n` +
                        `2. è¿è¡Œ: vercel dev\n` +
                        `3. è®¿é—®: http://localhost:3000`);
                } else {
                    alert('ç”Ÿå›¾APIæµ‹è¯•å¤±è´¥: ' + error.message);
                }
            }
        };

        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å‡½æ•°ï¼ˆè°ƒè¯•ç”¨ï¼‰
        window.checkUserState = function () {
            const currentUser = window.currentUser || window.UserStateManager?.currentUser;
            const localStorageUser = localStorage.getItem('flux_krea_user');

            console.log('=== ç”¨æˆ·çŠ¶æ€æ£€æŸ¥ ===');
            console.log('window.currentUser:', currentUser);
            console.log('UserStateManager.currentUser:', window.UserStateManager?.currentUser);
            console.log('localStorageç”¨æˆ·æ•°æ®:', localStorageUser);

            if (localStorageUser) {
                try {
                    const parsedUser = JSON.parse(localStorageUser);
                    console.log('è§£æåçš„localStorageç”¨æˆ·:', parsedUser);
                } catch (e) {
                    console.error('localStorageç”¨æˆ·æ•°æ®è§£æå¤±è´¥:', e);
                }
            }

            alert(`ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚\n\nå½“å‰ç”¨æˆ·: ${currentUser ? currentUser.email : 'æœªç™»å½•'}\nç§¯åˆ†: ${currentUser ? currentUser.credits : 'æœªçŸ¥'}`);
        };

        // ç®€å•çš„æµ‹è¯•å‡½æ•°
        window.testClick = function () {
            alert('æŒ‰é’®ç‚¹å‡»æµ‹è¯•æˆåŠŸï¼');
            console.log('âœ… æŒ‰é’®ç‚¹å‡»äº‹ä»¶æ­£å¸¸å·¥ä½œ');
        };

        // æ˜¾ç¤ºç§¯åˆ†å¼¹çª—ï¼ˆç»Ÿä¸€å‡½æ•°ï¼‰- ç§»åˆ°é¡µé¢é¡¶éƒ¨ç¡®ä¿æ—©æœŸåŠ è½½
        window.showCreditsModal = function (currentCredits = null, requiredCredits = 10) {
            const modal = document.getElementById('creditsModal');
            const title = document.getElementById('creditsModalTitle');
            const content = document.getElementById('creditsModalContent');

            if (!modal || !title || !content) {
                console.error('âŒ Modal elements not found');
                return;
            }

            // è·å–æŒ‰é’®å…ƒç´ 
            const primaryBtn = modal.querySelector('.credits-modal-btn.primary');
            const primaryBtnSpan = primaryBtn?.querySelector('span');
            
            if (currentCredits === null) {
                // Not logged in user - emphasize first login bonus of 20 credits
                title.textContent = 'ğŸ Get Free Credits';
                content.innerHTML = `
                    <div style="text-align: center; line-height: 1.6;">
                        <p style="margin: 0 0 10px 0; font-size: 16px; color: #333;">
                            <strong>Get 20 free credits on your first login!</strong>
                        </p>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            Sign in with your Gmail account and start creating AI images
                        </p>
                    </div>
                `;
                
                // è®¾ç½®ä¸ºç™»å½•æŒ‰é’®
                if (primaryBtn && primaryBtnSpan) {
                    primaryBtn.onclick = () => signInFromModal();
                    primaryBtnSpan.textContent = 'Sign in';
                }
                console.log('ğŸ“± Showing not logged in modal - emphasizing first login 20 credits bonus');
            } else if (currentCredits === 0) {
                // Logged in user with 0 credits
                title.textContent = 'ğŸ’³ Insufficient Credits';
                content.innerHTML = `
                    <div style="text-align: center; line-height: 1.6;">
                        <p style="margin: 0 0 10px 0; font-size: 16px; color: #333;">
                            You have run out of credits
                        </p>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            Generating one image requires 10 credits. Please purchase more credits to continue creating
                        </p>
                    </div>
                `;
                
                // è®¾ç½®ä¸ºè´­ä¹°æŒ‰é’®ï¼Œè·³è½¬åˆ°Pricingé¡µé¢
                if (primaryBtn && primaryBtnSpan) {
                    // ä¿®æ”¹å›¾æ ‡ä¸ºçš‡å† 
                    const iconElement = primaryBtn.querySelector('.google-icon') || primaryBtn.querySelector('i');
                    if (iconElement) {
                        iconElement.className = 'fas fa-crown';
                    }
                    primaryBtn.onclick = () => {
                        closeCreditsModal();
                        window.location.href = 'pricing.html';
                    };
                    primaryBtnSpan.textContent = 'Purchase Premium';
                }
                console.log('ğŸ“± Showing 0 credits modal');
            } else {
                // Logged in but insufficient credits (not 0)
                title.textContent = 'ğŸ’³ Insufficient Credits';
                content.innerHTML = `
                    <div style="text-align: center; line-height: 1.6;">
                        <p style="margin: 0 0 10px 0; font-size: 16px; color: #333;">
                            Current credits: <strong>${currentCredits}</strong>
                        </p>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            Generating images requires <strong>${requiredCredits}</strong> credits. Please purchase more credits
                        </p>
                    </div>
                `;
                
                // è®¾ç½®ä¸ºè´­ä¹°æŒ‰é’®ï¼Œè·³è½¬åˆ°Pricingé¡µé¢
                if (primaryBtn && primaryBtnSpan) {
                    // ä¿®æ”¹å›¾æ ‡ä¸ºçš‡å† 
                    const iconElement = primaryBtn.querySelector('.google-icon') || primaryBtn.querySelector('i');
                    if (iconElement) {
                        iconElement.className = 'fas fa-crown';
                    }
                    primaryBtn.onclick = () => {
                        closeCreditsModal();
                        window.location.href = 'pricing.html';
                    };
                    primaryBtnSpan.textContent = 'Purchase Premium';
                }
                console.log(`ğŸ“± Showing insufficient credits modal: ${currentCredits}/${requiredCredits}`);
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        // å…³é—­ç§¯åˆ†å¼¹çª—
        window.closeCreditsModal = function () {
            const modal = document.getElementById('creditsModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                console.log('ğŸ“± å¼¹çª—å·²å…³é—­');
            }
        };

        // ä»å¼¹çª—ç™»å½•
        window.signInFromModal = async function () {
            try {
                console.log('ğŸ” ä»å¼¹çª—å¼€å§‹Googleç™»å½•...');

                // ç›´æ¥ç‚¹å‡»é¡µé¢ä¸Šçš„ç™»å½•æŒ‰é’®
                const signinBtn = document.querySelector('.signin-btn');
                if (signinBtn) {
                    signinBtn.click();
                    window.closeCreditsModal(); // å…³é—­å¼¹çª—
                } else {
                    throw new Error('æ‰¾ä¸åˆ°ç™»å½•æŒ‰é’®');
                }
            } catch (error) {
                console.error('âŒ Googleç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            }
        };

        // è°ƒè¯•GenerateæŒ‰é’®
        window.debugGenerate = function () {
            console.log('ğŸ”§ è°ƒè¯•GenerateæŒ‰é’®...');
            console.log('- currentUser:', window.currentUser);
            console.log('- generateImageå‡½æ•°:', typeof window.generateImage);
            console.log('- showCreditsModalå‡½æ•°:', typeof window.showCreditsModal);

            // å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—æµ‹è¯•
            if (typeof window.showCreditsModal === 'function') {
                console.log('âœ… å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—æµ‹è¯•');
                window.showCreditsModal();
            } else {
                console.error('âŒ showCreditsModalå‡½æ•°æœªå®šä¹‰');
            }
        };

        // è°ƒè¯•å‡½æ•°å·²åˆ é™¤ï¼Œä½¿ç”¨çœŸæ­£çš„generateImageå‡½æ•°

        console.log('âœ… generateImageå‡½æ•°å·²å®šä¹‰åœ¨é¡µé¢é¡¶éƒ¨');
        console.log('ğŸ”§ ç‰ˆæœ¬æ—¶é—´æˆ³:', new Date().toISOString());

        // ç«‹å³åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€ç®¡ç†å™¨
        (function () {
            console.log('ğŸš€ ç«‹å³åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€ç®¡ç†å™¨...');

            // å¦‚æœé¡µé¢å·²åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initUserState);
            } else {
                initUserState();
            }

            function initUserState() {
                if (window.UserStateManager) {
                    window.UserStateManager.initialize();
                    console.log('âœ… ç”¨æˆ·çŠ¶æ€ç®¡ç†å™¨å·²åˆå§‹åŒ–');
                }
            }
        })();

        // ç»Ÿä¸€çš„ç”¨æˆ·çŠ¶æ€ç®¡ç†å™¨
        window.UserStateManager = {
            currentUser: null,

            // åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€
            async initialize() {
                console.log('ğŸ”§ åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€ç®¡ç†å™¨...');

                // ä»localStorageæ¢å¤ç”¨æˆ·çŠ¶æ€
                const savedUser = localStorage.getItem('flux_krea_user');
                if (savedUser) {
                    try {
                        this.currentUser = JSON.parse(savedUser);
                        window.currentUser = this.currentUser;
                        console.log('âœ… ä»localStorageæ¢å¤ç”¨æˆ·çŠ¶æ€:', this.currentUser.email);
                    } catch (error) {
                        console.error('âŒ è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                        localStorage.removeItem('flux_krea_user');
                    }
                }

                // æ›´æ–°UI
                this.updateUI();

                // å¦‚æœæœ‰ç”¨æˆ·ï¼ŒåŒæ­¥ç§¯åˆ†
                if (this.currentUser) {
                    await this.syncCredits();
                }
            },

            // è®¾ç½®ç”¨æˆ·çŠ¶æ€
            setUser(user) {
                this.currentUser = user;
                window.currentUser = user;

                if (user) {
                    localStorage.setItem('flux_krea_user', JSON.stringify(user));
                    console.log('âœ… ç”¨æˆ·çŠ¶æ€å·²ä¿å­˜:', user.email);
                } else {
                    localStorage.removeItem('flux_krea_user');
                    console.log('âœ… ç”¨æˆ·çŠ¶æ€å·²æ¸…é™¤');
                }

                this.updateUI();
                this.broadcastStateChange();
            },

            // æ›´æ–°UIæ˜¾ç¤ºï¼ˆåˆ†ç¦»ç™»å½•æŒ‰é’®å’Œç§¯åˆ†æ˜¾ç¤ºï¼‰
            updateUI() {
                // æ›´æ–°ç™»å½•æŒ‰é’®
                this.updateSignInButton();

                // ä½¿ç”¨å…¨å±€çš„updateCreditsDisplayï¼Œå®ƒå·²ç»æœ‰é˜²æŠ–æœºåˆ¶
                if (window.updateCreditsDisplay) {
                    window.updateCreditsDisplay();
                }
            },

            // æ›´æ–°ç™»å½•æŒ‰é’®æ˜¾ç¤ºï¼ˆåˆ†ç¦»å‡ºæ¥ï¼Œé¿å…ä¸ç§¯åˆ†æ˜¾ç¤ºå†²çªï¼‰
            updateSignInButton() {
                const signinBtn = document.querySelector('.signin-btn');
                if (!signinBtn) return;

                if (this.currentUser) {
                    // å·²ç™»å½•çŠ¶æ€ - åªæ˜¾ç¤ºå¤´åƒ
                    const newHTML = `
                        <img src="${this.currentUser.avatar_url || 'https://via.placeholder.com/24'}" 
                             alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%;">
                    `;
                    // åªæœ‰å†…å®¹ä¸åŒæ—¶æ‰æ›´æ–°
                    if (signinBtn.innerHTML.trim() !== newHTML.trim()) {
                        signinBtn.innerHTML = newHTML;
                        // ä¿æŒåŸæœ‰çš„onclickå±æ€§ï¼Œä¸è¦†ç›–
                        // signinBtn.onclick = () => this.signOut(); // å·²ç¦ç”¨ï¼Œä½¿ç”¨ç»Ÿä¸€çš„handleSignInClick
                    }
                } else {
                    // æœªç™»å½•çŠ¶æ€
                    const newHTML = `
                        <div class="google-icon"></div>
                        <span>Sign in</span>
                    `;
                    // åªæœ‰å†…å®¹ä¸åŒæ—¶æ‰æ›´æ–°
                    if (signinBtn.innerHTML.trim() !== newHTML.trim()) {
                        signinBtn.innerHTML = newHTML;
                        // ä¿æŒåŸæœ‰çš„onclick="handleSignInClick()"å±æ€§ï¼Œä¸è¦†ç›–
                        // signinBtn.onclick = () => this.signIn(); // å·²ç¦ç”¨ï¼Œä½¿ç”¨ç»Ÿä¸€çš„handleSignInClick
                    }
                }

                // ç¡®ä¿ç§¯åˆ†æ˜¾ç¤ºå¯è§
                const creditsDisplay = document.getElementById('creditsDisplay');
                if (creditsDisplay) {
                    creditsDisplay.style.display = 'flex';
                }
            },

            // Googleç™»å½• - å·²ç¦ç”¨ï¼Œä½¿ç”¨UnifiedStateSync
            async signIn() {
                console.log('âš ï¸ UserStateManager.signInå·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨handleSignInClick()');
                // é‡å®šå‘åˆ°ç»Ÿä¸€çš„ç™»å½•å¤„ç†
                if (typeof handleSignInClick === 'function') {
                    await handleSignInClick();
                }
            },

            // ç™»å‡º - å·²ç¦ç”¨ï¼Œä½¿ç”¨UnifiedStateSync
            async signOut() {
                console.log('âš ï¸ UserStateManager.signOutå·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨handleSignInClick()');
                // é‡å®šå‘åˆ°ç»Ÿä¸€çš„ç™»å½•å¤„ç†
                if (typeof handleSignInClick === 'function') {
                    await handleSignInClick();
                }
            },

            // åŒæ­¥ç§¯åˆ†
            async syncCredits() {
                if (!this.currentUser) return;

                try {
                    const response = await fetch('/api/get-user-credits', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.currentUser.access_token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.credits !== undefined) {
                            this.currentUser.credits = data.credits;
                            this.setUser(this.currentUser);
                            console.log('âœ… ç§¯åˆ†åŒæ­¥æˆåŠŸ:', data.credits);
                        }
                    }
                } catch (error) {
                    console.error('âŒ ç§¯åˆ†åŒæ­¥å¤±è´¥:', error);
                }
            },

            // æ‰£é™¤ç§¯åˆ†
            async deductCredits(amount) {
                if (!this.currentUser) return false;

                if (this.currentUser.credits < amount) {
                    return false;
                }

                // å…ˆæœ¬åœ°æ‰£é™¤
                this.currentUser.credits -= amount;
                this.setUser(this.currentUser);

                // ç„¶ååŒæ­¥åˆ°æœåŠ¡å™¨
                await this.syncCredits();

                return true;
            },

            // å¹¿æ’­çŠ¶æ€å˜åŒ–ï¼ˆç”¨äºè·¨é¡µé¢åŒæ­¥ï¼‰
            broadcastStateChange() {
                // è§¦å‘storageäº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é¡µé¢
                localStorage.setItem('flux_krea_state_change', Date.now().toString());

                // ä¹Ÿè§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                window.dispatchEvent(new CustomEvent('userStateChanged', {
                    detail: { user: this.currentUser }
                }));
            }
        };

        // ç›‘å¬è·¨é¡µé¢çŠ¶æ€åŒæ­¥
        window.addEventListener('storage', function (e) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°localStorageå˜åŒ–:', e.key);

            if (e.key === 'flux_krea_user') {
                // ç”¨æˆ·çŠ¶æ€å‘ç”Ÿå˜åŒ–
                console.log('ğŸ‘¤ ç”¨æˆ·çŠ¶æ€å˜åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–...');

                if (window.UserStateManager) {
                    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿æ•°æ®å·²å†™å…¥
                    setTimeout(() => {
                        window.UserStateManager.initialize();
                    }, 100);
                }
            } else if (e.key === 'flux_krea_state_change') {
                // å…¶ä»–é¡µé¢è§¦å‘çš„çŠ¶æ€å˜åŒ–
                console.log('ğŸ”„ å…¶ä»–é¡µé¢çŠ¶æ€å˜åŒ–ï¼ŒåŒæ­¥ä¸­...');

                if (window.UserStateManager) {
                    setTimeout(() => {
                        window.UserStateManager.initialize();
                    }, 100);
                }
            }
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢é‡æ–°å¯è§æ—¶åŒæ­¥çŠ¶æ€
        document.addEventListener('visibilitychange', function () {
            if (!document.hidden && window.UserStateManager) {
                console.log('ğŸ‘ï¸ é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥çŠ¶æ€åŒæ­¥...');
                setTimeout(() => {
                    window.UserStateManager.initialize();
                }, 200);
            }
        });

        // æµ‹è¯•APIé…ç½®å‡½æ•°
        window.testAPIConfig = async function () {
            console.log('ğŸ§ª æµ‹è¯•APIé…ç½®...');
            try {
                const response = await fetch('/api/test-config');
                const config = await response.json();
                console.log('ğŸ“‹ APIé…ç½®ä¿¡æ¯:', config);
                alert(`APIé…ç½®æ£€æŸ¥ç»“æœ:\n\n` +
                    `Replicate Token: ${config.hasReplicateToken ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n` +
                    `Tokené•¿åº¦: ${config.tokenLength}\n` +
                    `ç¯å¢ƒ: ${config.environment}\n` +
                    `æ—¶é—´: ${config.timestamp}`);
            } catch (error) {
                console.error('âŒ APIé…ç½®æ£€æŸ¥å¤±è´¥:', error);

                // æ£€æŸ¥æ˜¯å¦æ˜¯å› ä¸ºä½¿ç”¨äº†PythonæœåŠ¡å™¨
                if (error.message.includes('Unexpected token')) {
                    alert(`âš ï¸ æ£€æµ‹åˆ°é—®é¢˜:\n\n` +
                        `å½“å‰ä½¿ç”¨çš„æ˜¯Pythoné™æ€æœåŠ¡å™¨ï¼Œæ— æ³•è¿è¡ŒAPIã€‚\n\n` +
                        `è§£å†³æ–¹æ¡ˆ:\n` +
                        `1. åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)\n` +
                        `2. è¿è¡Œ: vercel dev\n` +
                        `3. è®¿é—®: http://localhost:3000\n\n` +
                        `è¿™æ ·APIåŠŸèƒ½æ‰èƒ½æ­£å¸¸å·¥ä½œï¼`);
                } else {
                    alert('APIé…ç½®æ£€æŸ¥å¤±è´¥: ' + error.message);
                }
            }
        };
        console.log('âœ… testClickæµ‹è¯•å‡½æ•°å·²å®šä¹‰');
    </script>

    <!-- Supabase SDK and init (must load before auth-bootstrap) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-init.js" defer></script>
    <!-- ç»Ÿä¸€çŠ¶æ€åŒæ­¥æ¨¡å— -->
    <script src="js/modules/unified-state-sync.js"></script>

    <!-- External Resources -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "FLUX Krea AI",
        "description": "Professional AI Image Generator powered by FLUX technology",
        "url": "https://flux-krea-ai.com",
        "applicationCategory": "DesignApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "FLUX Krea AI"
        }
    }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }

        /* Header Navigation */
        .header {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            padding: 16px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            color: #6366f1;
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: transparent;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            overflow: hidden;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-links {
            display: flex;
            gap: 32px;
            list-style: none;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #64748b;
            font-weight: 500;
            font-size: 16px;
            transition: color 0.2s;
        }

        .nav-links a.active {
            color: #6366f1;
            font-weight: 600;
        }

        .nav-links a:hover {
            color: #6366f1;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .credits-display {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .credits-display i {
            color: #ff8c00;
        }

        .signin-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            color: #3c4043;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .signin-btn:hover {
            background: #f8f9fa;
            border-color: #dadce0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .google-icon {
            width: 18px;
            height: 18px;
            background: url('https://www.gstatic.com/marketing-cms/assets/images/76/76/c79495454250aaacab1867bdcda4/about-10things-g.png') no-repeat center;
            background-size: contain;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 60px 32px 60px;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-badge {
            display: inline-block;
            background: #e0e7ff;
            color: #6366f1;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .hero-badges {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .badge.orange {
            background: #f97316;
        }

        .badge.green {
            background: #10b981;
        }

        .badge.blue {
            background: #3b82f6;
        }

        .badge.purple {
            background: #8b5cf6;
        }

        .hero h1 {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        .hero p {
            font-size: 16px;
            color: #64748b;
            margin: 0px 0px 0px;
            line-height: 1.6;
        }

        /* Main Generator */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            margin: 0px 0px 60px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-subtitle {
            color: #64748b;
            margin-bottom: 32px;
            font-size: 16px;
        }

        /* Generation Mode */
        .mode-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            width: 100%;
            justify-content: center;
        }

        .mode-btn {
            width: 100%;
            height: 57px;
            min-height: 57px;
            max-height: 57px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            position: relative;
            box-sizing: border-box;
            white-space: nowrap;
        }

        .mode-btn.active {
            border-color: #6366f1;
            background: #6366f1;
            color: white;
        }

        .mode-btn:hover:not(.active) {
            border-color: #6366f1;
            background: #f8faff;
        }

        .coming-soon {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f97316;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            text-transform: uppercase;
        }

        /* Prompt Input */
        .prompt-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #374151;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.2s;
            font-family: inherit;
            display: flex;
            align-items: center;
            vertical-align: middle;
        }

        .prompt-textarea::placeholder {
            color: rgba(100, 116, 139, 0.5);
            opacity: 1;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .copy-btn {
            margin-top: 12px;
            margin-right: 8px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #64748b;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #e2e8f0;
        }

        .clear-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #64748b;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .setting-item label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .setting-item select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .setting-item select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .slider-container {
            grid-column: span 2;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
        }

        .slider-value {
            float: right;
            font-weight: 600;
            color: #6366f1;
        }

        /* Result Display Styles */
        .result-success {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .result-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .result-title {
            color: #10b981;
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .result-meta {
            color: #6b7280;
            font-size: 14px;
        }

        .image-container {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }

        .generated-image {
            max-width: 100%;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .generated-image:hover {
            transform: scale(1.02);
        }

        .generated-image.fullscreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            z-index: 1000;
            max-width: 90vw;
            max-height: 90vh;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .image-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-container:hover .image-overlay {
            opacity: 1;
        }

        .overlay-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 16px;
        }

        .result-info {
            margin-bottom: 20px;
        }

        .prompt-info {
            margin-bottom: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
        }

        .prompt-text {
            color: #374151;
            font-style: italic;
        }

        .credits-info {
            text-align: center;
            margin-bottom: 12px;
        }

        .credits-text {
            color: #6b7280;
            font-size: 14px;
            background: #f0f9ff;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e0f2fe;
        }

        .error-warning {
            color: #f59e0b;
            background: #fef3c7;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #fde68a;
            text-align: center;
            margin-top: 12px;
        }

        .result-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn.primary {
            background: #6366f1;
            color: white;
        }

        .action-btn.primary:hover {
            background: #5856eb;
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: #f8fafc;
            color: #374151;
            border: 1px solid #e2e8f0;
        }

        .action-btn.secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .result-stats {
            display: flex;
            justify-content: space-around;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .stat-value {
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        /* History Modal Styles */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .history-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            max-height: 80vh;
            width: 90%;
            overflow: hidden;
        }

        .history-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .history-modal-header h3 {
            margin: 0;
            color: #374151;
        }

        .history-modal-header button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .history-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .history-info {
            flex: 1;
        }

        .history-prompt {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .history-meta {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .history-actions {
            display: flex;
            gap: 8px;
        }

        .history-actions button {
            padding: 6px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .history-actions button:hover {
            background: #f1f5f9;
        }

        /* Secondary Actions */
        .secondary-btn {
            padding: 8px 16px;
            background: #f8fafc;
            color: #374151;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .secondary-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Generate Button */
        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .generate-btn .btn-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .generate-btn .credits-cost {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 500;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* H5 Pricing Entry Button */
        .h5-pricing-btn {
            display: none;
            width: 100%;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            margin-top: 20px;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
        }

        .h5-pricing-btn:hover {
            background: linear-gradient(135deg, #f97316, #ea580c);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.4);
        }

        /* Result Section */
        .result-placeholder {
            text-align: center;
            padding: 80px 24px;
            color: #94a3b8;
        }

        .result-placeholder i {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .result-image {
            width: 100%;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .loading {
            text-align: center;
            padding: 80px 24px;
            color: #6366f1;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Error and Success States */
        .result-error {
            text-align: center;
            padding: 40px 24px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            color: #dc2626;
        }

        .result-error i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #f87171;
        }

        .result-error h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #dc2626;
        }

        .result-success {
            text-align: center;
            padding: 0px;
        }

        .generated-image {
            width: 100%;
            max-width: 512px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            margin-bottom: 20px;
        }

        .result-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .action-btn {
            padding: 8px 16px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: #5b5bd6;
            transform: translateY(-1px);
        }

        .generation-info {
            color: #64748b;
            font-size: 14px;
            margin: 8px 0;
        }

        .generating-status {
            text-align: center;
            padding: 60px 24px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .generating-status h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .generating-status p {
            color: #64748b;
            font-size: 14px;
        }

        /* Steps Section */
        .steps-section {
            background: white;
            padding: 60px 0;
        }

        .section-header {
            text-align: center;
            margin-bottom: 36px;
        }

        .section-header h2 {
            font-size: 40px;
            font-weight: 800;
            margin-bottom: 24px;
            color: #1a202c;
        }

        .section-header p {
            font-size: 20px;
            color: #64748b;
            max-width: 1120px;
            margin: 0 auto;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 48px;
        }

        .step-card {
            text-align: center;
            padding: 32px;
        }

        .step-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 32px;
        }

        .step-card h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1a202c;
        }

        .step-card p {
            color: #64748b;
            line-height: 1.6;
        }

        /* Features Section */
        .features-section {
            background: #f8fafc;
            padding: 60px 0;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 48px;
            margin-top: 80px;
        }

        .feature-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .feature-image {
            margin-bottom: 24px;
        }

        .feature-image img {
            width: 100%;
            border-radius: 12px;
        }

        .feature-card h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1a202c;
        }

        .feature-card p {
            color: #64748b;
            line-height: 1.6;
            margin-bottom: 24px;
            flex-grow: 1;
        }

        .demo-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 36px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 180px;
            justify-content: center;
            margin: 0 auto;
            align-self: flex-end;
        }

        .demo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        /* CTA Buttons */
        .cta-btn {
            display: inline-block;
            padding: 16px 32px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .cta-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .cta-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        /* Testimonials Section */
        .testimonials-section {
            background: white;
            padding: 60px 0;
        }

        .testimonials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
            margin-top: 80px;
        }

        .testimonial-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .stars {
            color: #fbbf24;
            margin-bottom: 24px;
            font-size: 18px;
        }

        .testimonial-card p {
            color: #374151;
            line-height: 1.6;
            margin-bottom: 24px;
            font-style: italic;
        }

        .testimonial-author {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .author-avatar {
            width: 48px;
            height: 48px;
            background: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .author-name {
            font-weight: 600;
            color: #1a202c;
        }

        .author-title {
            color: #64748b;
            font-size: 14px;
        }

        .stats {
            text-align: center;
            margin-top: 80px;
        }

        .stats-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 40px;
            font-weight: 800;
            color: #6366f1;
        }

        .stat-label {
            color: #64748b;
            font-size: 16px;
        }

        /* FAQ Section */
        .faq-section {
            background: #f8fafc;
            padding: 60px 0;
        }

        .faq-container {
            max-width: 800px;
            margin: 80px auto 0;
        }

        .faq-item {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .faq-question {
            padding: 24px 32px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .faq-question:hover {
            background: #f8fafc;
        }

        .faq-question h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        .faq-question i {
            color: #64748b;
            transition: transform 0.2s;
        }

        .faq-answer {
            padding: 0 32px 24px;
            display: none;
        }

        .faq-answer p {
            color: #64748b;
            line-height: 1.6;
            margin: 0;
        }

        .faq-item.active .faq-answer {
            display: block;
        }

        .faq-item.active .faq-question i {
            transform: rotate(180deg);
        }

        /* Footer */
        .footer {
            background: #1a202c;
            color: white;
            padding: 80px 0 32px;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 48px;
            margin-bottom: 48px;
        }

        .footer-logo {
            color: white;
            margin-bottom: 24px;
        }

        .footer-description {
            color: #94a3b8;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .social-links {
            display: flex;
            gap: 16px;
        }

        .social-links a {
            color: #94a3b8;
            font-size: 20px;
            transition: color 0.2s;
        }

        .social-links a:hover {
            color: #6366f1;
        }

        .footer-section h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .footer-links {
            list-style: none;
            padding: 0;
        }

        .footer-links li {
            margin-bottom: 12px;
        }

        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: white;
        }

        .footer-bottom {
            border-top: 1px solid #374151;
            padding-top: 32px;
            text-align: center;
            color: #94a3b8;
        }

        /* Responsive Design */
        @media (max-width: 768px) {

            /* H5ç«¯logoå­—å·è°ƒæ•´ */
            .logo {
                font-size: 16px;
            }

            /* H5ç«¯logoå›¾æ ‡å°ºå¯¸å’Œé—´è·è°ƒæ•´ */
            .logo-icon {
                width: 32px;
                height: 32px;
                margin-right: 6px;
            }

            /* ç§»åŠ¨ç«¯å¯¼èˆªæ æ ·å¼ */
            .nav {
                position: relative;
            }

            .nav-links {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                flex-direction: column;
                gap: 16px;
                padding: 24px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                transform: translateY(-100%);
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                border-radius: 0 0 12px 12px;
            }

            .nav-links.active {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
            }

            .nav-links li {
                width: 100%;
                text-align: center;
            }

            .nav-links a {
                display: block;
                padding: 12px 16px;
                border-radius: 8px;
                transition: background-color 0.2s;
            }

            .nav-links a:hover {
                background-color: rgba(99, 102, 241, 0.1);
            }

            /* æ±‰å ¡èœå•æŒ‰é’® */
            .hamburger-menu {
                display: flex;
                /* ç§»åŠ¨ç«¯æ˜¾ç¤º */
                flex-direction: column;
                gap: 3px;
                cursor: pointer;
                padding: 8px;
                border-radius: 6px;
                transition: background-color 0.2s;
            }

            .hamburger-menu:hover {
                background-color: rgba(0, 0, 0, 0.05);
            }

            .hamburger-menu span {
                width: 20px;
                height: 2px;
                background-color: #64748b;
                transition: all 0.3s ease;
            }

            .hamburger-menu.active span:nth-child(1) {
                transform: rotate(45deg) translate(5px, 5px);
            }

            .hamburger-menu.active span:nth-child(2) {
                opacity: 0;
            }

            .hamburger-menu.active span:nth-child(3) {
                transform: rotate(-45deg) translate(7px, -6px);
            }

            /* ç§»åŠ¨ç«¯ç™»å½•æŒ‰é’®æ ·å¼ */
            .signin-btn {
                display: flex !important;
                padding: 4px 6px;
                font-size: 12px;
            }

            /* ç§»åŠ¨ç«¯æ˜¾ç¤ºç§¯åˆ†æ˜¾ç¤º */
            .credits-display {
                display: flex !important;
            }

            .hero h1 {
                font-size: 32px;
            }

            .hero p {
                font-size: 18px;
            }

            .main-grid {
                grid-template-columns: 1fr;
                gap: 32px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .mode-buttons {
                flex-direction: column;
                align-items: center;
                width: 100%;
            }

            .mode-btn {
                width: 100% !important;
                max-width: 366px !important;
                height: 57px !important;
                font-size: 16px !important;
                padding: 6px 8px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                gap: 6px !important;
            }

            .section-header h2 {
                font-size: 32px;
            }

            .stats-grid {
                gap: 40px;
            }

            .h5-pricing-btn {
                display: flex;
            }
        }

        /* Loading Modal */
        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            max-width: 320px;
            width: 90%;
        }

        .loading-modal .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Insufficient Credits Modal */
        .credits-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .credits-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .credits-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .credits-modal.active .credits-modal-content {
            transform: scale(1);
        }

        .credits-modal-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 36px;
        }

        .credits-modal h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a202c;
        }

        .credits-modal p {
            color: #64748b;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .credits-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .credits-modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .credits-modal-btn.primary {
            background: #ffffff;
            border: 1px solid #dadce0;
            color: #3c4043;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .credits-modal-btn.primary:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .credits-modal-btn.secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .credits-modal-btn.secondary:hover {
            background: #e2e8f0;
        }

        .google-icon-modal {
            width: 18px;
            height: 18px;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE3LjY0IDkuMjA0NTVDMTcuNjQgOC41NjYzNiAxNy41ODM2IDcuOTUyNzMgMTcuNDggNy4zNjM2NEg5VjEwLjg0NTVIMTMuODQzNkMxMy42MzUgMTEuOTcgMTMuMDAwOSAxMi45MjMgMTIuMTEgMTMuNTYxNFYxNS44MTk1SDEzLjk1NjRDMTUuNjU3MyAxNC4yNTI3IDE2LjY0IDEyLjk0NTUgMTcuNjQgOS4yMDQ1NVoiIGZpbGw9IiM0Mjg1RjQiLz4KPHBhdGggZD0iTTkgMThDMTEuNDMgMTggMTMuNDY3MyAxNy4xOTQxIDE0Ljk1NjQgMTUuODE5NUwxMy4xMSAxMy41NjE0QzEyLjQyIDEzLjk5OTEgMTEuNTQgMTQuMjYxNCAxMC4wMzY0IDE0LjI2MTRDNy42NSAxNC4yNjE0IDUuNjcyNzMgMTMuNjA0MSA0LjM2NCA5LjI1SDE2LjI0NTVWNy4zNjM2NEgzLjI3VjE0LjI2MTRDMy4yNyAxNS4wODQxIDQuMDg2MzYgMTcuNjEzNiA5IDE4WiIgZmlsbD0iIzM0QTg1MyIvPgo8cGF0aCBkPSJNMy4zNjM2NCA5LjI3SDBWMTYuMjczNkMwIDExLjUyNzMgMy4zNjM2NCA4LjE2MzY0IDguMSA4LjE2MzY0VjEwLjM0MTRDNi4xNzQ1NSAxMC4zNDE0IDMuNzMwOTEgMTAuNjEzNiAzLjM2MzY0IDEwLjk5MDlWOS4yN1oiIGZpbGw9IiNGQkJDMDQiLz4KPHBhdGggZD0iTTkgNy4xNkM2LjM4MTgyIDcuMTYgNC4yIDkuMzQxODIgMy4zNjM2NCA3LjUwNDU1TDEuNTQwOTEgNS42M0M2LjAwOTA5IDEuMTU0NTUgMTEuNDMgMS4xNTQ1NSAxNi45IDYuNjM2MzZMMTUuMDc3MyA4LjQ1OTA5Qzg1IDcuMzk1NDUgOS40NzI3MyA7LjE2IDkgNy4xNloiIGZpbGw9IiNFQTQzMzUiLz4KPC9zdmc+Cg==') no-repeat center;
            background-size: contain;
        }

        /* é€€å‡ºç™»å½•ç¡®è®¤å¼¹çª— */
        .signout-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .signout-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .signout-modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .signout-modal.active .signout-modal-content {
            transform: scale(1);
        }

        .signout-modal h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #1a202c;
        }

        .signout-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .signout-modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .signout-modal-btn.cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .signout-modal-btn.cancel:hover {
            background: #e2e8f0;
        }

        .signout-modal-btn.confirm {
            background: #dc2626;
            color: white;
        }

        .signout-modal-btn.confirm:hover {
            background: #b91c1c;
        }

        /* ç”¨æˆ·å¤´åƒæ ·å¼ */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .login-modal.active {
            display: flex;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #f1f5f9;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .modal-header h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a202c;
        }

        .modal-header p {
            color: #64748b;
            font-size: 16px;
        }

        .login-benefits {
            margin: 32px 0;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            color: #374151;
        }

        .benefit-item i {
            width: 24px;
            color: #6366f1;
            font-size: 18px;
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 6px 12px;
            background: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            color: #3c4043;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .google-signin-btn:hover {
            background: #f8f9fa;
            border-color: #dadce0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .google-signin-btn .google-icon {
            width: 18px;
            height: 18px;
            background: url('https://www.gstatic.com/marketing-cms/assets/images/76/76/c79495454250aaacab1867bdcda4/about-10things-g.png') no-repeat center;
            background-size: contain;
        }

        .secondary-btn {
            padding: 14px 24px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #64748b;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .generation-progress {
            margin-top: 24px;
            width: 100%;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            width: 0%;
            transition: width 20s ease-out;
        }

        .progress-text {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            margin: 0;
        }

        /* ç¡®ä¿æŒ‰é’®å’Œç§¯åˆ†æ˜¾ç¤ºå¯è§ */
        .signin-btn,
        #creditsDisplay {
            opacity: 1;
            transition: opacity 0.3s ease;
        }
    
        /* ç”¨æˆ·ä¸‹æ‹‰èœå•æ ·å¼ */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 1000;
            min-width: 280px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 8px;
        }

        .user-dropdown-content {
            padding: 16px;
        }

        .user-info-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar-large {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .user-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details {
            flex: 1;
        }

        .username {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .user-level {
            font-size: 14px;
            color: #666;
            margin-bottom: 2px;
        }

        .user-valid-time {
            font-size: 12px;
            color: #999;
        }

        .dropdown-divider {
            height: 1px;
            background: #e1e5e9;
            margin: 16px -16px;
        }

        .dropdown-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 12px;
            background: none;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .dropdown-btn i {
            width: 16px;
            text-align: center;
        }

        /* ç™»å½•æŒ‰é’®ä¼˜åŒ– - åªæ˜¾ç¤ºå¤´åƒ */
        .signin-btn.logged-in {
            padding: 4px;
            border: none;
            background: none;
            position: relative;
        }

        .signin-btn.logged-in:hover {
            background: #f5f5f5;
            border-radius: 50%;
        }

        .signin-btn .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
        }

        .signin-btn .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ç§¯åˆ†æ˜¾ç¤ºä¼˜åŒ– */
        .credits-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .credits-display i {
            font-size: 16px;
            color: #ffd700;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* H5é¡µé¢éšè—ç”¨æˆ·ä¸‹æ‹‰èœå• */
            .user-dropdown {
                display: none !important;
            }
            
            .user-info-section {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
        }

        </style>

    <script>

        // é¢„åŠ è½½ç¼“å­˜ç³»ç»Ÿ - é¿å…UIé—ªçƒ
        (function () {
            // ç«‹å³ä»localStorageè¯»å–ç”¨æˆ·çŠ¶æ€
            const cachedUser = localStorage.getItem('flux_krea_user');
            const cachedCredits = localStorage.getItem('flux_krea_credits');

            if (cachedUser) {
                try {
                    const user = JSON.parse(cachedUser);
                    window.preloadedUser = user;

                    // ç«‹å³è®¾ç½®å…¨å±€ç”¨æˆ·çŠ¶æ€
                    window.currentUser = user;

                    console.log('ğŸš€ é¢„åŠ è½½ç”¨æˆ·çŠ¶æ€:', user.email);
                } catch (e) {
                    console.warn('é¢„åŠ è½½ç”¨æˆ·çŠ¶æ€å¤±è´¥:', e);
                }
            }

            if (cachedCredits) {
                try {
                    const credits = JSON.parse(cachedCredits);
                    window.preloadedCredits = credits;

                    console.log('ğŸš€ é¢„åŠ è½½ç§¯åˆ†çŠ¶æ€:', credits);
                } catch (e) {
                    console.warn('é¢„åŠ è½½ç§¯åˆ†çŠ¶æ€å¤±è´¥:', e);
                }
            }
        })();

        // ç«‹å³æ›´æ–°UIæ˜¾ç¤º - é¿å…é—ªçƒ
        function immediateUIUpdate() {
            if (window.preloadedUser) {
                const user = window.preloadedUser;

                // ç«‹å³æ›´æ–°ç™»å½•æŒ‰é’®
                const signinBtn = document.querySelector('.signin-btn');
                if (signinBtn) {
                    signinBtn.innerHTML = `
                        <img src="${user.avatar_url || 'https://via.placeholder.com/18'}" 
                             style="width: 18px; height: 18px; border-radius: 50%;" alt="Avatar">
                    `;
                    signinBtn.style.display = 'flex';
                }

                // ç«‹å³æ˜¾ç¤ºç§¯åˆ†
                const creditsDisplay = document.getElementById('creditsDisplay');
                if (creditsDisplay) {
                    creditsDisplay.style.display = 'flex';
                }
            }

            if (window.preloadedCredits && window.preloadedUser) {
                const userIdentifier = window.preloadedUser.uuid || window.preloadedUser.email;
                const userCredits = window.preloadedCredits[userIdentifier];

                if (userCredits !== undefined) {
                    const creditsAmount = document.getElementById('creditsAmount');
                    if (creditsAmount) {
                        creditsAmount.textContent = userCredits;
                    }
                }
            }
        }

        // DOMåŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', immediateUIUpdate);
        } else {
            immediateUIUpdate();
        }
    </script>

    <!-- é˜²ç¼“å­˜æ§åˆ¶ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
    <div class="signout-modal" id="signoutModal">
        <div class="signout-modal-content">
            <h3>Are you sure sign out?</h3>
            <div class="signout-modal-actions">
                <button class="signout-modal-btn cancel" onclick="closeSignoutModal()">Cancel</button>
                <button class="signout-modal-btn confirm" onclick="confirmSignout()">OK</button>
            </div>
        </div>
    </div>

    <!-- Authentication Required Modal for Unauthenticated Users -->
    <div class="credits-modal" id="creditsModal">
        <div class="credits-modal-content">
            <div class="credits-modal-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h3 id="creditsModalTitle">Credits balance is 20</h3>
            <p id="creditsModalContent">Sign in with Google to Gain Free 20 Credits.</p>
            <div class="credits-modal-actions">
                <button class="credits-modal-btn primary" onclick="signInFromModal()">
                    <div class="google-icon"></div>
                    <span>Sign in</span>
                </button>
                <button class="credits-modal-btn secondary" onclick="closeCreditsModal()">
                    <span>Close</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="loading-modal" id="loadingModal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <p id="loadingMessage">æ­£åœ¨å¤„ç†...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <img src="https://ciwjjfcuhubjydajazkk.supabase.co/storage/v1/object/public/webstie-icon//FluxKrea%20log-120.png"
                        alt="FluxKrea.me AI Logo">
                </div>
                Flux Krea AI
            </a>
            <ul class="nav-links">
                <li><a href="#features">Features</a></li>
                <li><a href="showcase.html" class="active">Showcase</a></li>
                <li><a href="pricing.html">Pricing</a></li>
                <li><a href="#faq">FAQ</a></li>
            </ul>



            <div class="nav-actions">
                <div class="credits-display" id="creditsDisplay">
                    <i class="fas fa-coins"></i>
                    <span id="creditsAmount">--</span>
                </div>
                <!-- ç®¡ç†å‘˜è°ƒè¯•æŒ‰é’® - ä»…å¯¹ç‰¹å®šè´¦æˆ·æ˜¾ç¤º -->
                <button id="debugRefreshBtn" onclick="showDebugMenu()"
                    style="padding: 4px 8px; font-size: 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; margin-right: 8px; cursor: pointer; display: none;"
                    title="ç®¡ç†å‘˜è°ƒè¯•èœå•">
                    ğŸ”§ è°ƒè¯•
                </button>

                <div class="signin-btn" onclick="handleSignInClick()">
                    <div class="google-icon"></div>
                    <span>Sign in</span>
                </div>
            </div>
        </nav>
        <!-- ç”¨æˆ·ä¿¡æ¯ä¸‹æ‹‰èœå• -->
        <div id="userDropdown" class="user-dropdown" style="display: none;">
            <div class="user-dropdown-content">
                <div class="user-info-section">
                    <div class="user-avatar-large">
                        <img id="dropdownUserAvatar" src="" alt="User Avatar">
                    </div>
                    <div class="user-details">
                        <div class="username" id="dropdownUsername">ç”¨æˆ·å</div>
                        <div class="user-level" id="dropdownUserLevel">Level: Free</div>
                        <div class="user-valid-time" id="dropdownValidTime">Valid time: --</div>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-actions">
                    <button class="dropdown-btn" onclick="handleSignOut()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sign out
                    </button>
                </div>
            </div>
        </div>

    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-badges">
            <span class="badge orange">âœ… Free Create</span>
            <span class="badge green">ğŸ‰ No-Signup</span>
            <span class="badge blue">ğŸï¸ High-Quality</span>
            <span class="badge purple">ğŸ¥‡ Fast&Realistic</span>
        </div>
        <h1>Create Stunning Images with FLUX.1 Krea Dev Model</h1>
        <p>Turn text into stunning, HQ images with Flux.1 Krea Dev â€” Powered by 12B-Parameter AI model.</p>
    </section>

    <!-- Main Generator -->
    <section id="generator" class="container">
        <div class="main-grid">
            <!-- Left Panel -->
            <div class="card">
                <h2>
                    <i class="fas fa-magic"></i>
                    Generation Mode
                </h2>

                <div class="mode-buttons">
                    <button class="mode-btn active" data-mode="text">
                        <i class="fas fa-pen"></i>
                        Text to Image
                    </button>
                </div>

                <div class="prompt-section">
                    <h3>Positive Prompt</h3>
                    <textarea class="prompt-textarea" id="prompt"
                        placeholder="360 image tiny planet, tiny round planet, urban, the pand in this pic walking tiny planet Norway northern lights, perfectly centered, centered in frame."></textarea>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px;">
                        <button class="copy-btn" onclick="pastePrompt()">
                            <i class="fas fa-paste"></i> Paste
                        </button>
                        <button class="clear-btn" onclick="clearPrompt()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                        <button class="clear-btn" onclick="randomPrompt()" title="éšæœºæç¤ºè¯">
                            ğŸ² Random
                        </button>
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>
                                <i class="fas fa-expand-arrows-alt"></i>
                                Image Size
                            </label>
                            <select id="imageSize">
                                <option value="1024x1024">Square HD (1024Ã—1024)</option>
                                <option value="1024x768">Landscape (1024Ã—768)</option>
                                <option value="768x1024">Portrait (768Ã—1024)</option>
                                <option value="512x512">Square (512Ã—512)</option>
                            </select>
                        </div>

                        <div class="slider-container">
                            <label>
                                <i class="fas fa-layer-group"></i>
                                Inference Steps
                                <span class="slider-value" id="stepsValue">4</span>
                            </label>
                            <input type="range" min="1" max="4" value="4" class="slider" id="stepsSlider">
                        </div>
                    </div>

                    <button class="generate-btn" id="generateBtn" onclick="generateImage()">
                        <span class="btn-content">
                            <i class="fas fa-bolt"></i>
                            Generate
                        </span>
                        <span class="credits-cost">-10 Credits</span>
                    </button>





                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="checkUserState()"
                            style="padding: 10px; background: #6f42c1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ‘¤ æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
                        </button>
                        <button onclick="debugGenerate()"
                            style="padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ› è°ƒè¯•Generate
                        </button>
                        <button onclick="showGenerationHistory()" title="æŸ¥çœ‹ç”Ÿæˆå†å²"
                            style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ“š ç”Ÿæˆå†å²
                        </button>
                    </div>

                    <!-- H5 Pricing Entry Button -->
                    <a href="pricing.html" class="h5-pricing-btn">
                        <i class="fas fa-credit-card"></i>
                        Get More Credits
                    </a>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="card">
                <h2>Generated Images</h2>
                <p class="card-subtitle">Your AI-generated artwork will appear here</p>

                <div id="resultArea">
                    <div class="result-placeholder">
                        <i class="fas fa-image"></i>
                        <h3>No images generated yet</h3>
                        <p>Enter a prompt and click generate to create your first image</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="features-section">
        <div class="container">
            <div class="section-header">
                <h2>Why use FLUX.1 Krea?</h2>
                <p style="margin: 0px 24px; max-width: 1120px; margin-left: auto; margin-right: auto;">FLUX.1 Krea is a
                    state of the art open source text to image model created with an emphasis on aesthetics and
                    photorealism. Unlike other models trained on massive datasets, FLUX.1 Krea was trained on hand
                    curated, high-quality training data to deliver the best results.</p>
                <div style="margin-top: 32px;">
                    <a href="#generator" class="cta-btn primary" onclick="scrollToGenerator()">
                        Try Flux.1 Krea in the main tool
                    </a>
                    <p style="margin-top: 16px; color: #64748b; font-size: 16px;">
                        Free AI image generator. No sign up, no credit card.
                    </p>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pic4.zhimg.com/v2-e1374c41f099af1c9714b09a13f4c29f_1440w.jpg"
                            alt="AI Images that Don't Look So AI">
                    </div>
                    <h3>Reality - Don't Look So AI</h3>
                    <p>Our new model offers accurate skin textures, dynamic camera angles, and expressive color.
                        Discover striking visuals in an exceptionally artistic latent space.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('photorealistic portrait of a person with detailed skin texture, dynamic camera angle, professional photography')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pic1.zhimg.com/v2-4dfe15bc9d72a0eaa6048ae2efbb755e_1440w.jpg"
                            alt="Lightning Fast Generation">
                    </div>
                    <h3>Lightning fast</h3>
                    <p>Get high definition images back in seconds. Fast iteration lets you explore, experiment, and
                        evolve your vision without interrupting your flow.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('a futuristic cityscape at golden hour, high definition, cinematic lighting')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://picx.zhimg.com/v2-972099fcef030036a5583bd4ba8aac69_1440w.jpg"
                            alt="Free Access">
                    </div>
                    <h3>Free AI Image Generator</h3>
                    <p>Enjoy free FLUX.1 Krea generations on Krea or download the weights and run it on your own
                        hardware. No sign up or credit card required. Generate AI images online for free.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('beautiful landscape with mountains and lake, golden hour lighting, artistic style')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pic4.zhimg.com/v2-c1bbf18cfc3c15c39dff6041451bc9eb_1440w.jpg"
                            alt="Hand Curated Training">
                    </div>
                    <h3>Hand Curated Training Data</h3>
                    <p>Unlike other models trained on massive datasets, FLUX.1 Krea was trained on hand curated,
                        high-quality training data to deliver the best aesthetic results.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('artistic portrait with exceptional detail and aesthetic composition, professional quality')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pic4.zhimg.com/v2-06b9a280b8a4c331a35fca57342956eb_1440w.jpg"
                            alt="Open Source">
                    </div>
                    <h3>Open Source Excellence</h3>
                    <p>FLUX.1 Krea is open source, allowing you to download the weights and run it on your own hardware
                        for complete control and privacy.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('tech illustration showing open source concept, clean design, modern style')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>

                <div class="feature-card">
                    <div class="feature-image">
                        <img src="https://pica.zhimg.com/v2-ffa8c449ab7c46656eb31ac01c4d693c_1440w.jpg"
                            alt="Photorealism">
                    </div>
                    <h3>Emphasis on Photorealism</h3>
                    <p>Created with a special focus on aesthetics and photorealistic results, delivering images that are
                        virtually indistinguishable from real photography.</p>
                    <button class="demo-btn"
                        onclick="demoGenerate('photorealistic nature scene with incredible detail, professional photography style')">
                        <i class="fas fa-play"></i> Try now
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Testimonials Section -->
    <section class="testimonials-section">
        <div class="container">
            <div class="section-header">
                <h2>Trusted by creators worldwide</h2>
                <p>Join thousands of artists, designers, and creators who use FLUX.1 Krea daily</p>
            </div>

            <div class="testimonials-grid">
                <div class="testimonial-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p>"FLUX.1 Krea has revolutionized my creative workflow. The quality is incredible and the speed is
                        unmatched. I can now create professional-grade images in seconds!"</p>
                    <div class="testimonial-author">
                        <div class="author-avatar">S</div>
                        <div>
                            <div class="author-name">Sarah Chen</div>
                            <div class="author-title">Digital Artist</div>
                        </div>
                    </div>
                </div>

                <div class="testimonial-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p>"As a marketing professional, I need high-quality visuals fast. FLUX.1 Krea delivers exactly what
                        I need - stunning images that perfectly match my vision."</p>
                    <div class="testimonial-author">
                        <div class="author-avatar">M</div>
                        <div>
                            <div class="author-name">Mike Rodriguez</div>
                            <div class="author-title">Marketing Director</div>
                        </div>
                    </div>
                </div>

                <div class="testimonial-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p>"The level of detail and realism is mind-blowing. I've tried many AI image generators, but FLUX.1
                        Krea is in a league of its own."</p>
                    <div class="testimonial-author">
                        <div class="author-avatar">E</div>
                        <div>
                            <div class="author-name">Emily Watson</div>
                            <div class="author-title">Freelance Designer</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">50K+</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">1M+</div>
                        <div class="stat-label">Images Generated</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">4.9/5</div>
                        <div class="stat-label">User Rating</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">99.9%</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section id="faq" class="faq-section">
        <div class="container">
            <div class="section-header">
                <h2>Frequently Asked Questions</h2>
                <p>Everything you need to know about FLUX.1 Krea</p>
            </div>

            <div class="faq-container">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>What is FLUX.1 Krea?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>FLUX.1 Krea is a state-of-the-art AI image generation model that creates high-quality,
                            photorealistic images from text descriptions. It's designed to understand complex prompts
                            and generate professional-grade visuals in seconds.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>How fast is image generation?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>FLUX.1 Krea generates high-quality images in just 4-10 seconds, making it one of the fastest
                            AI image generators available while maintaining exceptional quality.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>Can I use generated images commercially?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Yes! All images generated with FLUX.1 Krea can be used for commercial purposes without
                            restrictions. You own the rights to your generated content.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>What image sizes are supported?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>FLUX.1 Krea supports various aspect ratios including square (1024Ã—1024), landscape
                            (1024Ã—768), and portrait (768Ã—1024) formats, all in high resolution.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>How do I write effective prompts?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Be descriptive and specific. Include details about style, lighting, composition, and mood.
                            For example: "A serene mountain lake at sunset, oil painting style, warm golden lighting,
                            peaceful atmosphere."</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <h3>Is there a free trial available?</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Yes! We offer free credits for new users to try FLUX.1 Krea. You can generate several images
                            to experience the quality and speed before upgrading.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div>
                    <div class="logo footer-logo">
                        <div class="logo-icon">
                            <img src="https://ciwjjfcuhubjydajazkk.supabase.co/storage/v1/object/public/webstie-icon//FluxKrea%20log-120.png"
                                alt="FluxKrea.me AI Logo">
                        </div>
                        FluxKrea.me AI
                    </div>
                    <p class="footer-description">
                        Create Stunning Images with FLUX.1 Krea Dev Model
                    </p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>

                <div class="footer-section">
                    <h4>Product</h4>
                    <ul class="footer-links">
                        <li><a href="#features">Features</a></li>
                        <li><a href="showcase.html">Showcase</a></li>
                        <li><a href="pricing.html">Pricing</a></li>
                        <li><a href="#faq">FAQ</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Contact</h4>
                    <ul class="footer-links">
                        <li><a href="mailto:tiktreeapp@gmail.com">tiktreeapp@gmail.com</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Support</h4>
                    <ul class="footer-links">
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="terms.html">Terms of Service</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 Flux Krea AI. All rights reserved. Powered by advanced AI technology.</p>
            </div>
        </div>
    </footer>

    <script>
        // Token ç°åœ¨åœ¨æœåŠ¡å™¨ç«¯ç¯å¢ƒå˜é‡ä¸­ï¼Œå‰ç«¯ä¸å†éœ€è¦

        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Steps slider
        const stepsSlider = document.getElementById('stepsSlider');
        const stepsValue = document.getElementById('stepsValue');

        stepsSlider.addEventListener('input', () => {
            stepsValue.textContent = stepsSlider.value;
        });

        // Paste prompt function
        async function pastePrompt() {
            try {
                const clipboardText = await navigator.clipboard.readText();
                const promptTextarea = document.getElementById('prompt');
                promptTextarea.value = clipboardText;
                promptTextarea.focus();

                const btn = document.querySelector('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Pasted!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            } catch (error) {
                console.error('æ— æ³•è®¿é—®å‰ªåˆ‡æ¿:', error);
                alert('æ— æ³•è®¿é—®å‰ªåˆ‡æ¿ï¼Œè¯·ç¡®ä¿æµè§ˆå™¨æ”¯æŒè¯¥åŠŸèƒ½');
            }
        }

        // Clear prompt function
        function clearPrompt() {
            document.getElementById('prompt').value = '';
            document.getElementById('prompt').focus();
        }

        // Generate image function
        // Demo generation function
        function demoGenerate(prompt) {
            document.getElementById('prompt').value = prompt;
            generateImage();

            // Scroll to generator
            document.getElementById('generator').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Scroll to generator function
        function scrollToGenerator() {
            document.getElementById('generator').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // FAQ toggle function
        function toggleFAQ(element) {
            const faqItem = element.parentElement;
            const isActive = faqItem.classList.contains('active');

            // Close all FAQ items
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
            });

            // Open clicked item if it wasn't active
            if (!isActive) {
                faqItem.classList.add('active');
            }
        }

        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶å‡½æ•°
        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            const hamburger = document.querySelector('.hamburger-menu');

            navLinks.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        // ç‚¹å‡»å¯¼èˆªé“¾æ¥åè‡ªåŠ¨å…³é—­ç§»åŠ¨ç«¯èœå•
        document.addEventListener('DOMContentLoaded', function () {
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.addEventListener('click', function () {
                    const navLinks = document.querySelector('.nav-links');
                    const hamburger = document.querySelector('.hamburger-menu');

                    navLinks.classList.remove('active');
                    hamburger.classList.remove('active');
                });
            });
        });

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });

        // åˆ›å»ºå›¾ç‰‡ç”Ÿæˆç®¡ç†å™¨
        window.ImageGenerator = class {
            constructor() {
                this.isGenerating = false;
                this.generationCost = 10;
            }

            // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç”Ÿæˆ
            canGenerate() {
                if (this.isGenerating) {
                    console.log('âš ï¸ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç­‰å¾…...');
                    return false;
                }

                if (!window.UnifiedStateSync) {
                    console.error('âŒ UnifiedStateSyncæœªåŠ è½½');
                    return false;
                }

                return true;
            }

            // éªŒè¯è¾“å…¥
            validateInput() {
                const prompt = document.getElementById('prompt')?.value?.trim();
                if (!prompt) {
                    alert('è¯·è¾“å…¥å›¾åƒæè¿°');
                    return null;
                }
                return prompt;
            }

            // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å’Œç§¯åˆ†
            checkUserAndCredits() {
                const currentUser = window.UnifiedStateSync.getCurrentUser();
                const currentCredits = window.UnifiedStateSync.getCredits();

                console.log(`ğŸ” ç”¨æˆ·çŠ¶æ€æ£€æŸ¥: ç”¨æˆ·=${currentUser?.email || 'æœªç™»å½•'}, ç§¯åˆ†=${currentCredits}, éœ€è¦=${this.generationCost}`);

                if (!currentUser) {
                    console.log('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•å¼¹çª—');
                    showCreditsModal();
                    return { canProceed: false, reason: 'not_logged_in' };
                }

                if (currentCredits < this.generationCost) {
                    console.log('âŒ Insufficient credits');

                    if (currentCredits === 0) {
                        // ç§¯åˆ†ä¸º0æ—¶æ˜¾ç¤ºç»Ÿä¸€æ ·å¼çš„å¼¹çª—
                        console.log('ğŸ“± ç§¯åˆ†ä¸º0ï¼Œæ˜¾ç¤ºå¼¹çª—');
                        showCreditsModal(currentCredits, this.generationCost);
                    } else {
                        // Insufficient credits but not 0, show confirm dialog
                        console.log('ğŸ“± Insufficient credits but not 0, showing confirm dialog');
                        const message = `Insufficient Credits!\n\nCurrent credits: ${currentCredits}\nRequired credits: ${this.generationCost}\nMissing credits: ${this.generationCost - currentCredits}\n\nClick OK to go to Pricing page to purchase credits.`;

                        if (confirm(message)) {
                            // Save current prompt so user can continue after purchasing credits
                            const prompt = document.getElementById('prompt')?.value?.trim();
                            if (prompt) {
                                localStorage.setItem('pending_generation_prompt', prompt);
                            }

                            window.location.href = 'pricing.html';
                        }
                    }
                    return { canProceed: false, reason: 'insufficient_credits', currentCredits, requiredCredits: this.generationCost };
                }

                return { canProceed: true, user: currentUser, credits: currentCredits };
            }

            // è®¾ç½®ç”ŸæˆçŠ¶æ€
            setGeneratingState(generating) {
                this.isGenerating = generating;
                const generateBtn = document.getElementById('generateBtn');
                const resultArea = document.getElementById('resultArea');

                if (generateBtn) {
                    generateBtn.disabled = generating;
                    generateBtn.innerHTML = generating
                        ? '<span>Generating...</span>'
                        : '<span><i class="fas fa-bolt"></i> Generate</span>';
                }

                if (resultArea && generating) {
                    resultArea.innerHTML = '<div>æ­£åœ¨ç”Ÿæˆå›¾åƒ...</div>';
                }
            }

            // è°ƒç”¨ç”ŸæˆAPI
            async callGenerateAPI(prompt) {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        width: 1024,
                        height: 1024,
                        steps: 4
                    })
                });

                if (!response.ok) {
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
                }

                return await response.json();
            }

            // æ˜¾ç¤ºç”Ÿæˆç»“æœ
            displayResult(result, creditsUsed = this.generationCost, remainingCredits = null, hasError = false) {
                const resultArea = document.getElementById('resultArea');
                if (!resultArea) return;

                const creditsInfo = remainingCredits !== null
                    ? `æ¶ˆè€—ç§¯åˆ†: ${creditsUsed} | å‰©ä½™ç§¯åˆ†: ${remainingCredits}`
                    : `æ¶ˆè€—ç§¯åˆ†: ${creditsUsed}`;

                const errorWarning = hasError
                    ? '<div class="error-warning">âš ï¸ ç§¯åˆ†æ‰£é™¤å¼‚å¸¸ï¼Œè¯·è”ç³»å®¢æœ</div>'
                    : '';

                // è·å–å½“å‰æç¤ºè¯ç”¨äºæ˜¾ç¤º
                const currentPrompt = document.getElementById('prompt')?.value?.trim() || '';
                const truncatedPrompt = currentPrompt.length > 100
                    ? currentPrompt.substring(0, 100) + '...'
                    : currentPrompt;

                // ç”Ÿæˆå”¯ä¸€IDç”¨äºå›¾ç‰‡æ“ä½œ
                const imageId = 'generated-image-' + Date.now();
                const timestamp = new Date().toLocaleString('zh-CN');

                resultArea.innerHTML = `
                    <div class="result-success">
                        <div class="result-header">
                            <h3 class="result-title">ğŸ‰ ç”ŸæˆæˆåŠŸï¼</h3>
                            <div class="result-meta">
                                <span class="timestamp">ç”Ÿæˆæ—¶é—´: ${timestamp}</span>
                            </div>
                        </div>
                        
                        <div class="image-container">
                            <img id="${imageId}" src="${result.image}" alt="Generated Image" class="generated-image" 
                                 onclick="this.classList.toggle('fullscreen')" 
                                 title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">
                            <div class="image-overlay">
                                <button class="overlay-btn" onclick="toggleFullscreen('${imageId}')" title="å…¨å±æŸ¥çœ‹">
                                    ğŸ”
                                </button>
                            </div>
                        </div>

                        <div class="result-info">
                            <div class="prompt-info">
                                <strong>æç¤ºè¯:</strong> 
                                <span class="prompt-text" title="${currentPrompt}">${truncatedPrompt}</span>
                            </div>
                            <div class="credits-info">
                                <span class="credits-text">${creditsInfo}</span>
                            </div>
                            ${errorWarning}
                        </div>

                        <div class="result-actions">
                            <button class="action-btn primary" onclick="downloadImage('${result.image}', '${currentPrompt}')" title="ä¸‹è½½å›¾ç‰‡">
                                ğŸ“¥ ä¸‹è½½å›¾ç‰‡
                            </button>
                            <button class="action-btn secondary" onclick="copyImageUrl('${result.image}')" title="å¤åˆ¶å›¾ç‰‡é“¾æ¥">
                                ğŸ”— å¤åˆ¶é“¾æ¥
                            </button>
                            <button class="action-btn secondary" onclick="shareImage('${result.image}', '${currentPrompt}')" title="åˆ†äº«å›¾ç‰‡">
                                ğŸ“¤ åˆ†äº«
                            </button>
                            <button class="action-btn secondary" onclick="regenerateWithSamePrompt()" title="ä½¿ç”¨ç›¸åŒæç¤ºè¯é‡æ–°ç”Ÿæˆ">
                                ğŸ”„ é‡æ–°ç”Ÿæˆ
                            </button>
                        </div>

                        <div class="result-stats">
                            <div class="stat-item">
                                <span class="stat-label">å°ºå¯¸:</span>
                                <span class="stat-value">1024Ã—1024</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æ¨¡å‹:</span>
                                <span class="stat-value">FLUX.1 Krea</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æ­¥æ•°:</span>
                                <span class="stat-value">4</span>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ ç”Ÿæˆå†å²
                this.addToHistory(result.image, currentPrompt, timestamp, creditsUsed);

                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                setTimeout(() => {
                    resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }

            // æ·»åŠ åˆ°ç”Ÿæˆå†å²
            addToHistory(imageUrl, prompt, timestamp, creditsUsed) {
                try {
                    let history = JSON.parse(localStorage.getItem('generation_history') || '[]');

                    // æ·»åŠ æ–°è®°å½•
                    history.unshift({
                        id: Date.now(),
                        imageUrl,
                        prompt,
                        timestamp,
                        creditsUsed
                    });

                    // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
                    history = history.slice(0, 20);

                    localStorage.setItem('generation_history', JSON.stringify(history));
                    console.log('âœ… å·²æ·»åŠ åˆ°ç”Ÿæˆå†å²');
                } catch (error) {
                    console.error('âŒ æ·»åŠ ç”Ÿæˆå†å²å¤±è´¥:', error);
                }
            }

            // æ˜¾ç¤ºç”Ÿæˆå†å²
            showHistory() {
                try {
                    const history = JSON.parse(localStorage.getItem('generation_history') || '[]');
                    if (history.length === 0) {
                        alert('æš‚æ— ç”Ÿæˆå†å²');
                        return;
                    }

                    const historyHtml = history.map(item => `
                        <div class="history-item">
                            <img src="${item.imageUrl}" alt="å†å²å›¾ç‰‡" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                            <div class="history-info">
                                <div class="history-prompt">${item.prompt.substring(0, 50)}${item.prompt.length > 50 ? '...' : ''}</div>
                                <div class="history-meta">${item.timestamp} | æ¶ˆè€—ç§¯åˆ†: ${item.creditsUsed}</div>
                                <div class="history-actions">
                                    <button onclick="downloadImage('${item.imageUrl}', '${item.prompt}')">ä¸‹è½½</button>
                                    <button onclick="usePrompt('${item.prompt}')">ä½¿ç”¨æç¤ºè¯</button>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // åˆ›å»ºå†å²å¼¹çª—
                    const modal = document.createElement('div');
                    modal.className = 'history-modal';
                    modal.innerHTML = `
                        <div class="history-modal-content">
                            <div class="history-modal-header">
                                <h3>ç”Ÿæˆå†å²</h3>
                                <button onclick="this.closest('.history-modal').remove()">Ã—</button>
                            </div>
                            <div class="history-modal-body">
                                ${historyHtml}
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                } catch (error) {
                    console.error('âŒ æ˜¾ç¤ºç”Ÿæˆå†å²å¤±è´¥:', error);
                    alert('æ˜¾ç¤ºå†å²å¤±è´¥');
                }
            }

            // æ˜¾ç¤ºé”™è¯¯
            showError(error) {
                const resultArea = document.getElementById('resultArea');
                if (resultArea) {
                    resultArea.innerHTML = `<div style="color: red;">ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
                }
            }

            // ä¸»è¦çš„ç”Ÿæˆæ–¹æ³•
            async generate() {
                console.log('=== ğŸ¯ å¼€å§‹å›¾åƒç”Ÿæˆ ===');

                // 1. æ£€æŸ¥æ˜¯å¦å¯ä»¥ç”Ÿæˆ
                if (!this.canGenerate()) return;

                // 2. éªŒè¯è¾“å…¥
                const prompt = this.validateInput();
                if (!prompt) return;

                // 3. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å’Œç§¯åˆ†
                const { canProceed } = this.checkUserAndCredits();
                if (!canProceed) return;

                try {
                    // 4. è®¾ç½®ç”ŸæˆçŠ¶æ€
                    this.setGeneratingState(true);

                    // 5. è°ƒç”¨API
                    console.log('ğŸš€ å¼€å§‹è°ƒç”¨API...');
                    const result = await this.callGenerateAPI(prompt);

                    if (result.success && result.image) {
                        // 6. æ‰£é™¤ç§¯åˆ†
                        console.log('ğŸ”„ å¼€å§‹æ‰£é™¤ç§¯åˆ†...');
                        const success = await window.UnifiedStateSync.deductCredits(this.generationCost);

                        if (success) {
                            const remainingCredits = window.UnifiedStateSync.getCredits();
                            console.log('âœ… ç§¯åˆ†æ‰£é™¤æˆåŠŸï¼Œå‰©ä½™ç§¯åˆ†:', remainingCredits);

                            // 7. æ˜¾ç¤ºç»“æœï¼ˆåŒ…å«ç§¯åˆ†ä¿¡æ¯ï¼‰
                            this.displayResult(result, this.generationCost, remainingCredits);
                        } else {
                            // ç§¯åˆ†æ‰£é™¤å¤±è´¥ï¼Œä½†å›¾ç‰‡å·²ç”Ÿæˆï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡é—®é¢˜
                            console.error('âŒ ä¸¥é‡é”™è¯¯ï¼šå›¾ç‰‡ç”ŸæˆæˆåŠŸä½†ç§¯åˆ†æ‰£é™¤å¤±è´¥');

                            // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
                            this.showError(new Error('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼Œä½†ç§¯åˆ†æ‰£é™¤å¤±è´¥ã€‚è¯·è”ç³»å®¢æœå¤„ç†ã€‚'));

                            // ä»ç„¶æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡ï¼Œä½†æ ‡è®°ä¸ºå¼‚å¸¸
                            this.displayResult(result, 0, window.UnifiedStateSync.getCredits(), true);
                        }
                    } else {
                        throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
                    }

                } catch (error) {
                    console.error('âŒ å›¾åƒç”Ÿæˆå¤±è´¥:', error);
                    this.showError(error);
                } finally {
                    // 8. æ¢å¤çŠ¶æ€
                    this.setGeneratingState(false);
                }
            }
        };

        // åˆ›å»ºå…¨å±€ImageGeneratorå®ä¾‹
        window.imageGenerator = new window.ImageGenerator();

        // å…¨å±€è¾…åŠ©å‡½æ•°
        window.toggleFullscreen = function (imageId) {
            const img = document.getElementById(imageId);
            if (img) {
                img.classList.toggle('fullscreen');
            }
        };

        window.copyImageUrl = function (imageUrl) {
            navigator.clipboard.writeText(imageUrl).then(() => {
                alert('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
            });
        };

        window.shareImage = function (imageUrl, prompt) {
            if (navigator.share) {
                navigator.share({
                    title: 'AIç”Ÿæˆçš„å›¾ç‰‡',
                    text: `æç¤ºè¯: ${prompt}`,
                    url: imageUrl
                }).catch(err => console.log('åˆ†äº«å¤±è´¥:', err));
            } else {
                // é™çº§æ–¹æ¡ˆï¼šå¤åˆ¶é“¾æ¥
                window.copyImageUrl(imageUrl);
            }
        };

        window.regenerateWithSamePrompt = function () {
            if (window.imageGenerator) {
                window.imageGenerator.generate();
            }
        };

        window.downloadImage = function (imageUrl, prompt = '') {
            try {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `flux-krea-${Date.now()}.png`;

                // æ·»åŠ æç¤ºè¯åˆ°æ–‡ä»¶å
                if (prompt) {
                    const cleanPrompt = prompt.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_').substring(0, 30);
                    link.download = `flux-krea-${cleanPrompt}-${Date.now()}.png`;
                }

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('âœ… å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹');
            } catch (error) {
                console.error('âŒ ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·å³é”®å›¾ç‰‡å¦å­˜ä¸º');
            }
        };

        window.usePrompt = function (prompt) {
            const promptInput = document.getElementById('prompt');
            if (promptInput) {
                promptInput.value = prompt;
                promptInput.focus();

                // å…³é—­å†å²å¼¹çª—
                const modal = document.querySelector('.history-modal');
                if (modal) {
                    modal.remove();
                }
            }
        };

        window.showGenerationHistory = function () {
            if (window.imageGenerator) {
                window.imageGenerator.showHistory();
            }
        };

        window.clearPrompt = function () {
            const promptInput = document.getElementById('prompt');
            if (promptInput) {
                if (promptInput.value.trim() && !confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰æç¤ºè¯å—ï¼Ÿ')) {
                    return;
                }
                promptInput.value = '';
                promptInput.focus();
            }
        };

        window.randomPrompt = function () {
            const randomPrompts = [
                'a beautiful landscape with mountains and lake, golden hour lighting, artistic style',
                'photorealistic portrait of a person with detailed skin texture, dynamic camera angle',
                'a futuristic cityscape at golden hour, high definition, cinematic lighting',
                'artistic portrait with exceptional detail and aesthetic composition, professional quality',
                'tech illustration showing modern design, clean style, minimalist',
                'photorealistic nature scene with incredible detail, professional photography style',
                'abstract art with vibrant colors and flowing shapes, modern artistic style',
                'cozy interior design with warm lighting, Scandinavian style, minimalist',
                'fantasy landscape with magical elements, ethereal lighting, concept art style',
                'vintage car in urban setting, moody lighting, cinematic photography'
            ];

            const promptInput = document.getElementById('prompt');
            if (promptInput) {
                const randomIndex = Math.floor(Math.random() * randomPrompts.length);
                promptInput.value = randomPrompts[randomIndex];
                promptInput.focus();

                // æ·»åŠ æ‰“å­—æœºæ•ˆæœ
                const originalValue = promptInput.value;
                promptInput.value = '';
                let i = 0;
                const typeWriter = setInterval(() => {
                    promptInput.value += originalValue.charAt(i);
                    i++;
                    if (i >= originalValue.length) {
                        clearInterval(typeWriter);
                    }
                }, 50);
            }
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰å¾…ç”Ÿæˆçš„æç¤ºè¯
        document.addEventListener('DOMContentLoaded', function () {
            const pendingPrompt = localStorage.getItem('pending_generation_prompt');
            if (pendingPrompt) {
                const promptInput = document.getElementById('prompt');
                if (promptInput) {
                    promptInput.value = pendingPrompt;
                    console.log('âœ… å·²æ¢å¤å¾…ç”Ÿæˆçš„æç¤ºè¯:', pendingPrompt);

                    // æ¸…é™¤å­˜å‚¨çš„æç¤ºè¯
                    localStorage.removeItem('pending_generation_prompt');

                    // æ˜¾ç¤ºæç¤º
                    setTimeout(() => {
                        if (confirm('Detected a previous generation task interrupted due to insufficient credits.\n\nWould you like to continue generating now?')) {
                            window.imageGenerator.generate();
                        }
                    }, 1000);
                }
            }
        });

        // åˆ›å»ºç»Ÿä¸€çš„ç§¯åˆ†ç®¡ç†å™¨
        window.CreditsManager = class {
            constructor() {
                this.credits = 0;
                this.listeners = [];
            }

            setCredits(amount) {
                const oldCredits = this.credits;
                this.credits = Math.max(0, amount);

                // æ›´æ–°UIæ˜¾ç¤º
                this.updateDisplay();

                // é€šçŸ¥ç›‘å¬å™¨
                this.notifyListeners(oldCredits, this.credits);

                console.log(`âœ… ç§¯åˆ†å·²æ›´æ–°: ${oldCredits} â†’ ${this.credits}`);
            }

            updateDisplay() {
                const creditsElement = document.getElementById('creditsAmount');
                if (creditsElement) {
                    creditsElement.textContent = this.credits;

                    // æ·»åŠ æ›´æ–°åŠ¨ç”»æ•ˆæœ
                    creditsElement.style.transition = 'all 0.3s ease';
                    creditsElement.style.color = '#10b981';
                    setTimeout(() => {
                        creditsElement.style.color = '';
                    }, 500);
                }
            }

            addListener(callback) {
                this.listeners.push(callback);
            }

            notifyListeners(oldCredits, newCredits) {
                this.listeners.forEach(callback => {
                    try {
                        callback(oldCredits, newCredits);
                    } catch (error) {
                        console.error('âŒ ç§¯åˆ†ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥:', error);
                    }
                });
            }

            async deductCredits(amount, reason = 'æ¶ˆè´¹') {
                if (this.credits >= amount) {
                    this.setCredits(this.credits - amount);
                    console.log(`ğŸ’° ç§¯åˆ†æ‰£é™¤: ${amount} (${reason})`);

                    // åŒæ­¥åˆ°ç”¨æˆ·æ•°æ®
                    if (window.currentUser) {
                        window.currentUser.credits = this.credits;
                        localStorage.setItem('flux_krea_user', JSON.stringify(window.currentUser));
                    }

                    return true;
                } else {
                    console.warn(`âŒ Insufficient credits: need ${amount}, current ${this.credits}`);
                    return false;
                }
            }
        };

        // åˆå§‹åŒ–ç§¯åˆ†ç®¡ç†å™¨
        window.creditsSync = new window.CreditsManager();

        // å…¨å±€UIæ›´æ–°é˜²æŠ–å™¨
        let uiUpdateTimeout = null;
        let lastUIState = null;

        // ç§¯åˆ†æ˜¾ç¤ºä¿®å¤å‡½æ•° - å¢å¼ºç‰ˆï¼ˆå¸¦é˜²æŠ–ï¼‰
        window.updateCreditsDisplay = function () {
            // é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é¢‘ç¹æ›´æ–°
            if (uiUpdateTimeout) {
                clearTimeout(uiUpdateTimeout);
            }

            uiUpdateTimeout = setTimeout(() => {
                _doUpdateCreditsDisplay();
            }, 100); // 100msé˜²æŠ–
        };

        function _doUpdateCreditsDisplay() {
            const creditsElement = document.getElementById('creditsAmount');
            if (!creditsElement) {
                console.error('âŒ æ‰¾ä¸åˆ°ç§¯åˆ†æ˜¾ç¤ºå…ƒç´ ');
                return;
            }

            // å°è¯•å¤šä¸ªæ•°æ®æºè·å–ç§¯åˆ†
            let credits = 0;
            let source = 'unknown';

            // æ•°æ®æº1: window.currentUser
            if (window.currentUser && typeof window.currentUser.credits === 'number') {
                credits = window.currentUser.credits;
                source = 'window.currentUser';
            }
            // æ•°æ®æº2: window.creditsSync
            else if (window.creditsSync && typeof window.creditsSync.credits === 'number') {
                credits = window.creditsSync.credits;
                source = 'window.creditsSync';
            }
            // æ•°æ®æº3: localStorage
            else {
                try {
                    const userData = localStorage.getItem('flux_krea_user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        if (typeof user.credits === 'number') {
                            credits = user.credits;
                            source = 'localStorage';
                        }
                    }
                } catch (e) {
                    console.error('âŒ è§£ælocalStorageç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                }
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°UIï¼ˆé¿å…ä¸å¿…è¦çš„DOMæ“ä½œï¼‰
            const currentUIState = {
                credits: credits,
                hasUser: !!window.currentUser,
                userEmail: window.currentUser?.email || null
            };

            // å¦‚æœçŠ¶æ€æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°
            if (lastUIState &&
                lastUIState.credits === currentUIState.credits &&
                lastUIState.hasUser === currentUIState.hasUser &&
                lastUIState.userEmail === currentUIState.userEmail) {
                return; // çŠ¶æ€æœªå˜åŒ–ï¼Œè·³è¿‡æ›´æ–°
            }

            // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
            const displayCredits = window.currentUser ? credits : 20; // æœªç™»å½•æ˜¾ç¤º20
            if (creditsElement.textContent !== displayCredits.toString()) {
                creditsElement.textContent = displayCredits.toString();
            }

            // åŒæ­¥åˆ°ç§¯åˆ†ç®¡ç†å™¨
            if (window.creditsSync && window.creditsSync.credits !== credits) {
                window.creditsSync.setCredits(credits);
            }

            // ä¿å­˜å½“å‰çŠ¶æ€
            lastUIState = currentUIState;

            console.log(`âœ… ç§¯åˆ†æ˜¾ç¤ºå·²æ›´æ–°: ${displayCredits} (æ¥æº: ${source})`);
        }

        // å¼ºåŒ–ç§¯åˆ†åŒæ­¥æœºåˆ¶
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ç§¯åˆ†åŒæ­¥...');

            // å¼ºåˆ¶åˆå§‹åŒ–åŸºæœ¬åŠŸèƒ½
            setTimeout(() => {
                window.forceInitialize();
            }, 100);

            // å»¶è¿Ÿæ›´æ–°ç§¯åˆ†æ˜¾ç¤ºï¼Œé¿å…é¡µé¢åŠ è½½æ—¶çš„é—ªçƒ
            setTimeout(() => {
                updateCreditsDisplay();
            }, 200);

            // è®¾ç½®è·¨é¡µé¢çŠ¶æ€åŒæ­¥
            setupCrossPageSync();

            // å¤šæ¬¡å°è¯•ä»APIè·å–ç§¯åˆ†ï¼Œç¡®ä¿åŒæ­¥æˆåŠŸ
            const syncAttempts = [500, 1000, 2000, 3000, 5000]; // 0.5s, 1s, 2s, 3s, 5s

            syncAttempts.forEach((delay, index) => {
                setTimeout(function () {
                    console.log(`ğŸ”„ ç¬¬${index + 1}æ¬¡ç§¯åˆ†åŒæ­¥å°è¯• (${delay}mså)...`);

                    // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·æ•°æ®
                    const hasUser = window.currentUser || localStorage.getItem('flux_krea_user');

                    if (hasUser) {
                        console.log('âœ… å‘ç°ç”¨æˆ·æ•°æ®ï¼Œå¼€å§‹ä»APIè·å–ç§¯åˆ†...');
                        fetchCreditsFromAPI();
                    } else {
                        console.log('âš ï¸ æš‚æœªå‘ç°ç”¨æˆ·æ•°æ®ï¼Œè·³è¿‡æ­¤æ¬¡åŒæ­¥');
                        updateCreditsDisplay(); // ä»ç„¶å°è¯•æ›´æ–°æ˜¾ç¤º
                    }
                }, delay);
            });

            // æ¯30ç§’å®šæœŸåŒæ­¥ç§¯åˆ†
            setInterval(function () {
                if (window.currentUser || localStorage.getItem('flux_krea_user')) {
                    console.log('â° å®šæœŸç§¯åˆ†åŒæ­¥...');
                    fetchCreditsFromAPI();
                }
            }, 30000);

            // è°ƒè¯•ï¼šç¡®è®¤å‡½æ•°å·²å®šä¹‰
            console.log('ğŸ”§ è°ƒè¯•ä¿¡æ¯:');
            console.log('generateImageå‡½æ•°æ˜¯å¦å­˜åœ¨:', typeof window.generateImage);
            console.log('updateCreditsDisplayå‡½æ•°æ˜¯å¦å­˜åœ¨:', typeof window.updateCreditsDisplay);
            console.log('downloadImageå‡½æ•°æ˜¯å¦å­˜åœ¨:', typeof window.downloadImage);
            console.log('fetchCreditsFromAPIå‡½æ•°æ˜¯å¦å­˜åœ¨:', typeof window.fetchCreditsFromAPI);

            // GenerateæŒ‰é’®å·²é€šè¿‡onclickå±æ€§ç»‘å®šï¼Œæ— éœ€é‡å¤ç»‘å®š
            console.log('âœ… GenerateæŒ‰é’®é€šè¿‡onclickå±æ€§ç»‘å®š');
        });

        // ä¸‹è½½å›¾ç‰‡å‡½æ•°
        window.downloadImage = function (imageUrl) {
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = 'generated-image.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ä»APIè·å–ç§¯åˆ†çš„å‡½æ•°
        window.fetchCreditsFromAPI = async function () {
            try {
                console.log('ğŸ”„ ä»APIè·å–ç§¯åˆ†...');

                // è·å–ç”¨æˆ·æ ‡è¯†
                let userIdentifier = null;
                if (window.currentUser && window.currentUser.uuid) {
                    userIdentifier = window.currentUser.uuid;
                } else if (window.currentUser && window.currentUser.email) {
                    userIdentifier = window.currentUser.email;
                } else {
                    const userData = localStorage.getItem('flux_krea_user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        userIdentifier = user.uuid || user.email;
                    }
                }

                if (!userIdentifier) {
                    console.error('âŒ æ— æ³•è·å–ç”¨æˆ·æ ‡è¯†');
                    return;
                }

                console.log('ğŸ” ä½¿ç”¨ç”¨æˆ·æ ‡è¯†:', userIdentifier);

                const response = await fetch('/api/get-user-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userIdentifier: userIdentifier
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“¡ APIå“åº”:', data);

                    if (data.success) {
                        console.log('âœ… APIè¿”å›ç§¯åˆ†:', data.credits);

                        // æ›´æ–°æ‰€æœ‰æ•°æ®æº
                        if (window.currentUser) {
                            window.currentUser.credits = data.credits;
                        }

                        // ä½¿ç”¨æ–°çš„ç§¯åˆ†ç®¡ç†å™¨
                        if (window.creditsSync) {
                            window.creditsSync.setCredits(data.credits);
                        }

                        // æ›´æ–°localStorage
                        const userData = localStorage.getItem('flux_krea_user');
                        if (userData) {
                            const user = JSON.parse(userData);
                            user.credits = data.credits;
                            localStorage.setItem('flux_krea_user', JSON.stringify(user));
                        }

                        // ç¡®ä¿æ˜¾ç¤ºæ›´æ–°
                        updateCreditsDisplay();
                        return data.credits;
                    } else {
                        console.error('âŒ APIè¿”å›é”™è¯¯:', data);
                    }
                } else {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('âŒ è·å–ç§¯åˆ†å¤±è´¥:', error);
            }
        }

        // è°ƒè¯•å‡½æ•° - å¯ä»¥åœ¨æ§åˆ¶å°æ‰‹åŠ¨è°ƒç”¨
        window.testGenerate = function () {
            console.log('ğŸ§ª æµ‹è¯•Generateå‡½æ•°...');
            if (typeof window.generateImage === 'function') {
                console.log('âœ… generateImageå‡½æ•°å­˜åœ¨ï¼Œå¼€å§‹è°ƒç”¨...');
                window.generateImage();
            } else {
                console.error('âŒ generateImageå‡½æ•°ä¸å­˜åœ¨');
            }
        }

        // æ‰‹åŠ¨åˆ·æ–°ç§¯åˆ†çš„è°ƒè¯•å‡½æ•°
        window.refreshCredits = function () {
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°ç§¯åˆ†...');
            fetchCreditsFromAPI();
        }

        // ç§¯åˆ†ç®¡ç†å™¨æµ‹è¯•å‡½æ•°
        window.testCreditsManager = function () {
            console.log('ğŸ§ª æµ‹è¯•ç§¯åˆ†ç®¡ç†å™¨...');
            console.log('- creditsSyncå¯¹è±¡:', window.creditsSync);
            console.log('- å½“å‰ç§¯åˆ†:', window.creditsSync?.credits);
            console.log('- creditsAmountå…ƒç´ :', document.getElementById('creditsAmount'));
            console.log('- currentUser:', window.currentUser);

            // æµ‹è¯•è®¾ç½®ç§¯åˆ†
            if (window.creditsSync) {
                console.log('ğŸ”§ æµ‹è¯•è®¾ç½®ç§¯åˆ†ä¸º100...');
                window.creditsSync.setCredits(100);
            }
        }

        // ä¿®å¤ç”¨æˆ·çŠ¶æ€åŒæ­¥çš„å‡½æ•°
        window.fixUserState = function () {
            console.log('ğŸ”§ ä¿®å¤ç”¨æˆ·çŠ¶æ€åŒæ­¥...');

            // å°è¯•ä»localStorageæ¢å¤ç”¨æˆ·çŠ¶æ€
            try {
                const userData = localStorage.getItem('flux_krea_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    window.currentUser = user;
                    console.log('âœ… ä»localStorageæ¢å¤ç”¨æˆ·çŠ¶æ€:', user.email);

                    // åŒæ­¥ç§¯åˆ†
                    if (window.creditsSync && user.credits !== undefined) {
                        window.creditsSync.setCredits(user.credits);
                    }

                    return true;
                }
            } catch (error) {
                console.error('âŒ æ¢å¤ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
            }

            // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œåˆ›å»ºåŒ¿åç”¨æˆ·
            console.log('âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®ï¼Œåˆ›å»ºåŒ¿åç”¨æˆ·çŠ¶æ€');
            window.currentUser = {
                uuid: 'anonymous-' + Date.now(),
                email: 'anonymous@example.com',
                credits: 20,
                is_anonymous: true
            };

            if (window.creditsSync) {
                window.creditsSync.setCredits(20);
            }

            return false;
        }

        // å¼ºåˆ¶åˆå§‹åŒ–å‡½æ•° - ç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨
        window.forceInitialize = function () {
            console.log('ğŸš€ å¼ºåˆ¶åˆå§‹åŒ–é¡µé¢åŠŸèƒ½...');

            // 1. ä¿®å¤ç”¨æˆ·çŠ¶æ€
            window.fixUserState();

            // 2. ç¡®ä¿ç§¯åˆ†ç®¡ç†å™¨å­˜åœ¨
            if (!window.creditsSync) {
                window.creditsSync = new window.CreditsManager();
                console.log('âœ… åˆ›å»ºç§¯åˆ†ç®¡ç†å™¨');
            }

            // 3. GenerateæŒ‰é’®å·²é€šè¿‡onclickå±æ€§ç»‘å®šï¼Œæ— éœ€é‡å¤ç»‘å®š
            console.log('âœ… GenerateæŒ‰é’®å·²é€šè¿‡onclickç»‘å®š');

            // 4. æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
            if (window.updateCreditsDisplay) {
                window.updateCreditsDisplay();
            }

            console.log('âœ… å¼ºåˆ¶åˆå§‹åŒ–å®Œæˆ');
        }

        // æ—§çš„generateImageä»£ç å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨ImageGeneratorç±»

        // æ—§ä»£ç å·²æ¸…ç†

        // ç§¯åˆ†æ£€æŸ¥é€»è¾‘å·²ç§»è‡³ImageGeneratorç±»

        // è¾“å…¥éªŒè¯é€»è¾‘å·²ç§»è‡³ImageGeneratorç±»

        // DOMæ“ä½œé€»è¾‘å·²ç§»è‡³ImageGeneratorç±»

        // æ—§çš„generateImageä»£ç å·²å®Œå…¨æ¸…ç†

        // ç§¯åˆ†ç³»ç»Ÿå’Œç”¨æˆ·ç®¡ç† - Supabaseé›†æˆ
        const SUPABASE_URL = 'https://gdcjvqaqgvcxzufmessy.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkY2p2cWFxZ3ZjeHp1Zm1lc3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMDY2NTEsImV4cCI6MjA2OTc4MjY1MX0.wIblNpUZLgQcCJCVbKfae5n0jtcIshL9asVIit6iUBI'

        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });

        // å…¨å±€å˜é‡
        let currentUser = null;
        let systemSettings = {};

        // åŠ è½½ç³»ç»Ÿé…ç½®
        async function loadSystemSettings() {
            try {
                const { data, error } = await supabaseClient
                    .from('system_settings')
                    .select('key, value, data_type')
                    .eq('is_public', true);

                if (error) throw error;

                // è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
                data.forEach(setting => {
                    let value = setting.value;
                    if (setting.data_type === 'integer') {
                        value = parseInt(value);
                    } else if (setting.data_type === 'boolean') {
                        value = value === 'true';
                    }
                    systemSettings[setting.key] = value;
                });

                console.log('ç³»ç»Ÿé…ç½®åŠ è½½æˆåŠŸ:', systemSettings);
            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤å€¼
                systemSettings = {
                    default_credits: 20,
                    generation_cost: 10,
                    daily_free_credits: 5,
                    max_daily_generations: 10,
                    maintenance_mode: false,
                    welcome_message: 'Welcome to Flux Krea AI!'
                };
            }
        }

        /* DISABLED: Legacy UserManager (replaced by supabase-init + auth-bootstrap)
        class UserManager {
            constructor() {
                this.currentUser = window.preloadedUser || null;
                this.isInitialized = false;
            }
            
            // åˆå§‹åŒ–ç”¨æˆ·ç®¡ç†å™¨
            async initialize() {
                if (this.isInitialized) return;
                
                try {
                    console.log('ğŸ” åˆå§‹åŒ–ç”¨æˆ·ç®¡ç†å™¨...');
                    
                    // å¦‚æœæœ‰é¢„åŠ è½½çš„ç”¨æˆ·ï¼Œå…ˆä½¿ç”¨é¢„åŠ è½½æ•°æ®
                    if (window.preloadedUser) {
                        this.currentUser = window.preloadedUser;
                        currentUser = this.currentUser;
                        
                        // å¼‚æ­¥éªŒè¯å’Œæ›´æ–°ç”¨æˆ·çŠ¶æ€
                        this.validateAndUpdateUser();
                    } else {
                        // æ£€æŸ¥Supabaseä¼šè¯
                        const isLoggedIn = await checkSupabaseSession();
                        
                        if (isLoggedIn && currentUser) {
                            await this.handleAuthenticatedUser(currentUser);
                        } else {
                            await this.handleAnonymousUser();
                        }
                    }
                    
                    this.isInitialized = true;
                    console.log('âœ… ç”¨æˆ·ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('âŒ ç”¨æˆ·ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                    await this.handleAnonymousUser();
                }
            }
            
            // å¼‚æ­¥éªŒè¯å’Œæ›´æ–°ç”¨æˆ·çŠ¶æ€
            async validateAndUpdateUser() {
                try {
                    if (!this.currentUser || !this.currentUser.uuid) return;
                    
                    console.log('ğŸ”„ éªŒè¯ç”¨æˆ·çŠ¶æ€...');
                    
                    // æ£€æŸ¥Supabaseä¼šè¯æ˜¯å¦æœ‰æ•ˆ
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    
                    if (session && session.user) {
                        // ä»æ•°æ®åº“è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
                        const { data: latestUser, error } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('uuid', this.currentUser.uuid)
                            .single();
                        
                        if (!error && latestUser) {
                            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                            this.currentUser = { ...this.currentUser, ...latestUser };
                            currentUser = this.currentUser;
                            
                            // æ›´æ–°localStorage
                            localStorage.setItem('flux_krea_user', JSON.stringify(this.currentUser));
                            
                            // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
                            if (window.creditsSync) {
                                window.creditsSync.setCredits(latestUser.credits || 0);
                            }
                            
                            console.log('âœ… ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°:', latestUser.credits);
                        }
                    } else {
                        // ä¼šè¯æ— æ•ˆï¼Œæ¸…é™¤ç”¨æˆ·çŠ¶æ€
                        console.log('âš ï¸ ä¼šè¯æ— æ•ˆï¼Œæ¸…é™¤ç”¨æˆ·çŠ¶æ€');
                        this.currentUser = null;
                        currentUser = null;
                        localStorage.removeItem('flux_krea_user');
                        await this.handleAnonymousUser();
                    }
                } catch (error) {
                    console.error('âŒ éªŒè¯ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
                }
            }
            
            // å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜...
            async handleAuthenticatedUser(authUser) {
                // åŸæœ‰é€»è¾‘ä¿æŒä¸å˜
                console.log('å¤„ç†å·²è®¤è¯ç”¨æˆ·:', authUser);
                this.currentUser = authUser;
                currentUser = this.currentUser;
                this.updateUIForAuthenticatedUser();
            }
            
            async handleAnonymousUser() {
                // åŸæœ‰é€»è¾‘ä¿æŒä¸å˜
                console.log('å¤„ç†åŒ¿åç”¨æˆ·');
                this.currentUser = null;
                currentUser = null;
                this.updateUIForAnonymousUser();
            }
            
            updateUIForAuthenticatedUser() {
                const signinBtn = document.querySelector('.signin-btn');
                const creditsDisplay = document.getElementById('creditsDisplay');
                
                if (signinBtn && this.currentUser) {
                    signinBtn.innerHTML = `
                        <img src="${this.currentUser.avatar_url || 'https://via.placeholder.com/18'}" 
                             style="width: 18px; height: 18px; border-radius: 50%;" alt="Avatar">
                    `;
                    signinBtn.style.display = 'flex';
                }
                
                if (creditsDisplay) {
                    creditsDisplay.style.display = 'flex';
                }
            }
            
            updateUIForAnonymousUser() {
                const signinBtn = document.querySelector('.signin-btn');
                const creditsDisplay = document.getElementById('creditsDisplay');
                
                if (signinBtn) {
                    signinBtn.innerHTML = `
                        <div class="google-icon"></div>
                        <span>Sign in</span>
                    `;
                    signinBtn.style.display = 'flex';
                }
                
                if (creditsDisplay) {
                    creditsDisplay.style.display = 'flex';
                }
            }
        }
            
            /* LEGACY USER MANAGER DISABLED
            async initialize() {
                if (this.isInitialized) return;
                
                try {
                    // æ£€æŸ¥ç°æœ‰ä¼šè¯
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        await this.handleAuthenticatedUser(session.user);
                    } else {
                        await this.handleAnonymousUser();
                    }
                    
                    this.isInitialized = true;
                    console.log('ç”¨æˆ·ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('ç”¨æˆ·ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                    // é™çº§åˆ°æœ¬åœ°å­˜å‚¨æ¨¡å¼
                    await this.handleAnonymousUser();
                }
            }
            
            // å¤„ç†å·²è®¤è¯ç”¨æˆ·
            async handleAuthenticatedUser(authUser) {
                try {
                    console.log('å¤„ç†å·²è®¤è¯ç”¨æˆ·:', authUser);
                    
                    // ä»¥Google IDä¸ºä¸»è¦æ ‡è¯†æŸ¥æ‰¾ç”¨æˆ·
                    let { data: user, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('google_id', authUser.id)
                        .single();
                    
                    if (error && error.code === 'PGRST116') {
                        // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰åŒ¿åç”¨æˆ·éœ€è¦å‡çº§
                        const anonymousUuid = getUserUUID();
                        
                        // æŸ¥æ‰¾åŒ¹é…çš„åŒ¿åç”¨æˆ·ï¼ˆé€šè¿‡æŒ‡çº¹æˆ–UUIDï¼‰
                        const fingerprint = generateUserFingerprint();
                        let { data: anonymousUser, error: anonError } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('fingerprint', fingerprint)
                            .eq('is_signed_in', false)
                            .single();
                        
                        if (anonError && anonError.code === 'PGRST116') {
                            // é€šè¿‡UUIDæŸ¥æ‰¾
                            const { data: uuidUser, error: uuidError } = await supabaseClient
                                .from('users')
                                .select('*')
                                .eq('uuid', anonymousUuid)
                                .eq('is_signed_in', false)
                                .single();
                            
                            if (!uuidError) {
                                anonymousUser = uuidUser;
                            }
                        }
                        
                        if (anonymousUser) {
                            // å‡çº§ç°æœ‰åŒ¿åç”¨æˆ·ä¸ºè®¤è¯ç”¨æˆ·
                            console.log('å‡çº§åŒ¿åç”¨æˆ·ä¸ºè®¤è¯ç”¨æˆ·:', anonymousUser.uuid);
                            const { data: upgradedUser, error: upgradeError } = await supabaseClient
                                .from('users')
                                .update({
                                    is_signed_in: true,
                                    google_id: authUser.id,
                                    email: authUser.email,
                                    name: authUser.user_metadata?.full_name || authUser.email,
                                    avatar_url: authUser.user_metadata?.avatar_url,
                                    last_seen_at: new Date().toISOString()
                                })
                                .eq('id', anonymousUser.id)
                                .select()
                                .single();
                                
                            if (upgradeError) throw upgradeError;
                            user = upgradedUser;
                            
                            console.log('åŒ¿åç”¨æˆ·å‡çº§æˆåŠŸï¼Œä¿ç•™åŸæœ‰ç§¯åˆ†:', user.credits);
                        } else {
                            // åˆ›å»ºæ–°çš„è®¤è¯ç”¨æˆ·
                            console.log('åˆ›å»ºæ–°çš„è®¤è¯ç”¨æˆ·');
                            user = await this.createUserRecord(authUser);
                        }
                    } else if (error) {
                        throw error;
                    } else {
                        // ç”¨æˆ·å­˜åœ¨ï¼Œæ›´æ–°æœ€åè®¿é—®æ—¶é—´
                        console.log('å·²å­˜åœ¨è®¤è¯ç”¨æˆ·ï¼Œæ›´æ–°è®¿é—®æ—¶é—´');
                        await supabaseClient
                            .from('users')
                            .update({ 
                                last_seen_at: new Date().toISOString(),
                                name: authUser.user_metadata?.full_name || user.name,
                                avatar_url: authUser.user_metadata?.avatar_url || user.avatar_url
                            })
                            .eq('id', user.id);
                    }
                    
                    this.currentUser = { ...user, ...authUser.user_metadata };
                    currentUser = this.currentUser;
                    
                    // åŒæ­¥ç”¨æˆ·çŠ¶æ€åˆ°å…¶ä»–é¡µé¢
                    if (window.userStateSync) {
                        window.userStateSync.setCurrentUser(this.currentUser);
                    }
                    
                    this.updateUIForAuthenticatedUser();
                    
                    // ç«‹å³åŒæ­¥ç§¯åˆ†æ˜¾ç¤º
                    if (window.creditsSync && this.currentUser.credits !== undefined) {
                        window.creditsSync.setCredits(this.currentUser.credits);
                        console.log('âœ… ç™»å½•åç§¯åˆ†å·²åŒæ­¥:', this.currentUser.credits);
                    }
                    
                    // ä»APIè·å–æœ€æ–°ç§¯åˆ†
                    setTimeout(() => {
                        if (window.fetchCreditsFromAPI) {
                            window.fetchCreditsFromAPI();
                        }
                    }, 500);
                    
                    console.log('ç”¨æˆ·è®¤è¯å®Œæˆ:', this.currentUser);
                    
                } catch (error) {
                    console.error('å¤„ç†è®¤è¯ç”¨æˆ·å¤±è´¥:', error);
                    await this.handleAnonymousUser();
                }
            }
            
            // å¤„ç†åŒ¿åç”¨æˆ·
            async handleAnonymousUser() {
                const uuid = getUserUUID();
                const fingerprint = generateUserFingerprint();
                const ip = await getUserIP();
                const userIdentifier = await generateUserIdentifier();
                
                try {
                    // è®¾ç½®åŒ¿åç”¨æˆ·ä¸Šä¸‹æ–‡
                    await supabaseClient.rpc('set_user_context', { user_uuid: uuid });
                    
                    // ğŸ”’ å…³é”®é˜²åˆ·é€»è¾‘ï¼šä¼˜å…ˆé€šè¿‡æŒ‡çº¹æŸ¥æ‰¾ç°æœ‰ç”¨æˆ·
                    console.log('ğŸ” å¼€å§‹ç”¨æˆ·æŸ¥æ‰¾ - é˜²åˆ·æ£€æŸ¥:', {
                        fingerprint: fingerprint.substring(0, 20) + '...',
                        uuid: uuid,
                        ip: ip
                    });
                    
                    let user = null;
                    
                    // ç¬¬ä¸€æ­¥ï¼šé€šè¿‡æŒ‡çº¹æŸ¥æ‰¾ï¼ˆæœ€é‡è¦çš„é˜²åˆ·æ‰‹æ®µï¼‰
                    let { data: fingerprintUsers, error: fingerprintError } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('fingerprint', fingerprint)
                        .eq('is_signed_in', false);
                    
                    if (!fingerprintError && fingerprintUsers && fingerprintUsers.length > 0) {
                        user = fingerprintUsers[0];
                        console.log('ğŸ”’ é€šè¿‡æŒ‡çº¹æ‰¾åˆ°ç°æœ‰ç”¨æˆ· - é˜²æ­¢ç§¯åˆ†é‡ç½®:', {
                            uuid: user.uuid,
                            fingerprint: user.fingerprint.substring(0, 20) + '...',
                            credits: user.credits,
                            totalEarned: user.total_credits_earned,
                            createdAt: user.created_at,
                            lastSeen: user.last_seen_at
                        });
                        
                        console.log('ğŸ’° æŒ‡çº¹åŒ¹é… - ä¿æŒç§¯åˆ†çŠ¶æ€:', user.credits, '(ä¸é‡æ–°åˆ†é…20ç§¯åˆ†)');
                        
                    } else {
                        // ç¬¬äºŒæ­¥ï¼šå¦‚æœæŒ‡çº¹æ²¡æ‰¾åˆ°ï¼Œå°è¯•UUIDæŸ¥æ‰¾
                        let { data: uuidUsers, error: uuidError } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('uuid', uuid)
                            .eq('is_signed_in', false);
                        
                        if (!uuidError && uuidUsers && uuidUsers.length > 0) {
                            user = uuidUsers[0];
                            console.log('ğŸ†” é€šè¿‡UUIDæ‰¾åˆ°ç°æœ‰ç”¨æˆ·:', {
                                uuid: user.uuid,
                                credits: user.credits,
                                fingerprint: user.fingerprint?.substring(0, 20) + '...' || 'none'
                            });
                        }
                    }
                    
                    if (user) {
                        // æ‰¾åˆ°ç°æœ‰ç”¨æˆ·ï¼Œæ›´æ–°ä¿¡æ¯ä½†ä¿æŒç§¯åˆ†ä¸å˜
                        console.log('âœ… ç°æœ‰ç”¨æˆ· - æ›´æ–°ä¿¡æ¯ä½†ä¿æŒç§¯åˆ†:', user.credits);
                        
                        await supabaseClient
                            .from('users')
                            .update({
                                uuid: uuid,
                                user_identifier: userIdentifier,
                                fingerprint: fingerprint,
                                ip_address: ip,
                                last_seen_at: new Date().toISOString()
                                // ğŸ”’ å…³é”®ï¼šä¸æ›´æ–°creditså­—æ®µï¼Œä¿æŒåŸæœ‰ç§¯åˆ†çŠ¶æ€
                            })
                            .eq('id', user.id);
                        
                        // æ›´æ–°æœ¬åœ°UUID
                        localStorage.setItem('user_uuid', user.uuid);
                        
                    } else {
                        // æ²¡æœ‰æ‰¾åˆ°åŒ¹é…ç”¨æˆ·ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯çœŸæ­£çš„æ–°ç”¨æˆ·
                        console.log('æœªæ‰¾åˆ°ç°æœ‰ç”¨æˆ·ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºæ–°ç”¨æˆ·...');
                    
                        // åˆ›å»ºæ–°çš„åŒ¿åç”¨æˆ·è®°å½•
                        console.log('åˆ›å»ºæ–°åŒ¿åç”¨æˆ·:', { uuid, fingerprint, ip });
                        const { data: newUser, error: createError } = await supabaseClient
                            .from('users')
                            .insert({
                                uuid: uuid,
                                user_identifier: userIdentifier,
                                fingerprint: fingerprint,
                                ip_address: ip,
                                user_agent: navigator.userAgent,
                                language: navigator.language,
                                platform: navigator.platform,
                                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                                screen_resolution: `${screen.width}x${screen.height}`,
                                credits: systemSettings.default_credits || 20,
                                total_credits_earned: systemSettings.default_credits || 20,
                                is_signed_in: false
                            })
                            .select()
                            .single();
                        
                        if (createError) {
                            console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', createError);
                            throw createError;
                        }
                        user = newUser;
                        
                        // è®°å½•åˆå§‹ç§¯åˆ†
                        await this.addCreditTransaction(user.id, uuid, 'EARN', systemSettings.default_credits || 20, 
                            'æ–°ç”¨æˆ·å¥–åŠ±', 'anonymous_bonus');
                    }
                    
                    if (user) {
                        // æ›´æ–°æœ€åè®¿é—®æ—¶é—´
                        await supabaseClient
                            .from('users')
                            .update({ last_seen_at: new Date().toISOString() })
                            .eq('id', user.id);
                    }
                    
                    this.currentUser = user;
                    currentUser = this.currentUser;
                    
                    // åŒæ­¥ç”¨æˆ·çŠ¶æ€åˆ°å…¶ä»–é¡µé¢
                    if (window.userStateSync) {
                        window.userStateSync.setCurrentUser(this.currentUser);
                    }
                    
                    this.updateUIForAnonymousUser();
                    
                } catch (error) {
                    console.error('å¤„ç†åŒ¿åç”¨æˆ·å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼:', error);
                    this.handleLocalMode();
                }
            }
            
            // æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼ˆæ•°æ®åº“ä¸å¯ç”¨æ—¶çš„é™çº§æ–¹æ¡ˆï¼‰
            handleLocalMode() {
                const uuid = getUserUUID();
                const credits = parseInt(localStorage.getItem('user_credits')) || systemSettings.default_credits || 20;
                
                this.currentUser = {
                    uuid: uuid,
                    credits: credits,
                    is_local_mode: true
                };
                currentUser = this.currentUser;
                
                // åŒæ­¥ç”¨æˆ·çŠ¶æ€åˆ°å…¶ä»–é¡µé¢
                if (window.userStateSync) {
                    window.userStateSync.setCurrentUser(this.currentUser);
                }
                
                console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
                this.updateUIForAnonymousUser();
            }
            
            
            // åˆ›å»ºç”¨æˆ·è®°å½•ï¼ˆä»¥Google IDä¸ºä¸»è¦æ ‡è¯†ï¼‰
            async createUserRecord(authUser, existingUuid = null) {
                const userUuid = existingUuid || getUserUUID();
                const fingerprint = generateUserFingerprint();
                const ip = await getUserIP();
                const userIdentifier = await generateUserIdentifier();
                
                const userData = {
                    uuid: userUuid,
                    google_id: authUser.id,
                    email: authUser.email,
                    name: authUser.user_metadata?.full_name || authUser.email,
                    avatar_url: authUser.user_metadata?.avatar_url,
                    user_identifier: userIdentifier,
                    fingerprint: fingerprint,
                    ip_address: ip,
                    user_agent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    credits: systemSettings.default_credits || 20,
                    total_credits_earned: systemSettings.default_credits || 20,
                    is_signed_in: true
                };
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert(userData)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // å¼ºåˆ¶ç¡®ä¿ç§¯åˆ†è®¾ç½®ä¸º20ï¼ˆé˜²æ­¢æ•°æ®åº“é»˜è®¤å€¼é—®é¢˜ï¼‰
                const { error: creditsError } = await supabaseClient
                    .from('users')
                    .update({ 
                        credits: 20, 
                        total_credits_earned: 20 
                    })
                    .eq('id', data.id);
                
                if (creditsError) {
                    console.error('âŒ å¼ºåˆ¶è®¾ç½®ç§¯åˆ†å¤±è´¥:', creditsError);
                } else {
                    console.log('âœ… å¼ºåˆ¶è®¾ç½®ç§¯åˆ†æˆåŠŸ: 20');
                }
                
                // è®°å½•åˆå§‹ç§¯åˆ†
                await this.addCreditTransaction(
                    data.id, 
                    userUuid, 
                    'EARN', 
                    systemSettings.default_credits || 20, 
                    'æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±', 
                    'signup_bonus'
                );
                
                // ç«‹å³åŒæ­¥åˆ°å‰ç«¯çŠ¶æ€
                if (window.UnifiedStateSync) {
                    window.UnifiedStateSync.setCredits(20);
                    console.log('âœ… å‰ç«¯ç§¯åˆ†çŠ¶æ€å·²åŒæ­¥: 20');
                }
                
                // ç¡®ä¿è¿”å›çš„æ•°æ®åŒ…å«æ­£ç¡®çš„ç§¯åˆ†
                data.credits = 20;
                data.total_credits_earned = 20;
                
                return data;
            }
            
            // æ›´æ–°è®¤è¯ç”¨æˆ·ç•Œé¢
            updateUIForAuthenticatedUser() {
                const signinBtn = document.querySelector('.signin-btn');
                if (signinBtn && this.currentUser) {
                    signinBtn.innerHTML = `
                        <img src="${this.currentUser.avatar_url || 'https://via.placeholder.com/32'}" 
                             alt="User Avatar" class="user-avatar">
                    `;
                    // signinBtn.onclick = () => this.showUserMenu(); // å·²ç¦ç”¨ï¼Œä½¿ç”¨ç»Ÿä¸€çš„handleSignInClick
                    signinBtn.style.padding = '4px';
                    signinBtn.style.border = 'none';
                    signinBtn.style.boxShadow = 'none';
                    signinBtn.style.background = 'transparent';
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜è´¦æˆ·ï¼Œæ˜¾ç¤ºè°ƒè¯•æŒ‰é’®
                this.checkAndShowDebugButton();
            }
            
            // æ›´æ–°åŒ¿åç”¨æˆ·ç•Œé¢
            updateUIForAnonymousUser() {
                const signinBtn = document.querySelector('.signin-btn');
                if (signinBtn) {
                    signinBtn.innerHTML = `
                        <div class="google-icon"></div>
                        <span>Sign in</span>
                    `;
                    // signinBtn.onclick = () => this.signInWithGoogle(); // å·²ç¦ç”¨ï¼Œä½¿ç”¨ç»Ÿä¸€çš„handleSignInClick
                }
                
                // éšè—è°ƒè¯•æŒ‰é’®ï¼ˆåŒ¿åç”¨æˆ·ï¼‰
                const debugBtn = document.getElementById('debugRefreshBtn');
                if (debugBtn) {
                    debugBtn.style.display = 'none';
                }
            }
            
            // æ£€æŸ¥ç®¡ç†å‘˜æƒé™å¹¶æ˜¾ç¤ºè°ƒè¯•æŒ‰é’®
            checkAndShowDebugButton() {
                const debugBtn = document.getElementById('debugRefreshBtn');
                if (debugBtn && this.currentUser) {
                    // ä»…å¯¹ç‰¹å®šé‚®ç®±æ˜¾ç¤ºè°ƒè¯•æŒ‰é’®
                    const adminEmails = ['sunwei7482@gmail.com'];
                    const userEmail = this.currentUser.email;
                    
                    if (adminEmails.includes(userEmail)) {
                        debugBtn.style.display = 'inline-block';
                        console.log('ğŸ”§ ç®¡ç†å‘˜è°ƒè¯•æ¨¡å¼å·²å¯ç”¨:', userEmail);
                    } else {
                        debugBtn.style.display = 'none';
                    }
                } else if (debugBtn) {
                    debugBtn.style.display = 'none';
                }
            }
            
            // æ˜¾ç¤ºç”¨æˆ·èœå•
            showUserMenu() {
                showSignoutModal();
            }
            
            // Googleç™»å½•
            async signInWithGoogle() {
                try {
                    console.log('å¼€å§‹Googleç™»å½•...');
                    
                    const { data, error } = await supabaseClient.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: `${window.location.origin}`,
                            queryParams: {
                                access_type: 'offline',
                                prompt: 'consent',
                            },
                        }
                    });
                    
                    if (error) {
                        console.error('Googleç™»å½•é”™è¯¯:', error);
                        throw error;
                    }
                    
                    console.log('Googleç™»å½•æˆåŠŸ:', data);
                } catch (error) {
                    console.error('Googleç™»å½•å¤±è´¥:', error);
                    
                    if (error.message && error.message.includes('provider is not enabled')) {
                        alert('è¯·æ£€æŸ¥Supabaseä¸­çš„Google OAuthé…ç½®ï¼š\n1. Authentication > Providers > Google\n2. ç¡®ä¿"Enable sign in with Google"å·²å¼€å¯\n3. æ£€æŸ¥Client IDå’ŒClient Secretæ˜¯å¦æ­£ç¡®å¡«å…¥');
                    } else {
                        alert('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š' + (error.message || error));
                    }
                }
            }
            
            // é€€å‡ºç™»å½•
            async signOut() {
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    
                    // é‡æ–°åˆå§‹åŒ–ä¸ºåŒ¿åç”¨æˆ·
                    await this.handleAnonymousUser();
                } catch (error) {
                    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                }
            }
            
            // æ·»åŠ ç§¯åˆ†äº¤æ˜“è®°å½•
            async addCreditTransaction(userId, userUuid, type, amount, description, source, relatedResourceId = null) {
                try {
                    const balanceAfter = this.currentUser.credits + (type === 'EARN' ? amount : -amount);
                    
                    const { error } = await supabaseClient
                        .from('credit_transactions')
                        .insert({
                            user_id: userId,
                            user_uuid: userUuid,
                            transaction_type: type,
                            amount: type === 'EARN' ? amount : -amount,
                            balance_after: balanceAfter,
                            description: description,
                            source: source,
                            related_resource_id: relatedResourceId
                        });
                    
                    if (error) throw error;
                } catch (error) {
                    console.error('æ·»åŠ ç§¯åˆ†äº¤æ˜“è®°å½•å¤±è´¥:', error);
                }
            }
        }
        */
        // LEGACY BLOCK ENDS

        // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜ç”¨æˆ·
        function isAdminUser() {
            const adminEmails = ['sunwei7482@gmail.com'];
            return currentUser && currentUser.email && adminEmails.includes(currentUser.email);
        }

        // ç”Ÿæˆç”¨æˆ·æŒ‡çº¹ï¼ˆå¢å¼ºç‰ˆï¼ŒåŒ…å«æ›´å¤šè®¾å¤‡ç‰¹å¾ï¼‰
        function generateUserFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('User fingerprint', 2, 2);

            const fingerprint = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages ? navigator.languages.join(',') : '',
                platform: navigator.platform,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                screen: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                pixelDepth: screen.pixelDepth,
                deviceMemory: navigator.deviceMemory || 'unknown',
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack || 'unknown',
                canvas: canvas.toDataURL(),
                webgl: getWebGLFingerprint()
            };

            return btoa(JSON.stringify(fingerprint)).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
        }

        // è·å–WebGLæŒ‡çº¹
        function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'no-webgl';

                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                const vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown';
                const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';

                return `${vendor}_${renderer}`.substring(0, 50);
            } catch (e) {
                return 'webgl-error';
            }
        }

        // è·å–æˆ–åˆ›å»ºç”¨æˆ· UUID
        function getUserUUID() {
            let uuid = localStorage.getItem('user_uuid');
            if (!uuid) {
                uuid = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('user_uuid', uuid);
            }
            return uuid;
        }

        // è·å–ç”¨æˆ· IP
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('æ— æ³•è·å–IPåœ°å€');
                return 'unknown';
            }
        }

        // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·æ ‡è¯†
        async function generateUserIdentifier() {
            const uuid = getUserUUID();
            const fingerprint = generateUserFingerprint();
            const ip = await getUserIP();

            return `${uuid}_${fingerprint}_${ip}`.replace(/[^a-zA-Z0-9_]/g, '');
        }

        /* DISABLED: Legacy CreditsManager (replaced by UnifiedStateSync)
         * This class was using the disabled UserManager and has been replaced
         * by the UnifiedStateSync module which handles both user and credits management.
         */


        // åˆå§‹åŒ–ç³»ç»Ÿ - ç°åœ¨ä½¿ç”¨UnifiedStateSync
        console.log('âœ… ç³»ç»Ÿå°†ä½¿ç”¨UnifiedStateSyncè¿›è¡ŒçŠ¶æ€ç®¡ç†');

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®ï¼Œå¦‚æœæ˜¯åˆ™è·³è½¬åˆ°showcase
                const hasVisitedBefore = localStorage.getItem('flux_krea_visited');
                const urlParams = new URLSearchParams(window.location.search);
                const skipShowcase = urlParams.get('skip_showcase') === 'true';

                // å¦‚æœä¸æ˜¯é¦–æ¬¡è®¿é—®æˆ–è€…URLä¸­æœ‰è·³è¿‡showcaseçš„å‚æ•°ï¼Œåˆ™æ­£å¸¸åˆå§‹åŒ–
                if (hasVisitedBefore || skipShowcase || window.location.hash) {
                    await normalPageInitialization();
                } else {
                    // é¦–æ¬¡è®¿é—®ï¼Œæ ‡è®°å·²è®¿é—®å¹¶è·³è½¬åˆ°showcase
                    localStorage.setItem('flux_krea_visited', 'true');

                    // å»¶è¿Ÿè·³è½¬ï¼Œè®©é¡µé¢ç¨å¾®åŠ è½½ä¸€ä¸‹
                    setTimeout(() => {
                        window.location.href = 'showcase.html';
                    }, 500);
                    return;
                }

            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿè¿›è¡Œæ­£å¸¸åˆå§‹åŒ–
                await normalPageInitialization();
            }
        });

        // æ­£å¸¸é¡µé¢åˆå§‹åŒ–é€»è¾‘
        async function normalPageInitialization() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const creditsElement = document.getElementById('creditsAmount');
                if (creditsElement) {
                    creditsElement.textContent = '--';
                }

                // 1. åŠ è½½ç³»ç»Ÿé…ç½®
                await loadSystemSettings();

                // 2. ä½¿ç”¨ç»Ÿä¸€çŠ¶æ€ç®¡ç†å™¨ï¼ˆUnifiedStateSyncå·²è‡ªåŠ¨åˆå§‹åŒ–ï¼‰
                console.log('âœ… ä½¿ç”¨UnifiedStateSyncä½œä¸ºç»Ÿä¸€çŠ¶æ€ç®¡ç†å™¨');

                // ç­‰å¾…UnifiedStateSyncåˆå§‹åŒ–å®Œæˆ
                if (window.UnifiedStateSync && !window.UnifiedStateSync.isInitialized) {
                    await window.UnifiedStateSync.initialize();
                }

                // 3. è®¾ç½®å…¼å®¹æ€§å¼•ç”¨
                window.currentUser = window.UnifiedStateSync?.getCurrentUser() || null;
                console.log('âœ… å½“å‰ç”¨æˆ·çŠ¶æ€:', window.currentUser?.email || 'æœªç™»å½•');

                // 4. åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
                // (å·²ç§»é™¤showcaseåˆå§‹åŒ–ï¼Œå› ä¸ºç°åœ¨ä½¿ç”¨ç‹¬ç«‹é¡µé¢)

                // 5. UnifiedStateSyncå·²ç»å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–ï¼Œè¿™é‡Œåªå¤„ç†ç‰¹æ®Šé€»è¾‘
                // å¢å¼ºçš„ç™»å½•æˆåŠŸå¤„ç†
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–:', event, session?.user?.email);

                    if (event === 'SIGNED_IN' && session) {
                        // ç¡®ä¿ç§¯åˆ†åŒæ­¥
                        setTimeout(async () => {
                            const credits = await window.UnifiedStateSync.syncCreditsFromAPI();
                            if (credits !== null) {
                                console.log('âœ… ç™»å½•åç§¯åˆ†åŒæ­¥æˆåŠŸ:', credits);
                            } else {
                                console.log('âš ï¸ ç™»å½•åç§¯åˆ†åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                                // å¦‚æœåŒæ­¥å¤±è´¥ï¼Œç¡®ä¿è‡³å°‘æœ‰åŸºç¡€ç§¯åˆ†
                                if (window.UnifiedStateSync.getCredits() === 0) {
                                    window.UnifiedStateSync.setCredits(20);
                                }
                            }
                        }, 1000);
                        
                        // æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬åˆ°pricingé¡µé¢
                        const redirectTarget = localStorage.getItem('redirect_after_signin');
                        if (redirectTarget === 'pricing') {
                            localStorage.removeItem('redirect_after_signin');

                            // æ˜¾ç¤ºåŠ è½½æç¤ºï¼Œç„¶åè·³è½¬
                            showLoadingModal('æ­£åœ¨è·³è½¬åˆ°å®šä»·é¡µé¢...');
                            setTimeout(() => {
                                window.location.href = 'pricing.html';
                            }, 1000);
                        }
                    }
                });

                console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);

                // é™çº§åˆ°æœ¬åœ°æ¨¡å¼ - ä½¿ç”¨UnifiedStateSyncçš„é™çº§å¤„ç†
                console.log('ğŸ”„ å¯ç”¨é™çº§æ¨¡å¼...');

                // ç¡®ä¿åŸºæœ¬çš„ç”¨æˆ·çŠ¶æ€å¯ç”¨
                if (!window.currentUser) {
                    window.currentUser = null;
                }

                // ç¡®ä¿ç§¯åˆ†æ˜¾ç¤ºå‡½æ•°å¯ç”¨
                if (typeof window.updateCreditsDisplay === 'function') {
                    window.updateCreditsDisplay();
                }
            }
        }

        // å›¾åƒç”ŸæˆåŠŸèƒ½ - å®Œå…¨ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼
        // Login Modal Functions
        function showLoginModal() {
            const modal = document.getElementById('loginRequiredModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginRequiredModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }



        // è¾…åŠ©å‡½æ•°
        function downloadImage(imageUrl, filename) {
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function shareImage(imageUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Flux Krea AIç”Ÿæˆçš„å›¾åƒ',
                    url: imageUrl
                });
            } else {
                navigator.clipboard.writeText(imageUrl).then(() => {
                    alert('å›¾åƒé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    alert('æ— æ³•å¤åˆ¶é“¾æ¥ï¼š' + imageUrl);
                });
            }
        }

        function scrollToGenerator() {
            document.getElementById('generator').scrollIntoView({ behavior: 'smooth' });
        }

        // Demo generation function
        function demoGenerate(demoPrompt) {
            document.getElementById('prompt').value = demoPrompt;
            document.getElementById('prompt').scrollIntoView({ behavior: 'smooth' });
        }

        // æ»‘å—æ›´æ–°äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function () {
            // åˆå§‹åŒ–æ»‘å—äº‹ä»¶
            const stepsSlider = document.getElementById('stepsSlider');
            if (stepsSlider) {
                stepsSlider.addEventListener('input', function () {
                    document.getElementById('stepsValue').textContent = this.value;
                });
            }
        });

        // æ˜¾ç¤ºè®¤è¯å¼¹çª—ï¼ˆæœªç™»å½•ç”¨æˆ·ç‚¹å‡»ç”Ÿæˆæ—¶ï¼‰- ä¿æŒå…¼å®¹æ€§
        function showAuthenticationModal() {
            window.showCreditsModal();
        }

        // å¤„ç†ç™»å½•æŒ‰é’®ç‚¹å‡»ï¼ˆç»Ÿä¸€ä½¿ç”¨ UnifiedStateSyncï¼‰
        async function handleSignInClick() {
            try {
                if (!window.UnifiedStateSync) {
                    throw new Error('ç»Ÿä¸€çŠ¶æ€åŒæ­¥å™¨æœªåŠ è½½');
                }

                // æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€ï¼Œå†³å®šæ˜¯ç™»å½•è¿˜æ˜¯ç™»å‡º
                const currentUser = window.UnifiedStateSync.getCurrentUser();

                if (currentUser) {
                    // å·²ç™»å½•ï¼Œæ‰§è¡Œç™»å‡º
                    console.log('ğŸ”“ å¼€å§‹ç™»å‡º...');
                    await window.UnifiedStateSync.signOut();
                    console.log('âœ… ç™»å‡ºæˆåŠŸ');
                } else {
                    // æœªç™»å½•ï¼Œæ‰§è¡Œç™»å½•
                    console.log('ğŸ” å¼€å§‹Googleç™»å½•...');
                    await window.UnifiedStateSync.signIn();
                    console.log('âœ… ç™»å½•æµç¨‹å·²å¯åŠ¨');
                }
            } catch (error) {
                console.error('âŒ ç™»å½•/ç™»å‡ºæ“ä½œå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // è®¾ç½®è·¨é¡µé¢çŠ¶æ€åŒæ­¥
        function setupCrossPageSync() {
            // ç›‘å¬localStorageå˜åŒ–ï¼ˆè·¨é¡µé¢åŒæ­¥ï¼‰
            window.addEventListener('storage', function (e) {
                if (e.key === 'flux_krea_state_change') {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°è·¨é¡µé¢çŠ¶æ€å˜åŒ–ï¼Œé‡æ–°åŒæ­¥...');

                    // é‡æ–°åŠ è½½ç”¨æˆ·æ•°æ®
                    const userData = localStorage.getItem('flux_krea_user');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            console.log('ğŸ“¥ ä»localStorageåŒæ­¥ç”¨æˆ·æ•°æ®:', user);

                            // æ›´æ–°å…¨å±€ç”¨æˆ·çŠ¶æ€
                            window.currentUser = user;

                            // æ›´æ–°ç»Ÿä¸€çŠ¶æ€ç®¡ç†å™¨
                            if (window.UnifiedStateSync) {
                                window.UnifiedStateSync.updateUserData(user);
                            }

                            // æ›´æ–°ç§¯åˆ†ç®¡ç†å™¨
                            if (window.creditsSync) {
                                window.creditsSync.setCredits(user.credits || 0);
                            }

                            // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
                            if (window.updateCreditsDisplay) {
                                window.updateCreditsDisplay();
                            }

                            console.log('âœ… è·¨é¡µé¢çŠ¶æ€åŒæ­¥å®Œæˆï¼Œæ–°ç§¯åˆ†:', user.credits);
                        } catch (error) {
                            console.error('âŒ è·¨é¡µé¢çŠ¶æ€åŒæ­¥å¤±è´¥:', error);
                        }
                    }
                }
            });

            // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼ˆåŒé¡µé¢å†…åŒæ­¥ï¼‰
            window.addEventListener('userStateUpdated', function (e) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°ç”¨æˆ·çŠ¶æ€æ›´æ–°äº‹ä»¶:', e.detail);

                if (e.detail.user) {
                    // æ›´æ–°å…¨å±€ç”¨æˆ·çŠ¶æ€
                    window.currentUser = e.detail.user;

                    // æ›´æ–°ç»Ÿä¸€çŠ¶æ€ç®¡ç†å™¨
                    if (window.UnifiedStateSync) {
                        window.UnifiedStateSync.updateUserData(e.detail.user);
                    }

                    // æ›´æ–°ç§¯åˆ†ç®¡ç†å™¨
                    if (window.creditsSync) {
                        window.creditsSync.setCredits(e.detail.user.credits || 0);
                    }
                }

                // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
                if (window.updateCreditsDisplay) {
                    window.updateCreditsDisplay();
                }

                console.log('âœ… ç”¨æˆ·çŠ¶æ€æ›´æ–°å®Œæˆ');
            });

            console.log('âœ… è·¨é¡µé¢çŠ¶æ€åŒæ­¥ç›‘å¬å™¨å·²è®¾ç½®');
        }
    
        // ç®¡ç†å‘˜åŠŸèƒ½ï¼šé‡ç½®ç”¨æˆ·ç§¯åˆ†
        window.resetUserCredits = async function(userEmail, newCredits = 20) {
            if (!window.UnifiedStateSync || !window.UnifiedStateSync.getCurrentUser()) {
                console.error('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æ‰§è¡Œé‡ç½®æ“ä½œ');
                return false;
            }

            const currentUser = window.UnifiedStateSync.getCurrentUser();
            
            // ç®€å•çš„ç®¡ç†å‘˜æ£€æŸ¥ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥æœ‰æ›´ä¸¥æ ¼çš„æƒé™æ§åˆ¶ï¼‰
            const adminEmails = ['admin@example.com', 'test@example.com'];
            if (!adminEmails.includes(currentUser.email)) {
                console.error('âŒ æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œé‡ç½®æ“ä½œ');
                return false;
            }

            try {
                console.log(`ğŸ”§ å¼€å§‹é‡ç½®ç”¨æˆ·ç§¯åˆ†: ${userEmail} -> ${newCredits}`);
                
                // å¦‚æœæ˜¯é‡ç½®å½“å‰ç”¨æˆ·çš„ç§¯åˆ†
                if (userEmail === currentUser.email) {
                    const success = await window.UnifiedStateSync.addCredits(
                        newCredits - window.UnifiedStateSync.getCredits(), 
                        'ç®¡ç†å‘˜é‡ç½®ç§¯åˆ†'
                    );
                    
                    if (success) {
                        console.log(`âœ… ç§¯åˆ†é‡ç½®æˆåŠŸ: ${userEmail} -> ${newCredits}`);
                        alert(`Credits reset successful! Current credits: ${window.UnifiedStateSync.getCredits()}`);
                        return true;
                    } else {
                        console.error('âŒ ç§¯åˆ†é‡ç½®å¤±è´¥');
                        alert('ç§¯åˆ†é‡ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
                        return false;
                    }
                } else {
                    // é‡ç½®å…¶ä»–ç”¨æˆ·çš„ç§¯åˆ†éœ€è¦åç«¯APIæ”¯æŒ
                    console.log('âš ï¸ é‡ç½®å…¶ä»–ç”¨æˆ·ç§¯åˆ†éœ€è¦åç«¯APIæ”¯æŒ');
                    alert('é‡ç½®å…¶ä»–ç”¨æˆ·ç§¯åˆ†åŠŸèƒ½æš‚æœªå®ç°');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ é‡ç½®ç§¯åˆ†æ—¶å‘ç”Ÿé”™è¯¯:', error);
                alert('é‡ç½®ç§¯åˆ†å¤±è´¥: ' + error.message);
                return false;
            }
        };

        
        // ç”¨æˆ·ä¸‹æ‹‰èœå•åŠŸèƒ½
        let isDropdownOpen = false;

        // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤º
        window.toggleUserDropdown = function() {
            const dropdown = document.getElementById('userDropdown');
            const signinBtn = document.querySelector('.signin-btn');
            
            if (!dropdown || !signinBtn) return;

            isDropdownOpen = !isDropdownOpen;
            
            if (isDropdownOpen) {
                dropdown.style.display = 'block';
                updateDropdownUserInfo();
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
                setTimeout(() => {
                    document.addEventListener('click', closeDropdownOnClickOutside);
                }, 100);
            } else {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        };

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        function closeDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('userDropdown');
            const signinBtn = document.querySelector('.signin-btn');
            
            if (!dropdown.contains(event.target) && !signinBtn.contains(event.target)) {
                dropdown.style.display = 'none';
                isDropdownOpen = false;
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }

        // æ›´æ–°ä¸‹æ‹‰èœå•ç”¨æˆ·ä¿¡æ¯
        function updateDropdownUserInfo() {
            const currentUser = window.UnifiedStateSync?.getCurrentUser();
            if (!currentUser) return;

            // æ›´æ–°å¤´åƒ
            const avatarImg = document.getElementById('dropdownUserAvatar');
            if (avatarImg) {
                avatarImg.src = currentUser.avatar_url || 'https://via.placeholder.com/48';
            }

            // æ›´æ–°ç”¨æˆ·å
            const username = document.getElementById('dropdownUsername');
            if (username) {
                username.textContent = currentUser.name || currentUser.email?.split('@')[0] || 'User';
            }

            // æ›´æ–°ç”¨æˆ·ç­‰çº§
            const userLevel = document.getElementById('dropdownUserLevel');
            if (userLevel) {
                // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…çš„ä¼šå‘˜çŠ¶æ€æ¥åˆ¤æ–­
                const level = currentUser.subscription_status === 'active' ? 
                    (currentUser.plan_type === 'pro' ? 'Pro' : 'Max') : 'Free';
                userLevel.textContent = `Level: ${level}`;
            }

            // æ›´æ–°æœ‰æ•ˆæœŸ
            const validTime = document.getElementById('dropdownValidTime');
            if (validTime) {
                if (currentUser.subscription_status === 'active' && currentUser.subscription_end_date) {
                    const endDate = new Date(currentUser.subscription_end_date);
                    validTime.textContent = `Valid time: ${endDate.toLocaleDateString()}`;
                } else {
                    validTime.textContent = 'Valid time: --';
                }
            }
        }

        // å¤„ç†ç™»å‡º
        window.handleSignOut = async function() {
            try {
                console.log('ğŸšª å¼€å§‹ç™»å‡º...');
                
                // å…³é—­ä¸‹æ‹‰èœå•
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                    isDropdownOpen = false;
                }

                // ä½¿ç”¨UnifiedStateSyncç™»å‡º
                if (window.UnifiedStateSync) {
                    await window.UnifiedStateSync.signOut();
                }

                console.log('âœ… ç™»å‡ºæˆåŠŸ');
                
                // åˆ·æ–°é¡µé¢ä»¥é‡ç½®çŠ¶æ€
                setTimeout(() => {
                    window.location.reload();
                }, 500);
                
            } catch (error) {
                console.error('âŒ ç™»å‡ºå¤±è´¥:', error);
                alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        };

        </script>

    <!-- ç§¯åˆ†å¼¹çª— -->
    <div id="creditsModal" class="credits-modal">
        <div class="credits-modal-content">
            <div class="credits-modal-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h3 id="creditsModalTitle">Insufficient Credits</h3>
            <p id="creditsModalContent">You don't have enough credits to generate images.</p>
            <div class="credits-modal-actions">
                <button class="credits-modal-btn primary" onclick="window.location.href='pricing.html'">
                    <i class="fas fa-arrow-up"></i>
                    Upgrade Now
                </button>
                <button class="credits-modal-btn secondary" onclick="closeCreditsModal()">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
        </div>
    </div>
</body>

</html>