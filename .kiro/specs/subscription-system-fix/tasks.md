# 订阅系统修复实施任务

## 实施计划

将订阅系统修复设计转换为具体的编码任务，优先处理数据库结构、用户标识一致性和核心功能修复，确保每个步骤都能增量构建并及早测试。

- [ ] 1. 数据库结构修复和初始化
  - 创建缺失的数据库表结构
  - 设置正确的RLS策略和索引
  - 验证表创建和权限配置
  - _需求: 4.1, 4.2, 4.3, 4.4_

- [ ] 1.1 执行数据库表创建脚本
  - 在Supabase SQL Editor中执行create_missing_tables.sql
  - 创建user_subscriptions、paypal_orders、webhook_events表
  - 修复现有subscriptions表结构
  - _需求: 4.1, 4.2, 4.3_

- [ ] 1.2 配置数据库权限和索引
  - 设置RLS策略确保数据安全
  - 创建查询优化索引
  - 验证表访问权限正确配置
  - _需求: 4.4_

- [ ] 1.3 验证数据库结构完整性
  - 运行check_actual_tables.js验证表结构
  - 测试插入和查询操作
  - 确认所有必需字段存在
  - _需求: 4.5_

- [-] 2. 用户标识一致性修复
  - 统一Google用户ID和UUID字段
  - 修复现有用户数据不一致问题
  - 更新用户查找逻辑支持多种标识符
  - _需求: 2.1, 2.4_

- [x] 2.1 修复现有用户数据不一致
  - 运行fix_user_identification.js脚本
  - 将Google ID同步到UUID字段
  - 处理重复和冲突的用户记录
  - _需求: 2.4_

- [x] 2.2 更新用户查找逻辑
  - 修改API中的用户查找函数支持UUID和邮箱
  - 实现用户标识符自动修复机制
  - 添加用户数据一致性检查
  - _需求: 2.1, 2.4_

- [ ] 2.3 更新前端用户标识获取逻辑
  - 修复pricing.html中的getUserId函数优先使用UUID
  - 确保用户状态同步系统使用一致的标识符
  - 测试跨页面用户标识一致性
  - _需求: 2.1_

- [ ] 3. 用户状态跨页面同步修复
  - 修复user_state_sync.js的同步逻辑
  - 确保登录状态在所有页面正确显示
  - 实现实时状态更新机制
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 3.1 修复用户状态同步系统
  - 更新user_state_sync.js支持全局变量和localStorage双重同步
  - 实现跨页面状态变化监听
  - 修复导航栏用户信息显示逻辑
  - _需求: 1.1, 1.2, 1.5_

- [ ] 3.2 修复积分同步系统
  - 更新credits_sync.js使用一致的用户标识符
  - 实现服务器积分同步功能
  - 添加积分变化实时通知
  - _需求: 1.2, 3.2_

- [ ] 3.3 测试跨页面状态同步
  - 验证首页登录后定价页面状态正确
  - 测试页面刷新后状态保持
  - 确认登出后所有页面状态清除
  - _需求: 1.3, 1.4_

- [ ] 4. 订阅关联API完善
  - 完善handle-subscription.js的用户查找和创建逻辑
  - 实现robust的订阅关联存储
  - 添加错误处理和重试机制
  - _需求: 2.2, 2.3, 2.5_

- [ ] 4.1 完善订阅关联API逻辑
  - 实现多种方式用户查找 (UUID, 邮箱)
  - 添加用户不存在时的创建逻辑
  - 确保订阅关联数据正确存储到user_subscriptions表
  - _需求: 2.2, 2.3_

- [ ] 4.2 添加API错误处理
  - 实现详细的错误日志记录
  - 添加数据库操作失败的重试机制
  - 提供清晰的错误响应消息
  - _需求: 2.5_

- [ ] 4.3 创建用户积分查询API
  - 实现get-user-credits.js支持多种用户标识符
  - 添加用户类型识别 (注册用户/匿名用户)
  - 集成到前端积分同步系统
  - _需求: 3.2_

- [ ] 5. PayPal Webhook处理器修复
  - 修复webhook-complete.js的用户查找逻辑
  - 实现正确的积分计算和分配
  - 添加webhook事件日志记录
  - _需求: 5.1, 5.2, 5.3, 3.1, 3.3, 3.4_

- [ ] 5.1 修复Webhook用户查找逻辑
  - 实现多种方式查找用户 (UUID, 邮箱, custom_id解析)
  - 添加用户数据一致性自动修复
  - 处理找不到用户的错误情况
  - _需求: 5.1, 2.5_

- [ ] 5.2 实现订阅激活积分分配
  - 根据计划类型正确计算积分 (Pro: 1000, Max: 5000)
  - 更新用户积分和订阅状态
  - 记录积分交易到credit_transactions表
  - _需求: 3.1, 3.3, 3.4_

- [ ] 5.3 添加Webhook事件日志
  - 记录所有webhook事件到webhook_events表
  - 实现处理状态跟踪
  - 添加错误事件的详细记录
  - _需求: 5.3, 6.4_

- [ ] 6. 前端订阅流程集成测试
  - 测试完整的订阅购买流程
  - 验证PayPal集成和用户关联
  - 确认积分立即激活功能
  - _需求: 2.2, 2.3, 3.1, 3.2_

- [ ] 6.1 测试PayPal订阅创建流程
  - 验证用户信息正确传递到PayPal custom_id
  - 测试订阅创建成功后的关联API调用
  - 确认订阅记录正确保存到数据库
  - _需求: 2.2, 2.3_

- [ ] 6.2 测试立即激活功能
  - 验证订阅成功后立即积分分配
  - 测试积分在所有页面实时更新
  - 确认不依赖webhook的即时激活
  - _需求: 3.1, 3.2_

- [ ] 6.3 测试Webhook激活流程
  - 模拟PayPal webhook事件
  - 验证订阅激活和积分分配
  - 测试重复激活的幂等性
  - _需求: 5.1, 5.2_

- [ ] 7. 错误恢复和管理工具
  - 创建数据一致性检查和修复工具
  - 实现手动订阅激活功能
  - 添加系统健康监控
  - _需求: 6.1, 6.2, 6.3, 6.5_

- [ ] 7.1 创建数据修复工具
  - 完善fix_subscription_system.js检查更多数据不一致
  - 添加自动修复用户标识符不匹配
  - 实现订阅关联数据修复
  - _需求: 6.1, 6.2_

- [ ] 7.2 创建手动订阅激活工具
  - 实现通过邮箱手动激活订阅
  - 添加积分手动分配功能
  - 创建订阅状态查询和修改工具
  - _需求: 6.2, 6.3_

- [ ] 7.3 实现系统监控工具
  - 创建订阅系统健康检查
  - 添加关键指标监控 (成功率, 错误率)
  - 实现异常情况告警机制
  - _需求: 6.4, 6.5_

- [ ] 8. 综合测试和验证
  - 运行完整的端到端测试
  - 验证所有需求满足情况
  - 进行性能和稳定性测试
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 8.1 端到端流程测试
  - 测试从登录到订阅完成的完整流程
  - 验证多用户并发订阅场景
  - 测试各种错误恢复场景
  - _需求: 7.1, 7.2, 7.3_

- [ ] 8.2 使用测试工具验证功能
  - 运行test_subscription_fix.html进行综合测试
  - 验证所有同步功能正常工作
  - 确认数据库操作和API调用成功
  - _需求: 7.4, 7.5_

- [ ] 8.3 性能和稳定性测试
  - 测试高并发订阅处理能力
  - 验证长时间运行的稳定性
  - 检查内存泄漏和性能瓶颈
  - _需求: 6.4_

- [ ] 9. 文档和部署准备
  - 更新系统文档和使用说明
  - 准备生产环境部署脚本
  - 创建运维监控指南
  - _需求: 6.5_

- [ ] 9.1 更新技术文档
  - 完善API文档和接口说明
  - 更新数据库schema文档
  - 创建故障排除指南
  - _需求: 6.5_

- [ ] 9.2 准备部署脚本
  - 创建数据库迁移脚本
  - 准备环境配置检查清单
  - 实现零停机部署方案
  - _需求: 6.5_

- [ ] 9.3 建立监控和告警
  - 配置关键指标监控
  - 设置异常情况告警
  - 创建运维操作手册
  - _需求: 6.4, 6.5_