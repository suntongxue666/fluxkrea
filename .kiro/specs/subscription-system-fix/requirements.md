# 订阅系统修复规范

## 介绍

本规范旨在修复当前Google登录 + PayPal订阅系统中存在的关键问题，确保用户能够正确登录、购买订阅并获得相应的积分。当前系统存在用户状态同步问题、订阅关联错误和积分分配失败等核心问题。

## 需求

### 需求 1: 用户登录状态跨页面同步

**用户故事:** 作为用户，我希望在首页登录后，在定价页面也能看到我的登录状态，这样我就能无缝地进行订阅购买。

#### 验收标准

1. WHEN 用户在首页通过Google登录 THEN 系统应将用户信息同步到所有页面
2. WHEN 用户从首页跳转到定价页面 THEN 定价页面应显示正确的用户信息和积分
3. WHEN 用户刷新任何页面 THEN 登录状态应保持一致
4. IF 用户未登录 THEN 系统应在所有页面显示"Sign in"按钮
5. IF 用户已登录 THEN 系统应在所有页面显示用户头像和邮箱

### 需求 2: Google用户ID与PayPal订阅正确关联

**用户故事:** 作为用户，我希望通过Google登录后购买PayPal订阅时，订阅能够正确关联到我的账户，这样我就能获得相应的积分。

#### 验收标准

1. WHEN 用户通过Google登录 THEN 系统应生成唯一且一致的用户标识符
2. WHEN 用户创建PayPal订阅 THEN 系统应将Google用户ID与PayPal订阅ID正确关联
3. WHEN PayPal发送订阅激活webhook THEN 系统应能通过关联信息找到正确的用户
4. IF 用户标识符不一致 THEN 系统应自动修复并统一标识符
5. IF 关联信息缺失 THEN 系统应记录错误并提供手动修复机制

### 需求 3: 订阅激活后积分正确分配

**用户故事:** 作为用户，我希望PayPal订阅激活后，积分能够立即添加到我的账户中，这样我就能马上使用AI图像生成功能。

#### 验收标准

1. WHEN PayPal订阅激活 THEN 系统应根据订阅计划给用户添加相应积分
2. WHEN 积分添加成功 THEN 系统应在所有页面实时更新积分显示
3. WHEN 用户购买Pro计划 THEN 系统应添加1000积分
4. WHEN 用户购买Max计划 THEN 系统应添加5000积分
5. IF 积分添加失败 THEN 系统应记录错误并支持重试机制

### 需求 4: 数据库表结构完整性

**用户故事:** 作为系统管理员，我希望数据库具有完整的表结构来支持订阅系统，这样系统就能正确存储和查询订阅相关数据。

#### 验收标准

1. WHEN 系统启动 THEN 应存在完整的用户订阅关联表(user_subscriptions)
2. WHEN 系统启动 THEN 应存在PayPal订单追踪表(paypal_orders)
3. WHEN 系统启动 THEN 应存在Webhook事件日志表(webhook_events)
4. WHEN 创建订阅关联 THEN 系统应能成功插入关联记录
5. IF 表结构缺失 THEN 系统应提供自动创建脚本

### 需求 5: Webhook事件正确处理

**用户故事:** 作为系统，我需要正确处理PayPal的webhook事件，这样就能自动激活订阅并分配积分。

#### 验收标准

1. WHEN 接收到BILLING.SUBSCRIPTION.ACTIVATED事件 THEN 系统应激活对应用户的订阅
2. WHEN 接收到BILLING.SUBSCRIPTION.CANCELLED事件 THEN 系统应取消对应用户的订阅
3. WHEN 处理webhook事件 THEN 系统应记录处理日志
4. IF webhook处理失败 THEN 系统应记录错误并支持重试
5. IF 找不到对应用户 THEN 系统应记录错误并提供手动处理机制

### 需求 6: 系统错误恢复和监控

**用户故事:** 作为系统管理员，我希望系统具有错误恢复能力和监控功能，这样就能及时发现和解决问题。

#### 验收标准

1. WHEN 系统检测到数据不一致 THEN 应提供自动修复功能
2. WHEN 订阅处理失败 THEN 系统应提供手动激活工具
3. WHEN 用户报告积分问题 THEN 系统应提供积分查询和修复工具
4. IF 系统出现错误 THEN 应记录详细的错误日志
5. IF 需要手动干预 THEN 系统应提供管理员工具界面

### 需求 7: 测试和验证工具

**用户故事:** 作为开发者，我希望有完整的测试工具来验证订阅系统的各个功能，这样就能确保系统正常工作。

#### 验收标准

1. WHEN 运行测试工具 THEN 应能验证用户状态同步功能
2. WHEN 运行测试工具 THEN 应能验证积分同步功能
3. WHEN 运行测试工具 THEN 应能验证订阅关联功能
4. WHEN 运行测试工具 THEN 应能验证数据库连接和表结构
5. IF 测试失败 THEN 应提供详细的错误信息和修复建议