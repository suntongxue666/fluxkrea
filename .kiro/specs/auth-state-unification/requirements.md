# 用户认证状态统一重构需求文档

## 项目概述

对FLUX Krea AI项目进行轻量级重构，解决"结构分叉与身份传递不一致"问题，统一用户认证状态管理和积分同步机制。

## 问题现状

### 核心问题（首页优先）
1. **首页Google登录按钮失效**：右上角登录按钮点击无反应
2. **首页积分显示缺失**：登录后积分信息不显示
3. **首页Generate功能失效**：点击生成按钮没有反应
4. **登录状态不同步**：首页与Pricing页面状态不一致
5. **结构分叉**：多套静态文件实现（根目录 + public/）

### 技术根因
- 首页UserManager类初始化失败或事件绑定丢失
- Google登录回调处理异常
- Generate按钮事件监听器未正确绑定
- 积分同步机制在首页失效
- 缺乏统一的Supabase会话监听机制

## 需求定义

### 需求1：修复首页Google登录功能

**用户故事：** 作为用户，我希望点击首页右上角的Google登录按钮能够正常登录，并显示我的用户信息。

#### 验收标准
1. WHEN 点击首页"Sign in"按钮 THEN 应弹出Google登录窗口
2. WHEN Google登录成功 THEN 按钮应显示用户头像和用户名
3. WHEN 登录完成 THEN 积分信息应正确显示在导航栏
4. IF 登录失败 THEN 应显示友好的错误提示

### 需求2：修复首页Generate功能

**用户故事：** 作为用户，我希望在首页输入提示词后点击Generate按钮能够正常生成图片。

#### 验收标准
1. WHEN 输入提示词并点击Generate按钮 THEN 应开始图片生成流程
2. WHEN 生成过程中 THEN 应显示加载状态和进度提示
3. WHEN 生成成功 THEN 应在右侧显示生成的图片
4. WHEN 生成失败 THEN 应显示错误信息并允许重试
5. IF 用户积分不足 THEN 应提示积分不足并引导充值

### 需求3：修复首页积分显示和同步

**用户故事：** 作为用户，我希望在首页能够看到我的当前积分，并且积分变化时能实时更新。

#### 验收标准
1. WHEN 用户登录后 THEN 首页右上角应显示当前积分数量
2. WHEN 用户生成图片消耗积分 THEN 积分显示应立即更新
3. WHEN 用户购买积分 THEN 积分显示应同步增加
4. WHEN 页面刷新 THEN 积分信息应正确恢复显示

### 需求4：统一首页与Pricing页面状态同步

**用户故事：** 作为用户，我希望在首页登录后，切换到Pricing页面时能保持登录状态和积分信息。

#### 验收标准
1. WHEN 用户在首页登录 THEN 切换到Pricing页面应显示登录状态
2. WHEN 用户在Pricing页面操作 THEN 返回首页应保持状态一致
3. WHEN 积分发生变化 THEN 两个页面的积分显示应同步
4. WHEN 页面刷新 THEN 登录状态在两个页面都应正确恢复

### 需求5：统一静态文件结构

**用户故事：** 作为开发者，我希望所有静态文件有统一的出口，避免重复实现和维护困难。

#### 验收标准
1. WHEN 访问线上应用 THEN 所有页面（首页/定价/成功页）均来自public/目录
2. WHEN 检查项目结构 THEN 根目录不存在重复的HTML文件
3. IF 存在旧文件 THEN 应归档到archive/目录而非直接删除
4. WHEN 部署后 THEN 确保所有页面链接和资源引用正确

## 实施优先级

### P0 - 首页核心功能修复（0.5-1天）
1. 修复首页Google登录按钮点击事件
2. 修复首页Generate按钮功能
3. 修复首页积分显示和同步
4. 确保首页UserManager正确初始化

### P1 - 跨页面状态同步（0.5天）
1. 统一首页与Pricing页面的状态管理
2. 确保登录状态在页面间同步

### P2 - 结构统一（0.5天）
1. 统一静态文件到public/目录
2. 归档根目录重复文件

### P3 - 代码重构（1-2天）
1. 抽取lib/服务层
2. 清理冗余脚本和文件

## 验收标准总览

### 功能验收
- [ ] 首页Google登录按钮正常工作
- [ ] 首页Generate功能正常生成图片
- [ ] 首页积分显示和实时更新正常
- [ ] 首页与Pricing页面登录状态完全同步
- [ ] 页面刷新后状态正确恢复

### 技术验收
- [ ] 统一静态根目录（public/）
- [ ] 统一身份认证机制（Supabase会话）
- [ ] 清晰的代码结构（lib/服务层）
- [ ] 唯一权威实现（无重复逻辑）

### 稳定性验收
- [ ] 未登录用户访问不会出现500错误
- [ ] 会话过期时优雅降级
- [ ] 跨页面操作状态一致

## 风险控制

### 主要风险
1. **旧页面依赖未察觉** - 解决方案：先归档不删除，灰度验证
2. **接口强依赖RLS** - 解决方案：未登录返回401 JSON，前端友好处理
3. **状态同步竞态条件** - 解决方案：统一初始化顺序，避免并发冲突

### 回滚策略
- 保留原始文件的归档版本
- 分阶段部署，每个阶段可独立回滚
- 关键API保持向后兼容

## 成功指标

1. **用户体验**：登录状态同步率100%，积分显示一致性100%
2. **系统稳定性**：API错误率降低到1%以下
3. **代码质量**：重复代码减少60%以上
4. **维护效率**：新功能开发时间减少30%

## 后续规划

完成本次重构后，为更大规模的架构升级奠定基础：
- 考虑引入状态管理库（如Redux/Zustand）
- 评估迁移到现代框架（Next.js等）
- 建立完整的测试体系