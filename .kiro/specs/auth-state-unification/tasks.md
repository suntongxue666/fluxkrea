# 实施任务清单

## 任务概述

基于需求和设计文档，将首页核心功能修复和状态同步统一分解为具体的编码任务。重点解决首页Google登录、Generate功能和积分显示问题。

## 任务列表

### 1. 首页UserManager修复和重构

- [ ] 1.1 诊断首页UserManager初始化问题
  - 检查public/index.html中UserManager类的初始化代码执行情况
  - 验证handleSignInClick函数是否正确绑定到.signin-btn元素
  - 检查Supabase客户端是否正确初始化（window.supabaseClient）
  - 识别控制台错误信息和初始化失败的具体原因
  - _需求: 1.1, 1.2, 1.3_

- [ ] 1.2 修复UserManager初始化流程
  - 重写UserManager.initialize()方法，确保正确的初始化顺序
  - 修复Supabase客户端创建和会话检查逻辑
  - 添加初始化失败的降级处理机制
  - 确保onAuthStateChange监听器正确设置
  - _需求: 1.1, 1.2_

- [ ] 1.3 修复Google登录按钮事件绑定
  - 检查.signin-btn元素的事件绑定代码
  - 修复handleSignInClick函数调用链
  - 确保signInWithGoogle方法正确调用Supabase OAuth
  - 添加登录过程的加载状态和错误处理
  - _需求: 1.1, 1.4_

- [ ] 1.4 完善登录成功后的UI更新
  - 修复登录成功后按钮显示用户头像和姓名
  - 确保用户状态正确保存到localStorage
  - 实现登录状态的实时UI更新
  - 添加登录成功的用户反馈
  - _需求: 1.2, 1.3_

### 2. 首页Generate功能修复

- [ ] 2.1 诊断Generate按钮事件绑定问题
  - 检查public/index.html中generateImage函数是否正确定义
  - 验证#generateBtn按钮的onclick="generateImage()"事件绑定
  - 检查Generate按钮点击时的控制台输出和错误信息
  - 验证currentUser和creditsManager变量是否正确初始化
  - _需求: 2.1_

- [ ] 2.2 重构Generate按钮事件处理
  - 创建ImageGenerator类来管理图片生成逻辑
  - 重新绑定Generate按钮的click事件
  - 实现防重复点击机制
  - 添加生成过程的状态管理
  - _需求: 2.1, 2.2_

- [ ] 2.3 修复图片生成API调用
  - 检查/api/generate接口的调用参数和格式
  - 修复API请求的错误处理逻辑
  - 实现生成过程的进度显示
  - 添加生成失败的重试机制
  - _需求: 2.1, 2.2, 2.4_

- [ ] 2.4 完善积分验证和扣除逻辑
  - 在生成前检查用户积分是否足够
  - 实现积分不足时的友好提示弹窗
  - 修复生成成功后的积分扣除逻辑
  - 确保积分变化实时更新到UI
  - _需求: 2.5, 3.2_

- [ ] 2.5 优化生成结果显示
  - 修复生成成功后的图片显示逻辑
  - 实现结果区域的状态切换（占位符→加载→结果）
  - 添加生成失败时的错误信息显示
  - 实现生成历史的本地缓存
  - _需求: 2.2, 2.3_

### 3. 首页积分显示和同步修复

- [ ] 3.1 诊断积分显示问题
  - 检查public/index.html中#creditsAmount元素是否存在
  - 验证CreditsManager类的初始化和updateCreditsDisplay方法执行
  - 检查积分数据从数据库同步的API调用是否成功
  - 验证登录后积分是否正确显示在导航栏
  - _需求: 3.1, 3.2_

- [ ] 3.2 重构积分管理系统
  - 创建统一的CreditsManager类
  - 实现从数据库同步积分的逻辑
  - 建立积分变化的监听和通知机制
  - 确保积分数据在localStorage中正确缓存
  - _需求: 3.1, 3.2, 3.3_

- [ ] 3.3 修复积分显示UI更新
  - 确保登录后积分立即显示在导航栏
  - 实现积分变化时的动画效果
  - 修复积分数字的格式化显示
  - 添加积分更新的视觉反馈
  - _需求: 3.1, 3.4_

- [ ] 3.4 实现积分实时同步机制
  - 建立定期从数据库同步积分的机制
  - 实现积分变化时的跨页面通知
  - 添加网络异常时的本地缓存降级
  - 确保页面刷新后积分正确恢复
  - _需求: 3.2, 3.4, 4.3_

### 4. 跨页面状态同步实现

- [ ] 4.1 创建统一的StateManager
  - 设计StateManager单例类来管理全局状态
  - 整合UserManager和CreditsManager到统一接口
  - 实现状态的初始化和生命周期管理
  - 建立标准化的状态数据结构
  - _需求: 4.1, 4.2_

- [ ] 4.2 实现localStorage状态同步
  - 建立统一的localStorage数据格式
  - 实现状态变化时的自动保存机制
  - 添加storage事件监听来处理跨页面同步
  - 确保数据的一致性和完整性验证
  - _需求: 4.1, 4.3, 4.4_

- [ ] 4.3 建立跨页面通信机制
  - 实现基于storage事件的页面间通信
  - 添加页面可见性变化时的状态同步
  - 建立状态冲突时的解决策略
  - 实现状态同步的防抖和节流机制
  - _需求: 4.2, 4.3_

- [ ] 4.4 验证首页与Pricing页面状态同步
  - 测试首页登录后Pricing页面的状态更新
  - 验证积分变化在两个页面的同步显示
  - 确保页面刷新后状态的正确恢复
  - 测试网络异常情况下的状态一致性
  - _需求: 4.1, 4.2, 4.4_

### 5. 代码结构优化和文件整理

- [ ] 5.1 创建独立的JavaScript模块文件
  - 将UserManager提取到独立的user-manager.js文件
  - 将CreditsManager提取到独立的credits-manager.js文件
  - 将ImageGenerator提取到独立的image-generator.js文件
  - 创建state-manager.js作为统一入口
  - _需求: 5.1, 5.2_

- [ ] 5.2 统一静态文件到public目录
  - 将根目录的index.html移动到public/目录
  - 更新所有资源引用路径
  - 确保Vercel部署配置正确指向public/
  - 归档旧文件到archive/目录
  - _需求: 5.1, 5.2, 5.4_

- [ ] 5.3 清理冗余和测试文件
  - 识别并归档所有test_*.js、fix_*.js、check_*.js文件
  - 清理重复的API实现文件
  - 整理scripts目录，分离开发工具和生产代码
  - 更新.gitignore忽略归档文件
  - _需求: 5.3_

- [ ] 5.4 更新文件引用和配置
  - 更新index.html中的JavaScript文件引用
  - 确保所有页面使用统一的模块加载方式
  - 验证vercel.json配置的正确性
  - 测试部署后所有页面和资源的可访问性
  - _需求: 5.2, 5.4_

### 6. 测试和验证

- [ ] 6.1 首页核心功能测试
  - 测试Google登录按钮的点击响应和登录流程
  - 测试Generate按钮的图片生成完整流程
  - 验证积分显示和扣除的正确性
  - 测试各种错误情况的处理和用户反馈
  - _需求: 1.1, 2.1, 3.1_

- [ ] 6.2 跨页面状态同步测试
  - 测试首页登录后切换到Pricing页面的状态同步
  - 验证积分变化在不同页面的实时更新
  - 测试页面刷新后的状态恢复
  - 验证多标签页间的状态一致性
  - _需求: 4.1, 4.2, 4.4_

- [ ] 6.3 边界情况和错误处理测试
  - 测试网络断开时的降级处理
  - 验证会话过期时的重新登录流程
  - 测试积分不足时的用户引导
  - 验证API调用失败时的错误提示
  - _需求: 1.4, 2.4, 3.4_

- [ ] 6.4 性能和用户体验测试
  - 测试页面加载速度和初始化时间
  - 验证状态同步的响应延迟
  - 测试Generate功能的响应时间
  - 评估用户操作的流畅性和反馈及时性
  - _需求: 所有需求的用户体验方面_

## 任务执行顺序

### 第一阶段：核心功能修复（P0）
1. 任务1.1-1.4：修复首页UserManager和Google登录
2. 任务2.1-2.5：修复首页Generate功能
3. 任务3.1-3.4：修复首页积分显示和同步

### 第二阶段：状态同步实现（P1）
4. 任务4.1-4.4：实现跨页面状态同步

### 第三阶段：结构优化（P2）
5. 任务5.1-5.4：代码结构优化和文件整理

### 第四阶段：测试验证（P3）
6. 任务6.1-6.4：全面测试和验证

## 完成标准

每个任务完成后应满足：
- 功能正常工作，无明显bug
- 代码符合项目规范
- 添加必要的错误处理
- 通过基本的功能测试
- 更新相关文档和注释

整个项目完成后应达到需求文档中定义的所有验收标准。