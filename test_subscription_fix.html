<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…ç³»ç»Ÿä¿®å¤æµ‹è¯•</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="credits_sync.js"></script>
    <script src="user_state_sync.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #1a202c;
            margin-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }
        
        .test-result {
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-family: monospace;
        }
        
        .success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #059669;
        }
        
        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }
        
        .info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1d4ed8;
        }
        
        .warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            color: #d97706;
        }
        
        button {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 8px 8px 8px 0;
            transition: all 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-display {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .credits-display {
            font-size: 18px;
            font-weight: 600;
            color: #059669;
        }
        
        .user-display {
            font-size: 14px;
            color: #64748b;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #1a202c;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 4px;
        }
        
        .log-entry.success { color: #10b981; }
        .log-entry.error { color: #f87171; }
        .log-entry.warning { color: #fbbf24; }
        .log-entry.info { color: #60a5fa; }
    </style>
</head>
<body>
    <h1>ğŸ”§ è®¢é˜…ç³»ç»Ÿä¿®å¤æµ‹è¯•</h1>
    
    <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
    <div class="test-section">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
        <div class="status-display">
            <div class="credits-display">
                ç§¯åˆ†: <span id="currentCredits">--</span>
            </div>
            <div class="user-display">
                ç”¨æˆ·: <span id="currentUser">--</span>
            </div>
            <div class="user-display">
                æ ‡è¯†ç¬¦: <span id="currentIdentifier">--</span>
            </div>
        </div>
        <button onclick="refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
        <button onclick="clearLocalStorage()">æ¸…é™¤æœ¬åœ°å­˜å‚¨</button>
    </div>
    
    <!-- ç”¨æˆ·çŠ¶æ€åŒæ­¥æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ‘¤ ç”¨æˆ·çŠ¶æ€åŒæ­¥æµ‹è¯•</h2>
        <button onclick="testUserStateSync()">æµ‹è¯•ç”¨æˆ·çŠ¶æ€åŒæ­¥</button>
        <button onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•</button>
        <button onclick="simulateLogout()">æ¨¡æ‹Ÿç™»å‡º</button>
        <div id="userSyncResults"></div>
    </div>
    
    <!-- ç§¯åˆ†åŒæ­¥æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ’° ç§¯åˆ†åŒæ­¥æµ‹è¯•</h2>
        <button onclick="testCreditsSync()">æµ‹è¯•ç§¯åˆ†åŒæ­¥</button>
        <button onclick="testServerSync()">æµ‹è¯•æœåŠ¡å™¨åŒæ­¥</button>
        <button onclick="simulateCreditsChange()">æ¨¡æ‹Ÿç§¯åˆ†å˜åŒ–</button>
        <div id="creditsSyncResults"></div>
    </div>
    
    <!-- è®¢é˜…å…³è”æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ”— è®¢é˜…å…³è”æµ‹è¯•</h2>
        <button onclick="testSubscriptionAssociation()">æµ‹è¯•è®¢é˜…å…³è”</button>
        <button onclick="checkUserSubscriptions()">æ£€æŸ¥ç”¨æˆ·è®¢é˜…</button>
        <div id="subscriptionResults"></div>
    </div>
    
    <!-- æ•°æ®åº“è¿æ¥æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ—„ï¸ æ•°æ®åº“è¿æ¥æµ‹è¯•</h2>
        <button onclick="testDatabaseConnection()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
        <button onclick="checkTableStructure()">æ£€æŸ¥è¡¨ç»“æ„</button>
        <div id="databaseResults"></div>
    </div>
    
    <!-- æ—¥å¿—æ˜¾ç¤º -->
    <div class="test-section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        <div id="logContainer" class="log-container"></div>
    </div>

    <script>
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const SUPABASE_URL = 'https://gdcjvqaqgvcxzufmessy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkY2p2cWFxZ3ZjeHp1Zm1lc3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMDY2NTEsImV4cCI6MjA2OTc4MjY1MX0.wIblNpUZLgQcCJCVbKfae5n0jtcIshL9asVIit6iUBI';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // æ—¥å¿—ç³»ç»Ÿ
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(logEntry);
            
            const logContainer = document.getElementById('logContainer');
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${type}`;
            logElement.textContent = logEntry;
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
        function refreshStatus() {
            log('åˆ·æ–°å½“å‰çŠ¶æ€...', 'info');
            
            // è·å–å½“å‰ç”¨æˆ·
            const currentUser = window.userStateSync ? window.userStateSync.getCurrentUser() : null;
            document.getElementById('currentUser').textContent = currentUser ? currentUser.email : 'æœªç™»å½•';
            
            // è·å–å½“å‰ç§¯åˆ†
            const currentCredits = window.creditsSync ? window.creditsSync.getCredits() : 0;
            document.getElementById('currentCredits').textContent = currentCredits;
            
            // è·å–ç”¨æˆ·æ ‡è¯†ç¬¦
            const identifier = window.creditsSync ? window.creditsSync.getCurrentUserIdentifier() : 'unknown';
            document.getElementById('currentIdentifier').textContent = identifier;
            
            log(`å½“å‰çŠ¶æ€ - ç”¨æˆ·: ${currentUser ? currentUser.email : 'æœªç™»å½•'}, ç§¯åˆ†: ${currentCredits}, æ ‡è¯†ç¬¦: ${identifier}`, 'success');
        }
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        function clearLocalStorage() {
            localStorage.clear();
            window.currentUser = null;
            log('æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤', 'warning');
            refreshStatus();
        }
        
        // æµ‹è¯•ç”¨æˆ·çŠ¶æ€åŒæ­¥
        function testUserStateSync() {
            log('å¼€å§‹æµ‹è¯•ç”¨æˆ·çŠ¶æ€åŒæ­¥...', 'info');
            
            const resultsDiv = document.getElementById('userSyncResults');
            resultsDiv.innerHTML = '';
            
            try {
                // æµ‹è¯•è·å–ç”¨æˆ·
                const user = window.userStateSync.getCurrentUser();
                addResult(resultsDiv, `è·å–å½“å‰ç”¨æˆ·: ${user ? user.email : 'æ— '}`, user ? 'success' : 'warning');
                
                // æµ‹è¯•è®¾ç½®ç”¨æˆ·
                const testUser = {
                    uuid: 'test-uuid-' + Date.now(),
                    email: 'test@example.com',
                    credits: 100
                };
                
                const setResult = window.userStateSync.setCurrentUser(testUser);
                addResult(resultsDiv, `è®¾ç½®æµ‹è¯•ç”¨æˆ·: ${setResult ? 'æˆåŠŸ' : 'å¤±è´¥'}`, setResult ? 'success' : 'error');
                
                // éªŒè¯è®¾ç½®ç»“æœ
                const verifyUser = window.userStateSync.getCurrentUser();
                const isCorrect = verifyUser && verifyUser.email === testUser.email;
                addResult(resultsDiv, `éªŒè¯ç”¨æˆ·è®¾ç½®: ${isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯'}`, isCorrect ? 'success' : 'error');
                
                log('ç”¨æˆ·çŠ¶æ€åŒæ­¥æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`ç”¨æˆ·çŠ¶æ€åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult(resultsDiv, `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•ç§¯åˆ†åŒæ­¥
        function testCreditsSync() {
            log('å¼€å§‹æµ‹è¯•ç§¯åˆ†åŒæ­¥...', 'info');
            
            const resultsDiv = document.getElementById('creditsSyncResults');
            resultsDiv.innerHTML = '';
            
            try {
                // æµ‹è¯•è·å–ç§¯åˆ†
                const credits = window.creditsSync.getCredits();
                addResult(resultsDiv, `å½“å‰ç§¯åˆ†: ${credits}`, 'info');
                
                // æµ‹è¯•è®¾ç½®ç§¯åˆ†
                const testCredits = 500;
                const setResult = window.creditsSync.setCredits(testCredits);
                addResult(resultsDiv, `è®¾ç½®ç§¯åˆ† ${testCredits}: ${setResult ? 'æˆåŠŸ' : 'å¤±è´¥'}`, setResult ? 'success' : 'error');
                
                // éªŒè¯è®¾ç½®ç»“æœ
                const verifyCredits = window.creditsSync.getCredits();
                const isCorrect = verifyCredits === testCredits;
                addResult(resultsDiv, `éªŒè¯ç§¯åˆ†è®¾ç½®: ${verifyCredits} (${isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯'})`, isCorrect ? 'success' : 'error');
                
                // æµ‹è¯•æ·»åŠ ç§¯åˆ†
                const addResult = window.creditsSync.addCredits(100);
                const newCredits = window.creditsSync.getCredits();
                addResult(resultsDiv, `æ·»åŠ ç§¯åˆ†å: ${newCredits}`, addResult ? 'success' : 'error');
                
                log('ç§¯åˆ†åŒæ­¥æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`ç§¯åˆ†åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult(resultsDiv, `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•æœåŠ¡å™¨åŒæ­¥
        async function testServerSync() {
            log('å¼€å§‹æµ‹è¯•æœåŠ¡å™¨åŒæ­¥...', 'info');
            
            const resultsDiv = document.getElementById('creditsSyncResults');
            
            try {
                const credits = await window.creditsSync.syncFromServer();
                addResult(resultsDiv, `æœåŠ¡å™¨åŒæ­¥ç»“æœ: ${credits} ç§¯åˆ†`, 'success');
                log(`æœåŠ¡å™¨åŒæ­¥æˆåŠŸ: ${credits} ç§¯åˆ†`, 'success');
                
            } catch (error) {
                log(`æœåŠ¡å™¨åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
                addResult(resultsDiv, `æœåŠ¡å™¨åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•è®¢é˜…å…³è”
        async function testSubscriptionAssociation() {
            log('å¼€å§‹æµ‹è¯•è®¢é˜…å…³è”...', 'info');
            
            const resultsDiv = document.getElementById('subscriptionResults');
            resultsDiv.innerHTML = '';
            
            try {
                // æµ‹è¯•APIè°ƒç”¨
                const testData = {
                    googleUserId: 'test-user-' + Date.now(),
                    googleUserEmail: 'test@example.com',
                    paypalSubscriptionId: 'I-TEST-' + Date.now(),
                    planId: 'P-TEST123',
                    planType: 'pro'
                };
                
                const response = await fetch('/api/handle-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addResult(resultsDiv, `è®¢é˜…å…³è”APIæµ‹è¯•: æˆåŠŸ`, 'success');
                    addResult(resultsDiv, `è¿”å›ç»“æœ: ${JSON.stringify(result)}`, 'info');
                    log('è®¢é˜…å…³è”APIæµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    const error = await response.text();
                    addResult(resultsDiv, `è®¢é˜…å…³è”APIæµ‹è¯•: å¤±è´¥ (${response.status})`, 'error');
                    addResult(resultsDiv, `é”™è¯¯ä¿¡æ¯: ${error}`, 'error');
                    log(`è®¢é˜…å…³è”APIæµ‹è¯•å¤±è´¥: ${error}`, 'error');
                }
                
            } catch (error) {
                log(`è®¢é˜…å…³è”æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult(resultsDiv, `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·è®¢é˜…
        async function checkUserSubscriptions() {
            log('æ£€æŸ¥ç”¨æˆ·è®¢é˜…...', 'info');
            
            const resultsDiv = document.getElementById('subscriptionResults');
            
            try {
                const { data: subscriptions, error } = await supabaseClient
                    .from('subscriptions')
                    .select('id, user_email, plan_type, status')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    addResult(resultsDiv, `æŸ¥è¯¢è®¢é˜…å¤±è´¥: ${error.message}`, 'error');
                    log(`æŸ¥è¯¢è®¢é˜…å¤±è´¥: ${error.message}`, 'error');
                } else {
                    addResult(resultsDiv, `æ‰¾åˆ° ${subscriptions.length} ä¸ªè®¢é˜…`, 'success');
                    subscriptions.forEach(sub => {
                        addResult(resultsDiv, `${sub.id}: ${sub.user_email} (${sub.plan_type}, ${sub.status})`, 'info');
                    });
                    log(`æˆåŠŸæŸ¥è¯¢åˆ° ${subscriptions.length} ä¸ªè®¢é˜…`, 'success');
                }
                
            } catch (error) {
                log(`æ£€æŸ¥ç”¨æˆ·è®¢é˜…å¤±è´¥: ${error.message}`, 'error');
                addResult(resultsDiv, `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            log('æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
            
            const resultsDiv = document.getElementById('databaseResults');
            resultsDiv.innerHTML = '';
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    addResult(resultsDiv, `æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    log(`æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                } else {
                    addResult(resultsDiv, `æ•°æ®åº“è¿æ¥æˆåŠŸ`, 'success');
                    log('æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');
                }
                
            } catch (error) {
                log(`æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                addResult(resultsDiv, `è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ£€æŸ¥è¡¨ç»“æ„
        async function checkTableStructure() {
            log('æ£€æŸ¥è¡¨ç»“æ„...', 'info');
            
            const resultsDiv = document.getElementById('databaseResults');
            const tables = ['users', 'subscriptions', 'user_subscriptions', 'credit_transactions'];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabaseClient
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        addResult(resultsDiv, `è¡¨ ${table}: è®¿é—®å¤±è´¥ (${error.message})`, 'error');
                        log(`è¡¨ ${table} è®¿é—®å¤±è´¥: ${error.message}`, 'error');
                    } else {
                        addResult(resultsDiv, `è¡¨ ${table}: å¯è®¿é—®`, 'success');
                        log(`è¡¨ ${table} å¯è®¿é—®`, 'success');
                    }
                    
                } catch (error) {
                    addResult(resultsDiv, `è¡¨ ${table}: æ£€æŸ¥å¤±è´¥ (${error.message})`, 'error');
                    log(`è¡¨ ${table} æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }
        
        // æ¨¡æ‹Ÿç™»å½•
        function simulateLogin() {
            const testUser = {
                uuid: 'test-uuid-' + Date.now(),
                email: 'testuser@example.com',
                name: 'Test User',
                credits: 200,
                subscription_status: 'FREE'
            };
            
            window.userStateSync.setCurrentUser(testUser);
            window.creditsSync.setCredits(testUser.credits);
            
            log(`æ¨¡æ‹Ÿç™»å½•: ${testUser.email}`, 'success');
            refreshStatus();
        }
        
        // æ¨¡æ‹Ÿç™»å‡º
        function simulateLogout() {
            window.userStateSync.setCurrentUser(null);
            window.creditsSync.setCredits(0);
            
            log('æ¨¡æ‹Ÿç™»å‡º', 'warning');
            refreshStatus();
        }
        
        // æ¨¡æ‹Ÿç§¯åˆ†å˜åŒ–
        function simulateCreditsChange() {
            const randomCredits = Math.floor(Math.random() * 1000) + 100;
            window.creditsSync.setCredits(randomCredits);
            
            log(`æ¨¡æ‹Ÿç§¯åˆ†å˜åŒ–: ${randomCredits}`, 'info');
            refreshStatus();
        }
        
        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addResult(container, message, type) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            container.appendChild(resultDiv);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            refreshStatus();
            
            // ç›‘å¬ç§¯åˆ†å˜åŒ–
            if (window.creditsSync) {
                window.creditsSync.addListener((credits) => {
                    document.getElementById('currentCredits').textContent = credits;
                    log(`ç§¯åˆ†æ›´æ–°: ${credits}`, 'info');
                });
            }
            
            // ç›‘å¬ç”¨æˆ·çŠ¶æ€å˜åŒ–
            if (window.userStateSync) {
                window.userStateSync.addListener((user) => {
                    document.getElementById('currentUser').textContent = user ? user.email : 'æœªç™»å½•';
                    log(`ç”¨æˆ·çŠ¶æ€æ›´æ–°: ${user ? user.email : 'æœªç™»å½•'}`, 'info');
                });
            }
        });
    </script>
</body>
</html>