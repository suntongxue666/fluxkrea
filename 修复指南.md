# 用户积分和订阅问题修复指南

本指南提供了三个脚本，用于诊断和修复以下问题：

1. 用户登录后积分为0
2. 数据库中看不到用户信息
3. 购买订阅失败

## 准备工作

确保已安装Node.js和npm，并安装必要的依赖：

```bash
npm install @supabase/supabase-js
```

## 脚本说明

### 1. 诊断脚本 (diagnose-user-credits.js)

此脚本用于诊断用户积分和登录问题，会检查：
- 用户记录是否存在
- 积分交易记录
- 订阅记录

使用方法：

```bash
node diagnose-user-credits.js
```

### 2. 订阅系统诊断脚本 (fix-subscription-system.js)

此脚本用于诊断订阅系统问题，会检查：
- RLS策略
- Webhook事件记录
- 订阅表结构
- 测试订阅创建流程

使用方法：

```bash
node fix-subscription-system.js
```

### 3. 一键修复脚本 (fix-all-three-issues.js)

此脚本可以一次性修复所有三个问题：
- 修复用户积分为0的问题
- 修复用户在数据库中不可见的问题
- 修复订阅创建失败的问题

使用方法：

```bash
node fix-all-three-issues.js
```

## 问题解决方案

### 问题1：用户登录后积分为0

**原因分析**：
- 可能是首次登录奖励积分未正确添加
- 可能是用户记录创建时未设置初始积分
- 可能是积分交易记录失败

**解决方案**：
- 运行`fix-all-three-issues.js`脚本，它会检查用户积分并添加初始积分

### 问题2：数据库中看不到用户信息

**原因分析**：
- 可能是用户记录创建失败
- 可能是用户ID与邮箱不匹配

**解决方案**：
- 运行`fix-all-three-issues.js`脚本，它会检查用户是否存在，如果不存在则创建新用户

### 问题3：购买订阅失败

**原因分析**：
- 可能是RLS策略限制了匿名插入
- 可能是webhook配置错误
- 可能是订阅表结构问题

**解决方案**：
- 运行`fix-all-three-issues.js`脚本，它会检查RLS策略并模拟订阅购买流程
- 如果问题仍然存在，请检查Supabase控制台中的RLS策略设置

## 后续验证

修复完成后，请执行以下步骤验证问题是否解决：

1. 刷新页面并重新登录
2. 检查积分是否显示正确
3. 尝试购买订阅
4. 检查订阅状态和积分是否更新

如果问题仍然存在，请运行诊断脚本获取更详细的信息。