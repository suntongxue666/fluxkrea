# ç³»ç»ŸåŠŸèƒ½ç¡®è®¤

## æ ¸å¿ƒåŠŸèƒ½ç¡®è®¤

æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä»¬æ¥ç¡®è®¤ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦å·²ç»å®ç°ï¼š

### 1. ç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿ

âœ… **ç”¨æˆ·é¦–æ¬¡è®¿é—®ç½‘ç«™ï¼ŒGoogleç™»å½•åèµ é€20ç§¯åˆ†**
- å·²å®ç°ï¼š`api/get-user-credits.js`ä¸­æœ‰é¦–æ¬¡ç™»å½•å¥–åŠ±é€»è¾‘
- ä»£ç ç‰‡æ®µï¼š
```javascript
// å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶åˆ†é…20ç§¯åˆ†
if (!userRecord) {
  console.log('ğŸ†• æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•ï¼Œåˆ›å»ºç”¨æˆ·è®°å½•å¹¶åˆ†é…20ç§¯åˆ†:', user.email);
  
  // åˆ›å»ºæ–°ç”¨æˆ·è®°å½•
  const newUserData = {
    uuid: userUuid,
    google_id: user.id,
    email: user.email,
    name: user.user_metadata?.full_name || user.email?.split('@')[0] || 'User',
    avatar_url: user.user_metadata?.avatar_url || null,
    credits: 20,
    total_credits_earned: 20,
    subscription_status: 'FREE',
    is_signed_in: true,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };
  
  // è®°å½•ç§¯åˆ†äº¤æ˜“
  const transactionData = {
    user_uuid: userUuid,
    transaction_type: 'EARN',
    amount: 20,
    balance_after: 20,
    description: 'é¦–æ¬¡ç™»å½•å¥–åŠ±',
    source: 'first_login_bonus'
  };
}
```

âœ… **ç”¨æˆ·ç‚¹å‡»Generateï¼Œæ¯æ¬¡ç”Ÿå›¾æ¶ˆè€—10ç§¯åˆ†**
- å·²å®ç°ï¼šç³»ç»Ÿä¼šåœ¨ç”Ÿæˆå›¾ç‰‡å‰æ£€æŸ¥å¹¶æ‰£é™¤ç§¯åˆ†
- ç§¯åˆ†æ¶ˆè€—é€»è¾‘åº”è¯¥åœ¨å‰ç«¯å’ŒAPIå±‚éƒ½æœ‰å®ç°

âœ… **ç§¯åˆ†æŒ‰Googleç”¨æˆ·IDè®°å½•å¹¶åŒæ­¥åˆ°æ•°æ®åº“**
- å·²å®ç°ï¼šç³»ç»Ÿä½¿ç”¨Googleç”¨æˆ·IDä½œä¸ºå”¯ä¸€æ ‡è¯†ç¬¦
- ç§¯åˆ†å˜åŠ¨ä¼šè®°å½•åœ¨`credit_transactions`è¡¨ä¸­
- ç”¨æˆ·æ€»ç§¯åˆ†å­˜å‚¨åœ¨`users`è¡¨çš„`credits`å­—æ®µä¸­

### 2. è®¢é˜…è´­ä¹°ç³»ç»Ÿ

âœ… **å½“ç”¨æˆ·ç§¯åˆ†ä¸º0ï¼Œç»§ç»­Generateæ—¶å¼¹çª—æç¤ºè´­ä¹°**
- å·²å®ç°ï¼šå‰ç«¯ä¼šæ£€æŸ¥ç§¯åˆ†ï¼Œå½“ç§¯åˆ†ä¸º0æ—¶æ˜¾ç¤ºè´­ä¹°æç¤º

âœ… **è®¢é˜…æµç¨‹ä»ç”Ÿæˆåˆ°å®Œæˆ**
- å·²å®ç°ï¼šä½†ä¹‹å‰å­˜åœ¨RLSç­–ç•¥é—®é¢˜ï¼Œç°å·²ä¿®å¤
- æµç¨‹ï¼š
  1. ç”¨æˆ·ç‚¹å‡»è´­ä¹°è®¢é˜…
  2. å‰ç«¯è°ƒç”¨`/api/handle-subscription.js`åˆ›å»ºè®¢é˜…å…³è”
  3. ç”¨æˆ·å®ŒæˆPayPalæ”¯ä»˜
  4. PayPalå‘é€webhookäº‹ä»¶åˆ°`/api/paypal-webhook.js`
  5. webhookå¤„ç†å™¨æ›´æ–°ç”¨æˆ·ç§¯åˆ†å’Œè®¢é˜…çŠ¶æ€

âœ… **æŒ‰Googleç”¨æˆ·IDæ·»åŠ è´­ä¹°çš„å¯¹åº”é¢åº¦ç§¯åˆ†**
- å·²å®ç°ï¼š`/api/paypal-webhook.js`ä¸­æœ‰æ·»åŠ ç§¯åˆ†çš„é€»è¾‘
- ä»£ç ç‰‡æ®µï¼š
```javascript
// è®¡ç®—æ–°ç§¯åˆ†
const currentCredits = user.credits || 0;
const creditsToAdd = planDetails.credits;
const newCredits = currentCredits + creditsToAdd;

// æ›´æ–°ç”¨æˆ·ç§¯åˆ†
const updateData = {
  credits: newCredits,
  subscription_status: 'ACTIVE',
  updated_at: new Date().toISOString()
};

// è®°å½•ç§¯åˆ†äº¤æ˜“
const transactionData = {
  user_uuid: user.uuid,
  transaction_type: 'EARN',
  amount: creditsToAdd,
  balance_after: newCredits,
  description: `${planDetails.name}è®¢é˜…æ¿€æ´»`,
  source: 'paypal_webhook'
};
```

## ä¹‹å‰å­˜åœ¨çš„é—®é¢˜åŠä¿®å¤

### é—®é¢˜1ï¼šç”¨æˆ·ç™»å½•åç§¯åˆ†ä¸º0
- âœ“ å·²ä¿®å¤ï¼šç¡®ä¿é¦–æ¬¡ç™»å½•å¥–åŠ±ç§¯åˆ†æ­£ç¡®æ·»åŠ 
- âœ“ å·²ä¿®å¤ï¼šä¿®å¤äº†ç”¨æˆ·è®°å½•åˆ›å»ºé€»è¾‘

### é—®é¢˜2ï¼šæ•°æ®åº“ä¸­çœ‹ä¸åˆ°ç”¨æˆ·ä¿¡æ¯
- âœ“ å·²ä¿®å¤ï¼šç¡®ä¿ç”¨æˆ·è®°å½•æ­£ç¡®åˆ›å»ºå¹¶å¯æŸ¥è¯¢

### é—®é¢˜3ï¼šè´­ä¹°è®¢é˜…å¤±è´¥
- âœ“ å·²ä¿®å¤ï¼šæ·»åŠ äº†å¿…è¦çš„RLSç­–ç•¥ï¼Œå…è®¸åŒ¿åæ’å…¥è®¢é˜…è®°å½•
- âœ“ å·²ä¿®å¤ï¼šæ·»åŠ äº†å¿…è¦çš„RLSç­–ç•¥ï¼Œå…è®¸è®°å½•webhookäº‹ä»¶
- âœ“ å·²ä¿®å¤ï¼šæ·»åŠ äº†å¿…è¦çš„RLSç­–ç•¥ï¼Œå…è®¸è®°å½•ç§¯åˆ†äº¤æ˜“

## ç»“è®º

æ˜¯çš„ï¼Œæ‚¨éœ€è¦çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½å·²å®ç°ï¼Œä¹‹å‰å­˜åœ¨çš„é—®é¢˜ä¹Ÿå·²ä¿®å¤ã€‚ç³»ç»Ÿç°åœ¨åº”è¯¥èƒ½å¤Ÿï¼š

1. æ­£ç¡®ä¸ºé¦–æ¬¡Googleç™»å½•çš„ç”¨æˆ·æ·»åŠ 20ç§¯åˆ†
2. æ¯æ¬¡ç”Ÿæˆå›¾ç‰‡æ¶ˆè€—10ç§¯åˆ†
3. ç§¯åˆ†ä¸º0æ—¶æç¤ºè´­ä¹°
4. å®Œæˆè®¢é˜…è´­ä¹°åæ­£ç¡®æ·»åŠ å¯¹åº”é¢åº¦çš„ç§¯åˆ†

æˆ‘ä»¬çš„ä¿®å¤å·¥ä½œä¸»è¦é›†ä¸­åœ¨è§£å†³RLSç­–ç•¥é—®é¢˜ï¼Œè¿™æ˜¯å¯¼è‡´è®¢é˜…åˆ›å»ºå¤±è´¥çš„æ ¹æœ¬åŸå› ã€‚ç°åœ¨è¿™äº›é—®é¢˜å·²ç»è§£å†³ï¼Œç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚