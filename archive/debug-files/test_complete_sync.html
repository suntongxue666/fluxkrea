<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整同步测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .credits-display {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            text-align: center;
        }
        .user-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 完整同步系统测试</h1>
        
        <div class="status info" id="systemStatus">
            <span>🔄 正在初始化系统...</span>
        </div>
        
        <div class="test-grid">
            <div class="test-section">
                <h3>👤 用户状态</h3>
                <div class="user-info" id="userInfo">
                    <div>用户: <span id="userEmail">未知</span></div>
                    <div>UUID: <span id="userUuid">未知</span></div>
                    <div>状态: <span id="userStatus">未知</span></div>
                </div>
                <button class="btn btn-primary" onclick="simulateLogin()">模拟登录</button>
                <button class="btn btn-success" onclick="checkUserState()">检查用户状态</button>
            </div>
            
            <div class="test-section">
                <h3>💰 积分状态</h3>
                <div class="credits-display">
                    积分: <span id="creditsAmount">0</span>
                </div>
                <button class="btn btn-primary" onclick="syncCredits()">同步积分</button>
                <button class="btn btn-success" onclick="testCrossPageSync()">测试跨页面同步</button>
            </div>
        </div>
        
        <div class="container">
            <h3>🧪 测试结果</h3>
            <div class="log" id="testLog"></div>
        </div>
        
        <div class="container">
            <h3>🔍 存储状态</h3>
            <div class="log" id="storageStatus"></div>
        </div>
    </div>

    <!-- 加载所有同步系统 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="credits_sync.js"></script>
    <script src="user_state_sync.js"></script>
    
    <script>
        let testLog = [];
        
        // Supabase配置
        const supabaseClient = supabase.createClient(
            'https://gdcjvqaqgvcxzufmessy.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkY2p2cWFxZ3ZjeHp1Zm1lc3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMDY2NTEsImV4cCI6MjA2OTc4MjY1MX0.wIblNpUZLgQcCJCVbKfae5n0jtcIshL9asVIit6iUBI'
        );
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logElement = document.getElementById('testLog');
            logElement.innerHTML = testLog.slice(-20).join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function updateStorageStatus() {
            const storageElement = document.getElementById('storageStatus');
            const creditsData = localStorage.getItem('flux_krea_credits');
            const userData = localStorage.getItem('flux_krea_user');
            const lastSync = localStorage.getItem('flux_krea_last_sync');
            
            storageElement.innerHTML = `
LocalStorage 积分数据: ${creditsData || '无'}
LocalStorage 用户数据: ${userData || '无'}
最后同步时间: ${lastSync ? new Date(parseInt(lastSync)).toLocaleString() : '无'}
当前用户标识: ${window.creditsSync ? window.creditsSync.getCurrentUserIdentifier() : '未知'}
            `.trim();
        }
        
        function updateUserInfo() {
            const user = window.userStateSync ? window.userStateSync.getCurrentUser() : null;
            
            document.getElementById('userEmail').textContent = user?.email || '未知';
            document.getElementById('userUuid').textContent = user?.uuid || '未知';
            document.getElementById('userStatus').textContent = user?.subscription_status || '未知';
        }
        
        function updateCreditsDisplay() {
            if (window.creditsSync) {
                const credits = window.creditsSync.getCredits();
                document.getElementById('creditsAmount').textContent = credits;
            }
            updateStorageStatus();
            updateUserInfo();
        }
        
        // 模拟登录测试用户
        function simulateLogin() {
            const testUser = {
                email: 'sunwei7482@gmail.com',
                uuid: 'user_1754255481243_makadnmmc6p',
                credits: 6000,
                subscription_status: 'ACTIVE',
                avatar_url: 'https://via.placeholder.com/32'
            };
            
            log('🔄 模拟用户登录...');
            
            // 设置全局用户状态
            window.currentUser = testUser;
            
            // 使用用户状态同步系统
            if (window.userStateSync) {
                window.userStateSync.setCurrentUser(testUser);
                log('✅ 用户状态已设置');
            }
            
            // 使用积分同步系统
            if (window.creditsSync) {
                window.creditsSync.setCredits(testUser.credits);
                log('✅ 积分已同步');
            }
            
            updateCreditsDisplay();
            log(`✅ 模拟登录成功: ${testUser.email}`);
        }
        
        // 检查用户状态
        function checkUserState() {
            log('🔍 检查用户状态...');
            
            const user = window.userStateSync ? window.userStateSync.getCurrentUser() : null;
            const credits = window.creditsSync ? window.creditsSync.getCredits() : 0;
            
            if (user) {
                log(`👤 用户: ${user.email}`);
                log(`💰 积分: ${credits}`);
                log(`📊 状态: ${user.subscription_status}`);
            } else {
                log('❌ 未找到用户状态');
            }
            
            updateCreditsDisplay();
        }
        
        // 同步积分
        async function syncCredits() {
            if (!window.currentUser || !window.currentUser.uuid) {
                log('❌ 请先登录');
                return;
            }
            
            log('🔄 从数据库同步积分...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('credits, subscription_status')
                    .eq('uuid', window.currentUser.uuid)
                    .single();
                
                if (error) {
                    log(`❌ 同步失败: ${error.message}`);
                    return;
                }
                
                if (data) {
                    const newCredits = data.credits || 0;
                    log(`💰 数据库积分: ${newCredits}`);
                    
                    // 更新积分
                    if (window.creditsSync) {
                        window.creditsSync.setCredits(newCredits);
                    }
                    
                    // 更新用户状态
                    if (window.currentUser) {
                        window.currentUser.credits = newCredits;
                        window.currentUser.subscription_status = data.subscription_status;
                        
                        if (window.userStateSync) {
                            window.userStateSync.setCurrentUser(window.currentUser);
                        }
                    }
                    
                    log(`✅ 积分同步成功: ${newCredits}`);
                    updateCreditsDisplay();
                }
            } catch (error) {
                log(`❌ 同步异常: ${error.message}`);
            }
        }
        
        // 测试跨页面同步
        function testCrossPageSync() {
            log('🧪 测试跨页面同步...');
            
            // 模拟页面跳转后的状态恢复
            const storedUser = localStorage.getItem('flux_krea_user');
            const storedCredits = localStorage.getItem('flux_krea_credits');
            
            if (storedUser) {
                const user = JSON.parse(storedUser);
                log(`✅ 用户状态已保存: ${user.email}`);
            } else {
                log('❌ 用户状态未保存');
            }
            
            if (storedCredits) {
                const credits = JSON.parse(storedCredits);
                log(`✅ 积分状态已保存: ${JSON.stringify(credits)}`);
            } else {
                log('❌ 积分状态未保存');
            }
            
            // 触发跨页面同步事件
            window.dispatchEvent(new CustomEvent('userStateUpdated', {
                detail: { user: window.currentUser, credits: window.currentUser?.credits }
            }));
            
            log('✅ 跨页面同步事件已触发');
            updateCreditsDisplay();
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('systemStatus');
            
            // 检查系统状态
            let systemsReady = 0;
            let totalSystems = 2;
            
            if (window.creditsSync) {
                systemsReady++;
                log('✅ 积分同步系统已加载');
            }
            
            if (window.userStateSync) {
                systemsReady++;
                log('✅ 用户状态同步系统已加载');
                
                // 添加用户状态监听器
                window.userStateSync.addListener((user) => {
                    log(`🔔 用户状态变化: ${user ? user.email : '已登出'}`);
                    updateCreditsDisplay();
                });
            }
            
            if (systemsReady === totalSystems) {
                statusElement.className = 'status success';
                statusElement.innerHTML = '<span>✅ 所有系统已成功初始化</span>';
                log('🚀 系统初始化完成');
            } else {
                statusElement.className = 'status error';
                statusElement.innerHTML = '<span>❌ 系统初始化不完整</span>';
                log(`❌ 只有 ${systemsReady}/${totalSystems} 个系统加载成功`);
            }
            
            updateCreditsDisplay();
        });
        
        // 定期更新状态
        setInterval(updateStorageStatus, 3000);
    </script>
</body>
</html>