# 前端积分显示问题修复指南

如果数据库中已经有积分，但前端页面仍显示0积分，这通常是由于前端缓存或同步问题导致的。以下是解决方案：

## 方法1：清除浏览器缓存

1. 打开开发者工具 (F12)
2. 切换到"应用"或"Application"标签
3. 在左侧找到"存储"或"Storage"下的"本地存储"或"Local Storage"
4. 查找并删除以下键:
   - `flux_krea_credits`
   - `flux_krea_last_sync`
5. 刷新页面

## 方法2：使用修复脚本

在浏览器控制台中执行以下脚本：

```javascript
// 前端积分显示修复脚本

// 清除本地存储中的积分缓存
localStorage.removeItem('flux_krea_credits');
localStorage.removeItem('flux_krea_last_sync');

// 强制重新获取积分
async function forceRefreshCredits() {
    try {
        const response = await fetch('/api/get-user-credits', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        
        const data = await response.json();
        console.log('API响应:', data);
        
        if (data.success) {
            console.log('✅ 积分已更新:', data.credits);
            
            // 更新本地存储
            const userIdentifier = localStorage.getItem('flux_krea_user') || 'default';
            const creditsObj = {};
            creditsObj[userIdentifier] = data.credits;
            localStorage.setItem('flux_krea_credits', JSON.stringify(creditsObj));
            localStorage.setItem('flux_krea_last_sync', Date.now().toString());
            
            // 更新显示
            const creditsElements = document.querySelectorAll('#creditsAmount, .credits-amount');
            creditsElements.forEach(element => {
                if (element) {
                    element.textContent = data.credits;
                }
            });
            
            // 触发自定义事件
            window.dispatchEvent(new CustomEvent('creditsUpdated', {
                detail: { credits: data.credits }
            }));
            
            // 尝试调用全局更新函数
            if (window.creditsSync && typeof window.creditsSync.updateDisplay === 'function') {
                window.creditsSync.updateDisplay();
            }
            
            return data.credits;
        } else {
            console.error('❌ 获取积分失败:', data.error || '未知错误');
            return null;
        }
    } catch (error) {
        console.error('❌ 请求出错:', error);
        return null;
    }
}

// 执行刷新
forceRefreshCredits().then(credits => {
    if (credits !== null) {
        alert('积分已更新: ' + credits);
    } else {
        alert('积分更新失败，请查看控制台获取详细信息');
    }
});
```

## 方法3：运行修复脚本

执行以下命令运行修复脚本：

```bash
node fix-frontend-credits-display.js
```

然后按照脚本输出的指示操作。

## 问题原因分析

前端积分显示为0而数据库中有积分的原因可能是：

1. **本地存储缓存**：前端可能缓存了旧的积分数据在localStorage中
2. **会话问题**：用户会话可能未正确关联到数据库中的用户记录
3. **API响应问题**：`get-user-credits` API可能返回错误的积分数据
4. **前端代码问题**：积分更新逻辑可能存在缺陷

## 长期解决方案

为避免此类问题再次发生，建议：

1. 减少对本地存储的依赖，优先使用服务器数据
2. 实现定期自动同步机制，确保前端数据与后端保持一致
3. 添加调试日志，记录积分变化和同步操作
4. 在用户登录后立即强制同步积分数据