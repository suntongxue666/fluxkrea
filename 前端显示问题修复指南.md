# 前端积分显示问题修复指南

## 问题描述
用户登录后，前端显示的积分余额与数据库中的实际值不一致。这可能是由于以下原因导致的：
1. 前端缓存未更新
2. API调用失败
3. 前端代码中有bug
4. RLS策略问题导致前端无法读取积分值

## 解决方案
我们提供了一个持久性的解决方案，确保用户每次登录后都能看到准确的积分余额。

## 实现步骤

### 1. 添加用户数据刷新功能
将`fix-credits-display-frontend.js`文件添加到你的项目中，这个文件提供了以下功能：
- 获取最新的用户积分
- 登录后刷新用户数据
- 定期刷新用户数据
- 监听认证状态变化

### 2. 在应用入口文件中集成

在你的应用入口文件（如`_app.js`或`App.js`）中添加以下代码：

```javascript
import { useEffect, useState } from 'react';
import { setupAuthListener, setupPeriodicRefresh } from './path/to/fix-credits-display-frontend';

function MyApp({ Component, pageProps }) {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    // 设置认证监听器
    const authUnsubscribe = setupAuthListener(setUser);
    
    // 设置定期刷新
    const refreshCleanup = setupPeriodicRefresh(setUser);
    
    // 组件卸载时清理
    return () => {
      authUnsubscribe();
      refreshCleanup();
    };
  }, []);
  
  return (
    <UserContext.Provider value={{ user, setUser }}>
      <Component {...pageProps} />
    </UserContext.Provider>
  );
}

export default MyApp;
```

### 3. 在组件中使用用户数据

在需要显示积分的组件中：

```javascript
import { useContext } from 'react';
import { UserContext } from './path/to/context';

function CreditsDisplay() {
  const { user } = useContext(UserContext);
  
  return (
    <div>
      <h3>积分余额</h3>
      <p>{user?.credits || 0}</p>
    </div>
  );
}

export default CreditsDisplay;
```

### 4. 确保RLS策略正确

检查Supabase中的RLS策略，确保用户可以读取自己的积分：

```sql
CREATE POLICY "用户可以读取自己的数据" ON public.users
FOR SELECT USING (
  auth.uid() = id OR
  email = auth.email()
);
```

## 测试方法

1. 清除浏览器缓存并重新登录
2. 检查前端显示的积分是否与数据库中的值一致
3. 在另一个窗口中修改用户积分，然后等待自动刷新或手动刷新页面，检查前端显示是否更新

## 常见问题

### 积分仍然显示不正确
- 检查浏览器控制台是否有错误
- 确认RLS策略是否正确设置
- 验证API调用是否成功

### 登录后积分显示为0，然后才更新
- 这是正常的，因为用户数据是异步加载的
- 可以添加加载状态来优化用户体验

### 积分更新有延迟
- 默认刷新间隔是5分钟，可以根据需要调整
- 对于实时性要求高的场景，可以考虑使用Supabase实时订阅功能

## 进阶优化

### 添加实时订阅
使用Supabase的实时功能，订阅用户数据变化：

```javascript
const userSubscription = supabase
  .from(`users:id=eq.${userId}`)
  .on('UPDATE', payload => {
    // 更新用户状态
    setUser(payload.new);
  })
  .subscribe();

// 清理函数
return () => {
  supabase.removeSubscription(userSubscription);
};
```

### 添加错误处理和重试机制
对API调用添加重试机制：

```javascript
async function fetchWithRetry(fn, retries = 3, delay = 1000) {
  try {
    return await fn();
  } catch (error) {
    if (retries <= 0) throw error;
    await new Promise(resolve => setTimeout(resolve, delay));
    return fetchWithRetry(fn, retries - 1, delay * 2);
  }
}
```

### 添加加载状态
在数据加载过程中显示加载状态：

```javascript
function CreditsDisplay() {
  const { user, loading } = useContext(UserContext);
  
  if (loading) return <p>加载中...</p>;
  
  return (
    <div>
      <h3>积分余额</h3>
      <p>{user?.credits || 0}</p>
    </div>
  );
}