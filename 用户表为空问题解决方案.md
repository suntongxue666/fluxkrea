# 用户表为空问题解决方案

## 问题描述

执行查询脚本后发现数据库中没有任何用户记录，包括之前登录的tiktreeapp@gmail.com用户。脚本显示总用户数为0，这与之前的情况不符。

## 可能的原因

1. **数据库连接问题**：脚本可能连接到了错误的数据库或环境
2. **数据库清空**：可能有人清空了数据库中的用户表
3. **权限问题**：脚本可能没有足够的权限查询用户表
4. **触发器失效**：Google登录后的用户创建触发器可能完全失效

## 解决方案

### 1. 验证数据库连接

首先，确认脚本连接的是正确的数据库：

```javascript
console.log('当前连接的数据库URL:', supabaseUrl);
```

### 2. 检查auth.users表

验证auth.users表中是否有用户记录：

```sql
SELECT COUNT(*) FROM auth.users;
```

如果auth.users表中有记录，但public.users表中没有，说明是触发器问题。

### 3. 修复触发器

我已经创建了一个完整的SQL脚本`修复用户创建触发器.sql`，它会：

- 检查并创建必要的表（如果不存在）
- 创建或更新从auth.users到public.users的触发器
- 同步现有的auth.users记录到public.users表

请在Supabase管理界面的SQL编辑器中执行这个脚本。

### 4. 手动创建tiktreeapp@gmail.com用户

如果触发器修复后仍然没有看到用户记录，可以手动创建：

```sql
-- 先查询auth.users表中的用户信息
SELECT * FROM auth.users WHERE email = 'tiktreeapp@gmail.com';

-- 然后手动插入到public.users表
INSERT INTO public.users (
  uuid,
  email,
  name,
  credits,
  subscription_status,
  created_at,
  updated_at
)
VALUES (
  '用户ID', -- 从auth.users查询得到的id
  'tiktreeapp@gmail.com',
  '用户名', -- 从auth.users查询得到的名称
  20,
  'FREE',
  NOW(),
  NOW()
);

-- 创建积分交易记录
INSERT INTO public.credit_transactions (
  user_uuid,
  transaction_type,
  amount,
  balance_after,
  description,
  source
)
VALUES (
  '用户ID', -- 与上面相同的ID
  'EARN',
  20,
  20,
  '首次登录奖励',
  'first_login_bonus'
);
```

## 测试方法

1. 执行修复脚本后，重新运行查询：

```
node 简单查询最近用户.js
```

2. 清除浏览器缓存并重新登录，检查是否能看到正确的积分

## 预防措施

1. 定期备份数据库
2. 添加数据库监控，当用户表为空时发出警报
3. 在应用启动时验证触发器是否存在并正常工作

## 结论

用户表为空可能是由于触发器失效或数据库被清空导致的。通过修复触发器并同步现有用户，可以解决这个问题。如果问题仍然存在，可能需要检查数据库权限或连接配置。